<!DOCTYPE html>
<html lang="en">

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="BillFree TechSupport Operations Management System - Enterprise Grade v9.9">
    <title>BillFree TechSupport Ops v9.9 PRO</title>

    <!-- üîó Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ==========================================
           üè¢ ENTERPRISE CSS v9.9
           WCAG 2.1 AA Compliant
           ========================================== */

        /* üé® SYSTEM VARIABLES */
        :root {
            /* Primary Colors */
            --primary: #4F46E5;
            --primary-light: #EEF2FF;
            --primary-hover: #4338CA;
            --primary-focus: rgba(79, 70, 229, 0.5);

            /* Background Colors */
            --bg-body: #F8FAFC;
            --bg-surface: #FFFFFF;
            --bg-sidebar: #0F172A;

            /* Text Colors (WCAG AA Compliant) */
            --text-main: #1E293B;
            --text-sec: #475569;
            /* Darkened for better contrast */
            --border: #E2E8F0;

            /* Status Colors (WCAG AA Compliant with dark text) */
            --success: #047857;
            --success-bg: #D1FAE5;
            --success-text: #065F46;

            --warning: #B45309;
            --warning-bg: #FEF3C7;
            --warning-text: #92400E;

            --danger: #B91C1C;
            --danger-bg: #FEE2E2;
            --danger-text: #991B1B;

            --info: #1D4ED8;
            --info-bg: #DBEAFE;
            --info-text: #1E40AF;

            --gray: #374151;
            --gray-bg: #F1F5F9;

            /* Age Heatmap Colors */
            --age-fresh: #DCFCE7;
            --age-aging: #FEF3C7;
            --age-old: #FED7AA;
            --age-critical: #FEE2E2;

            /* Layout */
            --radius: 12px;
            --radius-sm: 6px;
            --radius-lg: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);

            /* Animation - Material Design 3 Motion */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.4s ease;

            /* üéØ PREMIUM MICRO-INTERACTION EASING (Material Design 3) */
            --ease-standard: cubic-bezier(0.2, 0, 0, 1);
            --ease-decelerate: cubic-bezier(0, 0, 0, 1);
            --ease-accelerate: cubic-bezier(0.3, 0, 1, 1);
            --ease-emphasized: cubic-bezier(0.2, 0, 0, 1);
            --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);

            /* Premium Timing */
            --duration-instant: 100ms;
            --duration-quick: 200ms;
            --duration-moderate: 300ms;
            --duration-slow: 400ms;
            --duration-complex: 500ms;

            /* Micro-interaction Shadows */
            --shadow-hover: 0 8px 30px -5px rgba(0, 0, 0, 0.15);
            --shadow-active: 0 2px 8px -2px rgba(0, 0, 0, 0.1);
            --shadow-glow: 0 0 20px rgba(79, 70, 229, 0.3);

            /* Focus Ring (Accessibility) */
            --focus-ring-offset: 0 0 0 2px var(--bg-surface), 0 0 0 4px var(--primary);
        }

        /* ==========================================
           üåô DARK MODE SYSTEM v1.0
           Auto-detect + Manual Toggle
           ========================================== */

        /* Dark Mode Variables */
        [data-theme="dark"] {
            /* Background Colors */
            --bg-body: #0F172A;
            --bg-surface: #1E293B;
            --bg-sidebar: #0F172A;

            /* Text Colors */
            --text-main: #F1F5F9;
            --text-sec: #94A3B8;
            --border: #334155;

            /* Primary Colors (slightly adjusted for dark) */
            --primary-light: #312E81;
            --primary-focus: rgba(99, 102, 241, 0.4);

            /* Status Colors (darker backgrounds) */
            --success-bg: #064E3B;
            --success-text: #6EE7B7;
            --warning-bg: #78350F;
            --warning-text: #FCD34D;
            --danger-bg: #7F1D1D;
            --danger-text: #FCA5A5;
            --info-bg: #1E3A8A;
            --info-text: #93C5FD;
            --gray-bg: #1E293B;

            /* Age Heatmap (darker) */
            --age-fresh: #064E3B;
            --age-aging: #78350F;
            --age-old: #7C2D12;
            --age-critical: #7F1D1D;

            /* Shadows (more visible in dark) */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.4), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 8px 30px -5px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 25px rgba(99, 102, 241, 0.4);
        }

        /* System Preference Auto-Detection */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                --bg-body: #0F172A;
                --bg-surface: #1E293B;
                --bg-sidebar: #0F172A;
                --text-main: #F1F5F9;
                --text-sec: #94A3B8;
                --border: #334155;
                --primary-light: #312E81;
                --success-bg: #064E3B;
                --success-text: #6EE7B7;
                --warning-bg: #78350F;
                --warning-text: #FCD34D;
                --danger-bg: #7F1D1D;
                --danger-text: #FCA5A5;
                --info-bg: #1E3A8A;
                --info-text: #93C5FD;
                --gray-bg: #1E293B;
                --age-fresh: #064E3B;
                --age-aging: #78350F;
                --age-old: #7C2D12;
                --age-critical: #7F1D1D;
                --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            }
        }

        /* Theme Transition */
        body,
        .sidebar,
        .main,
        .header,
        .content,
        .kpi-card,
        .agent-card,
        .modal,
        .table-wrapper,
        .btn,
        .pill,
        .badge,
        input,
        select,
        textarea {
            transition: background-color 0.3s ease,
                color 0.3s ease,
                border-color 0.3s ease,
                box-shadow 0.3s ease;
        }

        /* ==========================================
           ‚è≥ LOADING STATES SYSTEM v1.0
           Button spinners, skeletons, progress
           ========================================== */

        /* üîÑ Button Loading State */
        .btn.is-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
            cursor: wait;
        }

        .btn.is-loading::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            top: 50%;
            left: 50%;
            margin-left: -9px;
            margin-top: -9px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-right-color: transparent;
            animation: btn-spin 0.6s linear infinite;
        }

        .btn.is-loading::before {
            content: none;
        }

        /* Primary button loading - white spinner */
        .btn-primary.is-loading::after {
            border-color: rgba(255, 255, 255, 0.3);
            border-right-color: white;
        }

        @keyframes btn-spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* üíÄ Skeleton Loader Components */
        .skeleton {
            background: linear-gradient(90deg,
                    var(--bg-surface) 0%,
                    #E2E8F0 20%,
                    var(--bg-surface) 40%,
                    var(--bg-surface) 100%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
            border-radius: var(--radius-sm);
        }

        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg,
                    var(--bg-surface) 0%,
                    #334155 20%,
                    var(--bg-surface) 40%,
                    var(--bg-surface) 100%);
            background-size: 200% 100%;
        }

        @keyframes skeleton-shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Skeleton variants */
        .skeleton-text {
            height: 16px;
            width: 100%;
            margin-bottom: 8px;
        }

        .skeleton-text.short {
            width: 60%;
        }

        .skeleton-text.medium {
            width: 80%;
        }

        .skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .skeleton-card {
            height: 120px;
            width: 100%;
            border-radius: var(--radius);
        }

        .skeleton-row {
            display: flex;
            gap: 16px;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .skeleton-row .skeleton-text {
            flex: 1;
        }

        /* üìä Table Skeleton */
        .table-skeleton {
            padding: 16px;
        }

        .table-skeleton .skeleton-row:last-child {
            border-bottom: none;
        }

        /* üîµ Inline Progress Indicator */
        .progress-inline {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            font-size: 13px;
            font-weight: 600;
        }

        .progress-inline .spinner-sm {
            width: 14px;
            height: 14px;
            border: 2px solid var(--primary-light);
            border-right-color: var(--primary);
            border-radius: 50%;
            animation: btn-spin 0.6s linear infinite;
        }

        /* ==========================================
           ‚ôø ACCESSIBILITY UTILITIES v1.0
           Focus management, screen reader, reduced motion
           ========================================== */

        /* Screen Reader Only (Visually Hidden) */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus Visible - Enhanced */
        :focus-visible {
            outline: none;
            box-shadow: var(--focus-ring-offset);
        }

        /* Ensure all interactive elements are keyboard accessible */
        [tabindex="0"]:focus-visible,
        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: none;
            box-shadow: var(--focus-ring-offset);
        }

        /* Skip Link (Already exists, enhanced) */
        .skip-link {
            position: absolute;
            top: -100%;
            left: 16px;
            z-index: 10000;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            font-weight: 700;
            text-decoration: none;
            border-radius: var(--radius);
            transition: top 0.3s ease;
        }

        .skip-link:focus {
            top: 16px;
        }

        /* Reduced Motion Preference */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .skeleton {
                animation: none;
                background: var(--gray-bg);
            }
        }

        /* Live Region Styling */
        [aria-live] {
            position: absolute;
            width: 1px;
            height: 1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
        }

        /* Focus Trap Container */
        .focus-trap-container {
            position: relative;
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {

            .btn,
            .badge,
            .pill {
                border: 2px solid currentColor;
            }

            :focus-visible {
                outline: 3px solid currentColor;
                outline-offset: 2px;
            }
        }

        /* Theme Toggle Button */
        .theme-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #334155 0%, #1E293B 100%);
            border: 1px solid #475569;
            border-radius: 10px;
            color: #E2E8F0;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .theme-toggle:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .theme-toggle:active {
            transform: translateY(0);
        }

        .theme-toggle .moon-icon {
            transition: all 0.4s ease;
        }

        .theme-toggle .sun-icon {
            position: absolute;
            opacity: 0;
            transform: rotate(-90deg) scale(0);
            transition: all 0.4s ease;
        }

        /* Dark mode: show sun, hide moon */
        [data-theme="dark"] .theme-toggle .moon-icon {
            opacity: 0;
            transform: rotate(90deg) scale(0);
        }

        [data-theme="dark"] .theme-toggle .sun-icon {
            opacity: 1;
            position: relative;
            transform: rotate(0) scale(1);
        }

        [data-theme="dark"] .theme-toggle {
            background: linear-gradient(135deg, #4338CA 0%, #312E81 100%);
            border-color: #6366F1;
        }

        /* Dark Mode Component Overrides */
        [data-theme="dark"] .sidebar {
            background: linear-gradient(180deg, #1E293B 0%, #0F172A 100%);
            border-right-color: #334155;
        }

        [data-theme="dark"] .nav-item {
            color: #CBD5E1;
        }

        [data-theme="dark"] .nav-item:hover {
            background: rgba(99, 102, 241, 0.15);
            color: #F1F5F9;
        }

        [data-theme="dark"] .nav-item.active {
            background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);
            color: white;
        }

        [data-theme="dark"] .header {
            background: #1E293B;
            border-bottom-color: #334155;
        }

        [data-theme="dark"] .filter-bar {
            background: #1E293B;
            border-bottom-color: #334155;
        }

        [data-theme="dark"] .kpi-card {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .agent-card {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .table-wrapper {
            background: #1E293B;
        }

        [data-theme="dark"] table thead {
            background: #0F172A;
        }

        [data-theme="dark"] table tbody tr {
            border-bottom-color: #334155;
        }

        [data-theme="dark"] table tbody tr:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        [data-theme="dark"] .modal {
            background: #1E293B;
        }

        [data-theme="dark"] .modal-header {
            background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
            border-bottom-color: #334155;
        }

        [data-theme="dark"] .modal-footer {
            border-top-color: #334155;
            background: #0F172A;
        }

        [data-theme="dark"] .modal-input {
            background: #0F172A;
            border-color: #334155;
            color: #F1F5F9;
        }

        [data-theme="dark"] .modal-input:focus {
            border-color: #6366F1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        [data-theme="dark"] .btn {
            background: #334155;
            border-color: #475569;
            color: #E2E8F0;
        }

        [data-theme="dark"] .btn:hover {
            background: #475569;
        }

        [data-theme="dark"] .pill {
            background: #334155;
            border-color: #475569;
            color: #CBD5E1;
        }

        [data-theme="dark"] .pill.active,
        [data-theme="dark"] .pill:hover {
            background: #4F46E5;
            border-color: #6366F1;
            color: white;
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: #1E293B;
        }

        /* Dark mode mobile ticket cards */
        [data-theme="dark"] .mobile-ticket-card {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .mobile-ticket-header {
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
            border-bottom-color: #334155;
        }

        [data-theme="dark"] .mobile-ticket-status {
            background: #0F172A;
            border-top-color: #334155;
        }

        [data-theme="dark"] .mobile-ticket-reason {
            background: #0F172A;
        }

        [data-theme="dark"] .mobile-stats-bar {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .mobile-search-input {
            background: #0F172A;
            border-color: #334155;
            color: #F1F5F9;
        }

        /* ==========================================
           üîê ACCESSIBILITY: Enhanced Focus & Contrast
           WCAG 2.1 AA Compliant
           ========================================== */

        /* Focus Ring for Keyboard Navigation - Enhanced */
        *:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 3px;
            box-shadow: 0 0 0 6px var(--primary-focus);
        }

        /* Remove outline for mouse users */
        *:focus:not(:focus-visible) {
            outline: none;
            box-shadow: none;
        }

        /* Button-specific focus styles */
        .btn:focus-visible,
        .pill:focus-visible,
        .nav-item:focus-visible,
        .action-btn:focus-visible,
        .mobile-btn:focus-visible,
        .mobile-action-btn:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
            box-shadow: 0 0 0 5px var(--primary-focus);
            transform: translateY(-1px);
        }

        /* KPI Card focus */
        .kpi-card:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 4px;
            transform: scale(1.02);
        }

        /* Input focus enhancement */
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 1px;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 4px var(--primary-focus) !important;
        }

        /* Skip to Main Content Link (Accessibility) */
        .skip-link {
            position: absolute;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius);
            z-index: 10000;
            font-weight: 700;
            text-decoration: none;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 10px;
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            :root {
                --text-sec: #1E293B;
                --border: #000000;
            }

            *:focus-visible {
                outline-width: 4px !important;
            }

            .btn,
            .pill,
            .badge {
                border-width: 2px !important;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 3px;
        }

        /* ==========================================
           üß≠ MODERN SIDEBAR NAVIGATION v2.0
           Expert-level Visual Hierarchy & Patterns
           ========================================== */

        /* SIDEBAR - Elevated Glass Design */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #FFFFFF 0%, #F8FAFC 100%);
            color: #1E293B;
            display: flex;
            flex-direction: column;
            padding: 0;
            z-index: 50;
            flex-shrink: 0;
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.08);
            border-right: 1px solid rgba(226, 232, 240, 0.8);
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Brand Section - Premium Header */
        .sidebar-header {
            padding: 24px 20px 20px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .brand {
            font-size: 17px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
            letter-spacing: -0.3px;
        }

        .brand i {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 24px;
            animation: brandPulse 3s ease-in-out infinite;
        }

        @keyframes brandPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .brand-subtitle {
            font-size: 11px;
            color: #64748B;
            margin-top: 6px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .brand-subtitle .status-dot {
            width: 8px;
            height: 8px;
            background: #10B981;
            border-radius: 50%;
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            50% {
                opacity: 0.8;
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }
        }

        /* Navigation Container */
        .nav-container {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
        }

        /* Section Labels - Enhanced with Icons */
        .nav-section {
            margin-bottom: 8px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: #94A3B8;
            margin: 20px 0 10px 14px;
            letter-spacing: 1.2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-label:first-child {
            margin-top: 0;
        }

        .nav-label-icon {
            font-size: 10px;
            opacity: 0.6;
        }

        .nav-label-badge {
            margin-left: auto;
            margin-right: 14px;
            background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
            color: #4F46E5;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            letter-spacing: 0;
        }

        /* Nav Items - Premium Interactive Design */
        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            margin: 4px 0;
            color: #475569;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s var(--ease-standard);
            font-weight: 500;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            border: 1px solid transparent;
        }

        /* Ripple Effect Layer */
        .nav-item::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at var(--ripple-x, 50%) var(--ripple-y, 50%),
                    rgba(102, 126, 234, 0.15) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }

        .nav-item:hover::after {
            opacity: 1;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.05) 100%);
            color: #1E293B;
            border-color: rgba(102, 126, 234, 0.15);
            transform: translateX(4px);
        }

        .nav-item:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }

        /* Active State - Premium Indicator */
        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateX(0);
            border-color: transparent;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 60%;
            width: 4px;
            background: white;
            border-radius: 0 4px 4px 0;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            animation: indicatorGlow 2s ease-in-out infinite;
        }

        @keyframes indicatorGlow {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Nav Item Icons - Animated */
        .nav-item i {
            font-size: 18px;
            width: 24px;
            text-align: center;
            color: #667eea;
            transition: all 0.3s var(--ease-spring);
        }

        .nav-item:hover i {
            transform: scale(1.15);
            color: #4F46E5;
        }

        .nav-item.active i {
            color: white;
            transform: scale(1);
        }

        /* Nav Item Text */
        .nav-item-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Notification Badge on Nav Items */
        .nav-badge {
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            border-radius: 10px;
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            animation: badgePop 0.3s var(--ease-bounce);
        }

        @keyframes badgePop {
            0% {
                transform: scale(0);
            }

            100% {
                transform: scale(1);
            }
        }

        .nav-badge.warning {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .nav-badge.success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        /* Sidebar Footer */
        .sidebar-footer {
            padding: 16px 12px;
            border-top: 1px solid rgba(226, 232, 240, 0.6);
            background: linear-gradient(180deg, transparent 0%, rgba(248, 250, 252, 0.8) 100%);
        }

        /* User Profile Section (optional) */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            background: rgba(102, 126, 234, 0.05);
            margin-bottom: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 700;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: #1E293B;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 11px;
            color: #64748B;
        }

        /* Stagger Animation on Load */
        .nav-item {
            opacity: 0;
            animation: navItemSlideIn 0.4s var(--ease-decelerate) forwards;
        }

        .nav-item:nth-child(1) {
            animation-delay: 0.05s;
        }

        .nav-item:nth-child(2) {
            animation-delay: 0.1s;
        }

        .nav-item:nth-child(3) {
            animation-delay: 0.15s;
        }

        .nav-item:nth-child(4) {
            animation-delay: 0.2s;
        }

        .nav-item:nth-child(5) {
            animation-delay: 0.25s;
        }

        .nav-item:nth-child(6) {
            animation-delay: 0.3s;
        }

        @keyframes navItemSlideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Quick Search in Sidebar */
        .sidebar-search {
            margin: 0 12px 16px;
            position: relative;
        }

        .sidebar-search input {
            width: 100%;
            padding: 10px 14px 10px 38px;
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            font-size: 13px;
            background: #F8FAFC;
            color: #1E293B;
            transition: all 0.2s ease;
        }

        .sidebar-search input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .sidebar-search input::placeholder {
            color: #94A3B8;
        }

        .sidebar-search i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94A3B8;
            font-size: 14px;
        }

        /* Dark Mode Sidebar Overrides */
        [data-theme="dark"] .sidebar {
            background: linear-gradient(180deg, #1E293B 0%, #0F172A 100%);
            border-right-color: #334155;
        }

        [data-theme="dark"] .sidebar-header {
            border-bottom-color: #334155;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        [data-theme="dark"] .brand-subtitle {
            color: #94A3B8;
        }

        [data-theme="dark"] .nav-label {
            color: #64748B;
        }

        [data-theme="dark"] .nav-label-badge {
            background: linear-gradient(135deg, #312E81 0%, #3730A3 100%);
            color: #A5B4FC;
        }

        [data-theme="dark"] .nav-item {
            color: #CBD5E1;
        }

        [data-theme="dark"] .nav-item:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
            color: #F1F5F9;
            border-color: rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] .nav-item i {
            color: #818CF8;
        }

        [data-theme="dark"] .nav-item:hover i {
            color: #A5B4FC;
        }

        [data-theme="dark"] .nav-item.active {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
        }

        [data-theme="dark"] .sidebar-footer {
            border-top-color: #334155;
        }

        [data-theme="dark"] .user-profile {
            background: rgba(99, 102, 241, 0.1);
        }

        [data-theme="dark"] .user-name {
            color: #F1F5F9;
        }

        [data-theme="dark"] .sidebar-search input {
            background: #0F172A;
            border-color: #334155;
            color: #F1F5F9;
        }

        [data-theme="dark"] .sidebar-search input:focus {
            border-color: #6366F1;
            background: #1E293B;
        }

        /* MAIN */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* HEADER */
        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 40;
        }

        .page-title h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: white;
            color: var(--text-main);
            transition: 0.2s;
        }

        .btn:hover {
            background: var(--bg-body);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }

        .btn-primary:hover {
            background: #4338CA;
        }

        /* FILTERS */
        .filter-bar {
            padding: 16px 32px;
            background: white;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            z-index: 30;
        }

        .pill {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-sec);
            background: var(--bg-body);
            border: 1px solid transparent;
            cursor: pointer;
            transition: 0.2s;
        }

        .pill.active {
            background: var(--text-main);
            color: white;
        }

        .custom-range {
            display: none;
            gap: 8px;
            align-items: center;
            margin-left: 10px;
            border-left: 1px solid var(--border);
            padding-left: 10px;
        }

        .custom-range.show {
            display: flex;
        }

        /* CONTENT */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 24px 32px 60px;
            scroll-behavior: smooth;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: var(--bg-surface);
            padding: 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: 0.2s;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .kpi-card.active {
            transform: scale(1.02);
            ring: 2px solid var(--primary);
        }

        .kpi-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .kpi-label {
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        .kpi-icon {
            font-size: 20px;
            opacity: 0.8;
        }

        .kpi-val {
            font-size: 36px;
            font-weight: 800;
            line-height: 1;
        }

        .card-total {
            border-left: 5px solid var(--primary);
            background: linear-gradient(to right, #EEF2FF, #FFFFFF);
        }

        .card-total .kpi-val {
            color: var(--primary);
        }

        .card-total .kpi-icon {
            color: var(--primary);
        }

        .card-comp {
            border-left: 5px solid var(--success);
            background: linear-gradient(to right, #ECFDF5, #FFFFFF);
        }

        .card-comp .kpi-val {
            color: #059669;
        }

        .card-comp .kpi-icon {
            color: #059669;
        }

        .card-pend {
            border-left: 5px solid var(--warning);
            background: linear-gradient(to right, #FFFBEB, #FFFFFF);
        }

        .card-pend .kpi-val {
            color: #D97706;
        }

        .card-pend .kpi-icon {
            color: #D97706;
        }

        .card-closed {
            border-left: 5px solid var(--gray);
            background: linear-gradient(to right, #F1F5F9, #FFFFFF);
        }

        .card-closed .kpi-val {
            color: #475569;
        }

        .card-closed .kpi-icon {
            color: #475569;
        }

        .card-cant {
            border-left: 5px solid var(--danger);
            background: linear-gradient(to right, #FEF2F2, #FFFFFF);
        }

        .card-cant .kpi-val {
            color: #DC2626;
        }

        .card-cant .kpi-icon {
            color: #DC2626;
        }

        /* AGENT CARDS */
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .agent-card {
            background: white;
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        .agent-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        .agent-card.top-performer {
            border: 2px solid var(--warning);
            background: linear-gradient(to bottom right, #FFFCF5, #FFFFFF);
        }

        .crown-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--warning);
            color: white;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            padding: 4px 12px;
            border-bottom-left-radius: 12px;
            display: none;
        }

        .top-performer .crown-badge {
            display: block;
        }

        .ac-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .ac-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ac-medal {
            font-size: 28px;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
        }

        .ac-name {
            font-weight: 800;
            font-size: 18px;
            color: var(--text-main);
        }

        .ac-rate {
            font-size: 13px;
            font-weight: 700;
            color: var(--success);
            background: var(--success-bg);
            padding: 4px 10px;
            border-radius: 20px;
        }

        .ac-stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .stat-btn {
            text-align: center;
            padding: 10px 4px;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .stat-btn:hover {
            transform: scale(1.05);
            filter: brightness(0.95);
        }

        .sb-total {
            background: #F1F5F9;
            color: #1E293B;
        }

        .sb-done {
            background: #DCFCE7;
            color: #059669;
        }

        .sb-pend {
            background: #FEF3C7;
            color: #D97706;
        }

        .sb-closed {
            background: #F3F4F6;
            color: #475569;
        }

        .sb-cant {
            background: #FEE2E2;
            color: #DC2626;
        }

        .sb-invalid {
            background: #FEE2E2;
            color: #DC2626;
            border: 2px solid #DC2626;
        }

        .sb-val {
            font-size: 18px;
            font-weight: 800;
            display: block;
            line-height: 1.2;
        }

        .sb-lbl {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            opacity: 0.9;
            margin-top: 4px;
        }

        /* SCORE DISPLAY */
        .ac-score-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 12px;
            background: linear-gradient(135deg, #F8FAFC, #EEF2FF);
            border-radius: 12px;
            margin-top: 16px;
            border: 1px solid var(--border);
        }

        .score-box {
            text-align: center;
        }

        .score-val {
            font-size: 24px;
            font-weight: 800;
            line-height: 1;
            display: block;
        }

        .score-lbl {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-sec);
            margin-top: 4px;
        }

        .score-positive {
            color: var(--success);
        }

        .score-negative {
            color: var(--danger);
        }

        .score-neutral {
            color: var(--gray);
        }

        /* PEER COMPARISON BAR */
        .peer-compare {
            margin-top: 12px;
            padding: 10px;
            background: #F8FAFC;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .peer-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-sec);
            margin-bottom: 6px;
        }

        .peer-bar-bg {
            height: 8px;
            background: #E2E8F0;
            border-radius: 10px;
            position: relative;
            overflow: visible;
        }

        .peer-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s;
        }

        .peer-avg-line {
            position: absolute;
            top: -2px;
            height: 12px;
            width: 2px;
            background: var(--danger);
        }

        .peer-avg-line::after {
            content: 'Team Avg';
            position: absolute;
            top: -18px;
            left: -20px;
            font-size: 8px;
            font-weight: 700;
            color: var(--danger);
            white-space: nowrap;
        }

        /* TEAM DEEP DIVE */
        .full-agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
        }

        .report-card {
            background: white;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            overflow: hidden;
            transition: transform 0.2s;
        }

        .rep-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, #F8FAFC, #FFFFFF);
        }

        .rank-1 .rep-header {
            background: linear-gradient(to right, #FFF7ED, #FFFFFF);
            border-top: 4px solid var(--warning);
        }

        .rank-2 .rep-header {
            background: linear-gradient(to right, #F1F5F9, #FFFFFF);
            border-top: 4px solid #94A3B8;
        }

        .rank-3 .rep-header {
            background: linear-gradient(to right, #FFFBEB, #FFFFFF);
            border-top: 4px solid #D97706;
        }

        .rep-info h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 800;
            color: var(--text-main);
        }

        .rep-info p {
            margin: 2px 0 0;
            font-size: 12px;
            color: var(--text-sec);
            font-weight: 600;
        }

        .rep-score-box {
            text-align: right;
        }

        .rep-score-val {
            font-size: 28px;
            font-weight: 800;
            display: block;
            line-height: 1;
        }

        .rep-score-lbl {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-sec);
            margin-top: 4px;
        }

        .rep-body {
            padding: 24px;
        }

        .rep-stats-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 24px;
        }

        .s-box {
            text-align: center;
            padding: 12px 4px;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .s-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        /* Load Bar */
        .load-bar-wrap {
            margin-bottom: 24px;
        }

        .load-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-sec);
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .load-bg {
            height: 10px;
            background: #F1F5F9;
            border-radius: 20px;
            overflow: hidden;
        }

        .load-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 20px;
        }

        /* Visual Lists */
        .lists-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding-top: 10px;
        }

        .lg-title {
            font-size: 11px;
            font-weight: 800;
            color: var(--text-sec);
            text-transform: uppercase;
            margin-bottom: 12px;
            display: block;
        }

        .bar-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-main);
        }

        .bar-name {
            width: 40%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bar-visual {
            flex: 1;
            height: 6px;
            background: #F1F5F9;
            border-radius: 10px;
            margin: 0 10px;
            overflow: hidden;
        }

        .bar-in {
            height: 100%;
            border-radius: 10px;
        }

        .bar-count {
            width: 30px;
            text-align: right;
            font-weight: 700;
            color: var(--text-sec);
        }

        /* TABLE */
        .table-wrapper {
            background: var(--bg-surface);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-top: 10px;
        }

        .table-head-bar {
            padding: 16px 24px;
            background: #F8FAFC;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px 24px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-sec);
            text-transform: uppercase;
            background: #F8FAFC;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 14px 24px;
            font-size: 13px;
            color: var(--text-main);
            border-bottom: 1px solid var(--bg-body);
        }

        tr:hover {
            background: #F8FAFC;
        }

        /* AGE HEATMAP IN TABLE */
        tr.age-fresh {
            background: var(--age-fresh) !important;
        }

        tr.age-aging {
            background: var(--age-aging) !important;
        }

        tr.age-old {
            background: var(--age-old) !important;
        }

        tr.age-critical {
            background: var(--age-critical) !important;
            animation: pulse-row 2s infinite;
        }

        @keyframes pulse-row {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.85;
            }
        }

        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .s-done {
            background: var(--success-bg);
            color: var(--success);
        }

        .s-pend {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .s-closed {
            background: #F3F4F6;
            color: #4B5563;
        }

        .s-cant {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .s-invalid {
            background: var(--danger);
            color: white;
            font-weight: 800;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* ACTION BUTTONS */
        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            transition: 0.2s;
            margin: 0 2px;
        }

        .action-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        .action-btn-update {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .action-btn-update:hover {
            background: #4338CA;
        }

        /* REASON DOCUMENTATION LEVEL BADGES */
        .reason-quality {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 6px;
        }

        .rq-none {
            display: none;
        }

        .rq-minimal {
            background: #FEF3C7;
            color: #D97706;
        }

        /* Orange - Very short */
        .rq-brief {
            background: #DBEAFE;
            color: #2563EB;
        }

        /* Blue - Basic explanation */
        .rq-detailed {
            background: #D1FAE5;
            color: #059669;
        }

        /* Green - Well documented */

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.2s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, #F8FAFC, #FFFFFF);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
        }

        .modal-close {
            cursor: pointer;
            font-size: 28px;
            color: var(--text-sec);
            line-height: 1;
            transition: 0.2s;
        }

        .modal-close:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-sec);
            margin-bottom: 8px;
            display: block;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            transition: 0.2s;
        }

        .modal-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .modal-footer {
            padding: 16px 24px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            border-top: 1px solid var(--border);
            background: #F8FAFC;
        }

        .ticket-info {
            background: linear-gradient(135deg, #EEF2FF, #F8FAFC);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            border-left: 4px solid var(--primary);
        }

        .ticket-info strong {
            color: var(--text-main);
            font-weight: 700;
        }

        /* ANALYTICS */
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-box {
            background: white;
            padding: 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            height: 350px;
            position: relative;
        }

        /* üîê ACCESSIBILITY: Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* LOADING SPINNER (Enhanced) */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.85);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 56px;
            height: 56px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-overlay .loading-text {
            color: white;
            font-size: 14px;
            font-weight: 600;
            margin-top: 16px;
            opacity: 0.9;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* üìä CHART SKELETON LOADER */
        .chart-skeleton {
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%;
            padding: 16px;
        }

        .chart-skeleton-bar {
            height: 24px;
            background: linear-gradient(90deg, #E2E8F0 25%, #F1F5F9 50%, #E2E8F0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .chart-skeleton-bar:nth-child(1) {
            width: 90%;
        }

        .chart-skeleton-bar:nth-child(2) {
            width: 75%;
        }

        .chart-skeleton-bar:nth-child(3) {
            width: 85%;
        }

        .chart-skeleton-bar:nth-child(4) {
            width: 60%;
        }

        .chart-skeleton-bar:nth-child(5) {
            width: 80%;
        }


        /* ==========================================
           üîÑ VIEW TRANSITIONS API v1.0
           Smooth Page/Tab Switching with Animations
           ========================================== */

        /* Enable View Transitions API */
        @view-transition {
            navigation: auto;
        }

        /* Default View Transition Animations */
        ::view-transition-old(root) {
            animation: fadeSlideOut 250ms var(--ease-accelerate) forwards;
        }

        ::view-transition-new(root) {
            animation: fadeSlideIn 300ms var(--ease-decelerate) forwards;
        }

        /* Custom View Transitions for Content Areas */
        [id^="view-"] {
            view-transition-name: view-content;
        }

        ::view-transition-old(view-content) {
            animation: viewSlideOutLeft 250ms var(--ease-accelerate) forwards;
        }

        ::view-transition-new(view-content) {
            animation: viewSlideInRight 300ms var(--ease-decelerate) forwards;
        }

        /* Sidebar stays stable during transitions */
        .sidebar {
            view-transition-name: sidebar;
        }

        ::view-transition-old(sidebar),
        ::view-transition-new(sidebar) {
            animation: none;
            mix-blend-mode: normal;
        }

        /* Header stays stable */
        .header {
            view-transition-name: header;
        }

        ::view-transition-old(header),
        ::view-transition-new(header) {
            animation: none;
        }

        /* View Transition Keyframes */
        @keyframes fadeSlideOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes viewSlideOutLeft {
            from {
                opacity: 1;
                transform: translateX(0) scale(1);
            }

            to {
                opacity: 0;
                transform: translateX(-20px) scale(0.98);
            }
        }

        @keyframes viewSlideInRight {
            from {
                opacity: 0;
                transform: translateX(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        /* Reduced motion preference support */
        @media (prefers-reduced-motion: reduce) {

            ::view-transition-old(root),
            ::view-transition-new(root),
            ::view-transition-old(view-content),
            ::view-transition-new(view-content) {
                animation-duration: 0.01ms !important;
            }
        }

        /* Fallback smooth transitions for unsupported browsers */
        @supports not (view-transition-name: test) {
            [id^="view-"] {
                transition: opacity var(--duration-moderate) var(--ease-emphasized),
                    transform var(--duration-moderate) var(--ease-emphasized);
            }

            [id^="view-"].hidden {
                opacity: 0;
                transform: translateY(10px);
                pointer-events: none;
            }

            [id^="view-"]:not(.hidden) {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ==========================================
           üéØ PREMIUM MICRO-INTERACTIONS v2.0
           Material Design 3 Compliant
           ========================================== */

        /* üåä RIPPLE EFFECT */
        .ripple {
            position: relative;
            overflow: hidden;
        }

        .ripple::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 50%;
            left: 50%;
            pointer-events: none;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, transparent 60%);
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            transition: transform 0.5s var(--ease-decelerate), opacity 0.4s ease;
        }

        .ripple:active::after {
            transform: translate(-50%, -50%) scale(4);
            opacity: 1;
            transition: transform 0s, opacity 0s;
        }

        /* üîò ENHANCED BUTTON MICRO-INTERACTIONS */
        .btn {
            position: relative;
            overflow: hidden;
            transition: all var(--duration-quick) var(--ease-standard);
            transform-origin: center;
            will-change: transform, box-shadow;
        }

        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, transparent 100%);
            opacity: 0;
            transition: opacity var(--duration-instant);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: var(--shadow-active);
            transition-duration: var(--duration-instant);
        }

        .btn-primary:hover {
            box-shadow: var(--shadow-glow), var(--shadow-hover);
        }

        /* Button loading state */
        .btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .btn.loading::after {
            content: '';
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-left: 8px;
        }

        /* üìä KPI CARD PREMIUM INTERACTIONS */
        .kpi-card {
            transition: all var(--duration-moderate) var(--ease-emphasized);
            will-change: transform, box-shadow;
        }

        .kpi-card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: var(--shadow-hover);
        }

        .kpi-card:active {
            transform: translateY(-2px) scale(0.99);
            transition-duration: var(--duration-instant);
        }

        .kpi-card.active {
            transform: scale(1.02);
            box-shadow: var(--shadow-glow), var(--shadow-lg);
            border-color: var(--primary);
        }

        /* KPI Value counting animation */
        .kpi-val {
            transition: all var(--duration-moderate) var(--ease-decelerate);
        }

        .kpi-val.counting {
            animation: countPulse 0.3s var(--ease-bounce);
        }

        @keyframes countPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* üé¥ AGENT CARD PREMIUM EFFECTS */
        .agent-card {
            transition: all var(--duration-moderate) var(--ease-emphasized);
            will-change: transform, box-shadow;
        }

        .agent-card:hover {
            transform: translateY(-5px) rotateX(2deg);
            box-shadow: 0 15px 40px -10px rgba(0, 0, 0, 0.12);
        }

        .agent-card:hover .ac-medal {
            animation: medalBounce 0.5s var(--ease-bounce);
        }

        @keyframes medalBounce {

            0%,
            100% {
                transform: scale(1) rotate(0deg);
            }

            25% {
                transform: scale(1.2) rotate(-10deg);
            }

            50% {
                transform: scale(1.1) rotate(5deg);
            }

            75% {
                transform: scale(1.15) rotate(-5deg);
            }
        }

        /* Stat button premium hover */
        .stat-btn {
            transition: all var(--duration-quick) var(--ease-spring);
        }

        .stat-btn:hover {
            transform: scale(1.08) translateY(-3px);
            box-shadow: 0 6px 20px -5px rgba(0, 0, 0, 0.15);
        }

        .stat-btn:active {
            transform: scale(1.02) translateY(-1px);
        }

        /* üíä PILL BUTTON SMOOTH TRANSITIONS */
        .pill {
            transition: all var(--duration-quick) var(--ease-standard);
            transform-origin: center;
        }

        .pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px -4px rgba(0, 0, 0, 0.15);
        }

        .pill:active {
            transform: scale(0.96);
        }

        .pill.active {
            animation: pillActivate 0.3s var(--ease-bounce);
        }

        @keyframes pillActivate {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.08);
            }

            100% {
                transform: scale(1);
            }
        }

        /* üéØ ACTION BUTTON ENHANCEMENTS */
        .action-btn {
            transition: all var(--duration-quick) var(--ease-standard);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: currentColor;
            opacity: 0;
            transition: opacity var(--duration-instant);
        }

        .action-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 15px -3px var(--primary-focus);
        }

        .action-btn:active {
            transform: scale(0.96);
        }

        /* üèÜ MODAL PREMIUM ANIMATIONS */
        .modal {
            animation: modalEnter var(--duration-moderate) var(--ease-decelerate);
            transform-origin: center center;
        }

        @keyframes modalEnter {
            0% {
                opacity: 0;
                transform: scale(0.92) translateY(20px);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-overlay {
            transition: opacity var(--duration-quick) ease;
        }

        .modal-close {
            transition: all var(--duration-quick) var(--ease-spring);
        }

        .modal-close:hover {
            transform: rotate(90deg) scale(1.1);
            color: var(--danger);
        }

        /* üìã TABLE ROW SMOOTH HOVER */
        tr {
            transition: background-color var(--duration-quick) ease;
        }

        tbody tr:hover {
            background: rgba(79, 70, 229, 0.04) !important;
        }

        /* Staggered row entrance animation */
        tbody tr {
            animation: rowFadeIn var(--duration-moderate) var(--ease-decelerate) backwards;
        }

        tbody tr:nth-child(1) {
            animation-delay: 0ms;
        }

        tbody tr:nth-child(2) {
            animation-delay: 30ms;
        }

        tbody tr:nth-child(3) {
            animation-delay: 60ms;
        }

        tbody tr:nth-child(4) {
            animation-delay: 90ms;
        }

        tbody tr:nth-child(5) {
            animation-delay: 120ms;
        }

        tbody tr:nth-child(n+6) {
            animation-delay: 150ms;
        }

        @keyframes rowFadeIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
        }

        /* üîî BADGE MICRO-INTERACTIONS */
        .badge {
            transition: all var(--duration-quick) var(--ease-standard);
        }

        .badge:hover {
            transform: scale(1.05);
        }

        /* Critical badge pulse */
        .s-invalid {
            animation: dangerPulse 1.5s ease-in-out infinite;
        }

        @keyframes dangerPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(220, 38, 38, 0);
            }
        }

        /* üìä STAGGERED KPI CARDS ENTRANCE */
        .kpi-card {
            animation: cardFadeUp var(--duration-slow) var(--ease-decelerate) backwards;
        }

        .kpi-grid .kpi-card:nth-child(1) {
            animation-delay: 0ms;
        }

        .kpi-grid .kpi-card:nth-child(2) {
            animation-delay: 80ms;
        }

        .kpi-grid .kpi-card:nth-child(3) {
            animation-delay: 160ms;
        }

        .kpi-grid .kpi-card:nth-child(4) {
            animation-delay: 240ms;
        }

        .kpi-grid .kpi-card:nth-child(5) {
            animation-delay: 320ms;
        }

        @keyframes cardFadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        /* üé® STAGGERED AGENT CARDS */
        .agent-card {
            animation: cardSlideIn var(--duration-slow) var(--ease-decelerate) backwards;
        }

        .agent-grid .agent-card:nth-child(1) {
            animation-delay: 50ms;
        }

        .agent-grid .agent-card:nth-child(2) {
            animation-delay: 150ms;
        }

        .agent-grid .agent-card:nth-child(3) {
            animation-delay: 250ms;
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
        }

        /* üåü NAV ITEM PREMIUM TRANSITIONS */
        .nav-item {
            transition: all var(--duration-quick) var(--ease-standard);
            position: relative;
        }

        .nav-item::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 3px;
            height: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 0 3px 3px 0;
            transform: translateY(-50%);
            transition: height var(--duration-quick) var(--ease-spring);
        }

        .nav-item:hover::after {
            height: 60%;
        }

        .nav-item.active::after {
            height: 80%;
            background: white;
        }

        /* ‚ú® INPUT FIELD FOCUS GLOW */
        .modal-input,
        input[type="text"],
        input[type="email"],
        input[type="date"],
        select,
        textarea {
            transition: all var(--duration-quick) var(--ease-standard);
        }

        .modal-input:focus,
        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
            box-shadow: var(--shadow-glow);
            transform: translateY(-1px);
        }

        /* üîÑ LOADING SPINNER PREMIUM */
        .loading-spinner {
            animation: premiumSpin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }

        @keyframes premiumSpin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-overlay {
            animation: overlayFadeIn var(--duration-quick) ease;
        }

        @keyframes overlayFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0);
            }

            to {
                opacity: 1;
                backdrop-filter: blur(4px);
            }
        }

        /* üìà PROGRESS BAR SMOOTH FILL */
        .load-fill,
        .peer-bar-fill,
        .bar-in {
            transition: width var(--duration-slow) var(--ease-decelerate);
        }

        /* üé™ TOAST NOTIFICATION ANIMATIONS */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* üéØ SCROLL INDICATOR */
        .content {
            scroll-behavior: smooth;
        }

        .content::-webkit-scrollbar-thumb {
            transition: background var(--duration-quick);
        }

        .content::-webkit-scrollbar-thumb:hover {
            background: #94A3B8;
        }

        /* üèÖ TOP PERFORMER SHINE EFFECT */
        .top-performer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.3),
                    transparent);
            animation: shine 3s ease-in-out infinite;
        }

        @keyframes shine {

            0%,
            100% {
                left: -100%;
            }

            50% {
                left: 100%;
            }
        }

        /* üîÆ GLASSMORPHISM HOVER EFFECTS */
        .header {
            transition: background var(--duration-quick),
                backdrop-filter var(--duration-moderate);
        }

        /* üé® CHART BOX ENTRANCE */
        .chart-box {
            animation: chartFadeIn var(--duration-slow) var(--ease-decelerate) backwards;
        }

        @keyframes chartFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
        }


        /* UTILS */
        .hidden {
            display: none !important;
        }

        #loader {
            position: fixed;
            inset: 0;
            background: #0F172A;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }

            .header {
                padding: 16px;
            }

            .content {
                padding: 16px;
            }

            .analytics-grid,
            .lists-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ==========================================
   üì± MOBILE-FIRST RESPONSIVE DESIGN
   ========================================== */

        /* Mobile Navigation Toggle */
        .mobile-nav-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s;
        }

        .mobile-nav-toggle:active {
            transform: scale(0.95);
        }

        /* Mobile Quick Actions */
        .mobile-quick-actions {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #667eea;
            padding: 12px;
            z-index: 900;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }

        .mobile-action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .mobile-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            border-radius: 12px;
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            cursor: pointer;
            transition: 0.2s;
            font-size: 11px;
            font-weight: 600;
            color: #475569;
        }

        .mobile-action-btn i {
            font-size: 20px;
            margin-bottom: 6px;
            color: #667eea;
        }

        .mobile-action-btn:active {
            transform: scale(0.95);
            background: #EEF2FF;
        }

        /* Mobile Ticket Cards */
        .mobile-ticket-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #E2E8F0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .mobile-ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .mobile-ticket-id {
            font-size: 13px;
            font-weight: 800;
            color: #1E293B;
        }

        .mobile-ticket-age {
            font-size: 11px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .age-fresh {
            background: #DCFCE7;
            color: #059669;
        }

        .age-aging {
            background: #FEF3C7;
            color: #D97706;
        }

        .age-old {
            background: #FED7AA;
            color: #EA580C;
        }

        .age-critical {
            background: #FEE2E2;
            color: #DC2626;
        }

        .mobile-ticket-business {
            font-size: 14px;
            font-weight: 700;
            color: #334155;
            margin-bottom: 8px;
        }

        .mobile-ticket-meta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: #64748B;
            margin-bottom: 12px;
        }

        .mobile-ticket-concern {
            background: #F1F5F9;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 12px;
        }

        .mobile-ticket-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .mobile-btn {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
            background: white;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .mobile-btn-primary {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .mobile-btn:active {
            transform: scale(0.97);
        }

        /* Mobile Stats Cards */
        .mobile-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .mobile-stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #E2E8F0;
        }

        /* ==========================================
   üì± PREMIUM MOBILE TICKET CARDS v2.0
   Touch-Optimized, Expert-Level UX
   ========================================== */

        /* Mobile Ticket Cards Container */
        .mobile-tickets-container {
            display: none;
            padding: 0 4px;
        }

        /* Mobile Ticket Card - Premium Design */
        .mobile-ticket-card {
            background: white;
            border-radius: 16px;
            padding: 0;
            margin-bottom: 16px;
            border: 1px solid #E2E8F0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            transition: all var(--duration-quick) var(--ease-standard);
            animation: mobileCardSlideIn 0.4s var(--ease-decelerate) backwards;
            position: relative;
        }

        .mobile-ticket-card:nth-child(1) {
            animation-delay: 0ms;
        }

        .mobile-ticket-card:nth-child(2) {
            animation-delay: 50ms;
        }

        .mobile-ticket-card:nth-child(3) {
            animation-delay: 100ms;
        }

        .mobile-ticket-card:nth-child(4) {
            animation-delay: 150ms;
        }

        .mobile-ticket-card:nth-child(5) {
            animation-delay: 200ms;
        }

        .mobile-ticket-card:nth-child(n+6) {
            animation-delay: 250ms;
        }

        @keyframes mobileCardSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
        }

        .mobile-ticket-card:active {
            transform: scale(0.99);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* Age-based left border indicator */
        .mobile-ticket-card.age-fresh {
            border-left: 4px solid #10B981;
        }

        .mobile-ticket-card.age-aging {
            border-left: 4px solid #F59E0B;
        }

        .mobile-ticket-card.age-old {
            border-left: 4px solid #EA580C;
        }

        .mobile-ticket-card.age-critical {
            border-left: 4px solid #DC2626;
            animation: mobileCardSlideIn 0.4s var(--ease-decelerate) backwards,
                criticalPulse 2s ease-in-out infinite;
        }

        @keyframes criticalPulse {

            0%,
            100% {
                box-shadow: 0 4px 15px rgba(220, 38, 38, 0.15);
            }

            50% {
                box-shadow: 0 4px 25px rgba(220, 38, 38, 0.3);
            }
        }

        /* Card Header - Status & ID Row */
        .mobile-ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: linear-gradient(135deg, #F8FAFC 0%, #FFFFFF 100%);
            border-bottom: 1px solid #F1F5F9;
        }

        .mobile-ticket-id {
            font-size: 14px;
            font-weight: 800;
            color: #1E293B;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-ticket-id .id-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .mobile-ticket-age {
            font-size: 12px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .mobile-ticket-age i {
            font-size: 10px;
        }

        .mobile-ticket-age.age-fresh {
            background: #DCFCE7;
            color: #059669;
        }

        .mobile-ticket-age.age-aging {
            background: #FEF3C7;
            color: #D97706;
        }

        .mobile-ticket-age.age-old {
            background: #FED7AA;
            color: #EA580C;
        }

        .mobile-ticket-age.age-critical {
            background: #FEE2E2;
            color: #DC2626;
            animation: ageBadgePulse 1.5s ease-in-out infinite;
        }

        @keyframes ageBadgePulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        /* Card Body */
        .mobile-ticket-body {
            padding: 16px;
        }

        /* Business Name - Primary Info */
        .mobile-ticket-business {
            font-size: 16px;
            font-weight: 700;
            color: #1E293B;
            margin-bottom: 10px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Meta Info Row */
        .mobile-ticket-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 16px;
            font-size: 12px;
            color: #64748B;
            margin-bottom: 12px;
        }

        .mobile-ticket-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mobile-ticket-meta-item i {
            color: #94A3B8;
            font-size: 11px;
            width: 14px;
            text-align: center;
        }

        .mobile-ticket-meta-item span {
            font-weight: 500;
        }

        /* Concern Badge */
        .mobile-ticket-concern {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #F1F5F9, #E2E8F0);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 14px;
        }

        .mobile-ticket-concern i {
            color: #667eea;
        }

        /* Status Badge - Mobile Optimized */
        .mobile-ticket-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #F8FAFC;
            border-top: 1px solid #F1F5F9;
        }

        .mobile-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
        }

        .mobile-status-badge i {
            font-size: 12px;
        }

        .mobile-status-badge.status-completed {
            background: #D1FAE5;
            color: #047857;
        }

        .mobile-status-badge.status-pending {
            background: #FEF3C7;
            color: #B45309;
        }

        .mobile-status-badge.status-closed {
            background: #F1F5F9;
            color: #475569;
        }

        .mobile-status-badge.status-cant {
            background: #FEE2E2;
            color: #B91C1C;
        }

        .mobile-status-badge.status-invalid {
            background: #DC2626;
            color: white;
            animation: invalidPulse 1.5s ease-in-out infinite;
        }

        @keyframes invalidPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
            }

            50% {
                box-shadow: 0 0 0 6px rgba(220, 38, 38, 0);
            }
        }

        /* Reason Preview */
        .mobile-ticket-reason {
            padding: 12px 16px;
            background: #FAFBFC;
            border-top: 1px solid #F1F5F9;
            font-size: 12px;
            color: #64748B;
            line-height: 1.5;
        }

        .mobile-ticket-reason-text {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #CBD5E1;
        }

        .mobile-ticket-reason-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: #94A3B8;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Action Buttons - Touch Optimized */
        .mobile-ticket-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 14px 16px;
            background: white;
            border-top: 1px solid #F1F5F9;
        }

        .mobile-btn {
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid #E2E8F0;
            background: white;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--duration-quick) var(--ease-standard);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
            -webkit-tap-highlight-color: transparent;
        }

        .mobile-btn i {
            font-size: 14px;
        }

        .mobile-btn:active {
            transform: scale(0.96);
            transition-duration: 0.05s;
        }

        .mobile-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .mobile-btn-primary:active {
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .mobile-btn-secondary {
            background: #F8FAFC;
            color: #475569;
        }

        .mobile-btn-view {
            grid-column: span 2;
            background: linear-gradient(135deg, #F8FAFC, #FFFFFF);
            color: #64748B;
            font-weight: 600;
        }

        /* Mobile Stats Bar */
        .mobile-stats-bar {
            display: none;
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid #E2E8F0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .mobile-stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            text-align: center;
        }

        .mobile-stat-item {
            padding: 10px 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mobile-stat-item:active {
            transform: scale(0.95);
        }

        .mobile-stat-item.active {
            background: #EEF2FF;
        }

        .mobile-stat-val {
            font-size: 20px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 4px;
        }

        .mobile-stat-lbl {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748B;
        }

        .stat-total .mobile-stat-val {
            color: #4F46E5;
        }

        .stat-done .mobile-stat-val {
            color: #059669;
        }

        .stat-pend .mobile-stat-val {
            color: #D97706;
        }

        .stat-closed .mobile-stat-val {
            color: #475569;
        }

        .stat-cant .mobile-stat-val {
            color: #DC2626;
        }

        /* Search Bar Mobile */
        .mobile-search-bar {
            display: none;
            margin-bottom: 16px;
        }

        .mobile-search-input {
            width: 100%;
            padding: 14px 16px 14px 44px;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            background: white;
            transition: all 0.2s;
        }

        .mobile-search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            outline: none;
        }

        .mobile-search-wrapper {
            position: relative;
        }

        .mobile-search-wrapper i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #94A3B8;
            font-size: 16px;
        }

        /* Empty State */
        .mobile-empty-state {
            text-align: center;
            padding: 60px 24px;
            color: #94A3B8;
        }

        .mobile-empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .mobile-empty-state p {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }

        /* Load More Button */
        .mobile-load-more {
            display: block;
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #F8FAFC, #FFFFFF);
            border: 2px dashed #E2E8F0;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            color: #64748B;
            cursor: pointer;
            transition: all 0.2s;
            margin: 16px 0;
        }

        .mobile-load-more:active {
            transform: scale(0.98);
            background: #EEF2FF;
            border-color: #667eea;
            color: #667eea;
        }

        /* Desktop table hidden on mobile, mobile cards shown */
        @media (max-width: 768px) {
            .desktop-table-wrapper {
                display: none !important;
            }

            .mobile-tickets-container {
                display: block !important;
            }

            .mobile-stats-bar {
                display: block !important;
            }

            .mobile-search-bar {
                display: block !important;
            }

            .table-head-bar {
                flex-direction: column;
                gap: 12px;
                align-items: stretch !important;
            }

            .table-head-bar>div:last-child {
                width: 100%;
            }

            .table-head-bar input {
                width: 100% !important;
            }
        }

        /* Swipe hint indicator */
        .mobile-swipe-hint {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
            font-size: 16px;
            color: #94A3B8;
            animation: swipeHint 2s ease-in-out infinite;
        }

        @keyframes swipeHint {

            0%,
            100% {
                transform: translateY(-50%) translateX(0);
                opacity: 0.3;
            }

            50% {
                transform: translateY(-50%) translateX(-5px);
                opacity: 0.6;
            }
        }

        /* Media Queries */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: -260px;
                transition: left 0.3s;
                height: 100vh;
                z-index: 1000;
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .mobile-nav-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .main {
                margin-left: 0;
            }

            .header {
                padding: 12px 16px;
            }

            .page-title h1 {
                font-size: 16px;
            }

            .filter-bar {
                padding: 12px 16px;
                overflow-x: auto;
            }

            .content {
                padding: 16px;
                padding-bottom: 80px;
            }

            .kpi-grid,
            .agent-grid,
            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .table-wrapper {
                overflow-x: auto;
            }

            /* Show mobile view for dashboard */
            #mobile-view {
                display: block !important;
            }

            #view-dash>.kpi-grid,
            #view-dash>.agent-grid,
            #view-dash>.table-wrapper {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .mobile-quick-actions {
                display: block;
            }

            .mobile-action-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .chart-box {
                height: 300px !important;
            }
        }

        /* Mobile Overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .mobile-overlay.show {
            display: block;
        }

        /* PAGINATION & SKELETON LOADING STYLES */

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .skeleton-box {
            height: 12px;
            background: linear-gradient(90deg, #E2E8F0 25%, #F1F5F9 50%, #E2E8F0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            margin: 4px 0;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        #pagination-controls {
            margin-top: 0;
        }

        .btn:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .btn.btn-primary {
            background: var(--primary);
            color: white;
            font-weight: 700;
        }

        /* ==========================================
   üèÜ ACHIEVEMENT BADGES SYSTEM
   ========================================== */
        .badge-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .achievement-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .achievement-badge.earned {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border: 2px solid #F59E0B;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            animation: badgePulse 2s ease-in-out infinite;
        }

        .achievement-badge.locked {
            background: #F1F5F9;
            border: 2px solid #E2E8F0;
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .achievement-badge:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .achievement-badge.earned:hover {
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.5);
        }

        /* Badge Tooltip */
        .achievement-badge::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: #1E293B;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 100;
        }

        .achievement-badge:hover::after {
            opacity: 1;
            visibility: visible;
        }

        @keyframes badgePulse {

            0%,
            100% {
                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            }

            50% {
                box-shadow: 0 4px 20px rgba(245, 158, 11, 0.6);
            }
        }

        /* Leaderboard Badge Display */
        .leaderboard-badges {
            display: flex;
            gap: 4px;
        }

        .leaderboard-badges .achievement-badge {
            width: 24px;
            height: 24px;
            font-size: 12px;
        }




        /* ==========================================
   ‚öîÔ∏è HEAD-TO-HEAD COMPARISON MODAL
   ========================================== */
        .comparison-modal-content {
            max-width: 900px;
            width: 95%;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .comparison-agent-selector {
            flex: 1;
            text-align: center;
        }

        .comparison-agent-selector select {
            padding: 12px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            min-width: 180px;
        }

        .comparison-agent-selector select option {
            color: #1E293B;
            background: white;
        }

        .comparison-vs {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            color: #667eea;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .comparison-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .comparison-agent-card {
            background: white;
            border-radius: 12px;
            border: 2px solid var(--border);
            overflow: hidden;
        }

        .comparison-agent-header {
            padding: 16px;
            background: linear-gradient(135deg, #F8FAFC 0%, #EEF2FF 100%);
            border-bottom: 1px solid var(--border);
            text-align: center;
        }

        .comparison-agent-name {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .comparison-agent-rank {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-sec);
        }

        .comparison-stats-list {
            padding: 16px;
        }

        .comparison-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #F1F5F9;
        }

        .comparison-stat-row:last-child {
            border-bottom: none;
        }

        .comparison-stat-label {
            font-size: 13px;
            color: var(--text-sec);
            font-weight: 500;
        }

        .comparison-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
        }

        .comparison-stat-value.winner {
            color: #10B981;
        }

        .comparison-stat-value.winner::after {
            content: ' üèÜ';
            font-size: 14px;
        }

        .comparison-stat-value.loser {
            color: #94A3B8;
        }

        .comparison-chart-container {
            grid-column: 1 / -1;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 24px;
            height: 350px;
        }

        .comparison-chart-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 16px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .comparison-body {
                grid-template-columns: 1fr;
            }

            .comparison-header {
                flex-direction: column;
                gap: 16px;
            }

            .comparison-vs {
                order: -1;
            }
        }

        /* ============================================
   PHONE NUMBER DISPLAY STYLES
   ============================================ */

        .phone-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #667eea;
            font-weight: 600;
            text-decoration: none;
            padding: 6px 10px;
            background: #EEF2FF;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 12px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        }

        .phone-link:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .phone-link:active {
            transform: translateY(0);
        }

        .phone-link i {
            font-size: 11px;
        }

        /* Mobile phone CTA */
        .mobile-phone-cta {
            animation: phoneGlow 2s ease-in-out infinite;
        }

        @keyframes phoneGlow {

            0%,
            100% {
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }

            50% {
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5), 0 0 0 4px rgba(102, 126, 234, 0.1);
            }
        }

        .mobile-phone-cta:active {
            transform: scale(0.98);
        }

        /* Agent card phone preview */
        .ac-phone-preview {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <!-- üîê ACCESSIBILITY: Skip to Main Content -->
    <a href="#main-content" class="skip-link">Skip to Main Content</a>

    <!-- LOADING OVERLAY (with ARIA) -->
    <div class="loading-overlay" id="loading-overlay" role="status" aria-live="polite" aria-label="Loading">
        <div class="loading-spinner" aria-hidden="true"></div>
        <span class="sr-only">Loading, please wait...</span>
    </div>


    <!-- üîä SCREEN READER: Live Region for Status Announcements -->
    <div id="status-announcer" class="sr-only" aria-live="polite" aria-atomic="true" role="status">
    </div>

    <!-- üö® SCREEN READER: Assertive Announcements for Critical Alerts -->
    <div id="alert-announcer" class="sr-only" aria-live="assertive" aria-atomic="true" role="alert">
    </div>

    <!-- STATUS + REASON MODAL -->
    <div class="modal-overlay" id="reason-modal" data-current-ticket="">
        <div class="modal" style="max-width: 650px;">
            <div class="modal-header">
                <div class="modal-title">üéØ Update Ticket Status & Reason</div>
                <span class="modal-close" onclick="closeReasonModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="ticket-info" id="modal-ticket-info"></div>

                <div style="margin-bottom: 20px;">
                    <label class="modal-label">üìä Update Status</label>
                    <select class="modal-input" id="modal-status-select"
                        style="min-height: auto; height: 48px; font-size: 15px; font-weight: 600; cursor: pointer;"
                        onchange="updateReasonRequirement()">
                        <option value="Completed">‚úÖ Completed</option>
                        <option value="Not Completed">‚è≥ Not Completed (Pending)</option>
                        <option value="Closed">üîí Closed</option>
                        <option value="Can't Do">‚ùå Can't Do</option>
                    </select>

                </div>

                <div style="margin-bottom: 16px;">
                    <label class="modal-label">üìù Add Reason / Follow-up Notes</label>
                    <textarea class="modal-input" id="reason-input"
                        placeholder="Describe the current status, action taken, or reason for this update...&#10;&#10;Examples:&#10;‚Ä¢ Customer not available, will retry tomorrow&#10;‚Ä¢ Issue resolved, printer configured successfully&#10;‚Ä¢ Hardware replacement required&#10;‚Ä¢ Waiting for customer confirmation"
                        style="min-height: 120px;"></textarea>
                </div>

                <div id="existing-reason-preview"
                    style="display: none; margin-bottom: 16px; padding: 14px; background: #FEF3C7; border-left: 4px solid #F59E0B; border-radius: 8px;">
                    <div
                        style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: #92400E; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-history"></i> Previous Reasons (Will Not Be Deleted)
                    </div>
                    <div id="existing-reason-text"
                        style="font-size: 12px; color: #78350F; max-height: 120px; overflow-y: auto; line-height: 1.6; white-space: pre-wrap;">
                    </div>
                </div>

                <div
                    style="font-size: 11px; color: var(--text-sec); padding: 14px; background: #F8FAFC; border-radius: 8px; border: 1px solid var(--border);">
                    <i class="fas fa-info-circle" style="color: var(--info);"></i>
                    <strong>Note:</strong> Both status and reason will be updated together.
                    New reason will be appended with timestamp - previous reasons won't be deleted.
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeReasonModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" onclick="submitStatusAndReason()">
                    <i class="fas fa-save"></i> Update Status & Save Reason
                </button>
            </div>
        </div>
    </div>

    <!-- ‚öîÔ∏è HEAD-TO-HEAD COMPARISON MODAL -->
    <div class="modal-overlay" id="comparison-modal">
        <div class="modal comparison-modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="modal-title" style="color: white;">
                    <i class="fas fa-balance-scale"></i> Head-to-Head Comparison
                </div>
                <span class="modal-close" onclick="closeComparisonModal()" style="color: white;">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Agent Selector Header -->
                <div class="comparison-header">
                    <div class="comparison-agent-selector">
                        <select id="compare-agent-1" onchange="updateComparison()">
                            <option value="">Select Agent 1</option>
                        </select>
                    </div>
                    <div class="comparison-vs">VS</div>
                    <div class="comparison-agent-selector">
                        <select id="compare-agent-2" onchange="updateComparison()">
                            <option value="">Select Agent 2</option>
                        </select>
                    </div>
                </div>

                <!-- Comparison Body -->
                <div class="comparison-body" id="comparison-body">
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #64748B;">
                        <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>Select two agents above to compare their performance</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CREATE TICKET MODAL -->
    <div class="modal-overlay" id="create-ticket-modal">
        <div class="modal" style="max-width: 750px;">
            <div class="modal-header">
                <div class="modal-title">üé´ Create New Support Ticket</div>
                <span class="modal-close" onclick="closeCreateModal()">&times;</span>
            </div>
            <div class="modal-body">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label class="modal-label">üìß Email Address <span style="color:#DC2626;">*</span></label>
                        <input type="email" class="modal-input" id="new-email" style="min-height: auto; height: 42px;"
                            placeholder="your.email@billfree.in" required>
                    </div>

                    <div>
                        <label class="modal-label">üë§ IT Person (Agent) <span style="color:#DC2626;">*</span></label>
                        <select class="modal-input" id="new-agent" style="min-height: auto; height: 42px;" required>
                            <option value="">-- Select Agent --</option>
                            <option value="Manjeet">Manjeet</option>
                            <option value="Suraj">Suraj</option>
                            <option value="Veer Bahadur">Veer Bahadur</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label class="modal-label">üôã Requested By</label>
                        <input type="text" class="modal-input" id="new-requested"
                            style="min-height: auto; height: 42px;" placeholder="Customer/Staff Name">
                    </div>

                    <div>
                        <label class="modal-label">üè™ MID (Merchant ID)</label>
                        <input type="text" class="modal-input" id="new-mid" style="min-height: auto; height: 42px;"
                            placeholder="e.g. 12345">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label class="modal-label">üè¢ Business Name <span style="color:#DC2626;">*</span></label>
                        <input type="text" class="modal-input" id="new-business" style="min-height: auto; height: 42px;"
                            placeholder="Business/Store Name" required>
                    </div>

                    <div>
                        <label class="modal-label">üìû Phone Number</label>
                        <input type="tel" class="modal-input" id="new-phone" style="min-height: auto; height: 42px;"
                            placeholder="10-digit Mobile Number" pattern="[0-9]{10}"
                            title="Please enter a valid 10-digit mobile number">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label class="modal-label">üíª POS</label>
                        <input type="text" class="modal-input" id="new-pos" style="min-height: auto; height: 42px;"
                            placeholder="POS/Device Info">
                    </div>
                    <div><!-- Spacer --></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label class="modal-label">üõ†Ô∏è Support Type <span style="color:#DC2626;">*</span></label>
                        <select class="modal-input" id="new-support-type" style="min-height: auto; height: 42px;"
                            onchange="updateConcernList()" required>
                            <option value="">-- Select Support Type --</option>
                            <option value="Customer Support">Customer Support</option>
                            <option value="Floor Support">Floor Support</option>
                            <option value="FOS Support">FOS Support</option>
                            <option value="IT Floor Support">IT Floor Support</option>
                        </select>
                    </div>

                    <div>
                        <label class="modal-label">‚ö†Ô∏è Concern Related to <span style="color:#DC2626;">*</span></label>
                        <select class="modal-input" id="new-concern" style="min-height: auto; height: 42px;" required>
                            <option value="">-- Select Concern --</option>
                            <option value="New Integration">New Integration</option>
                            <option value="Print issue">Print issue</option>
                            <option value="Bill Delivery issue">Bill Delivery issue</option>
                            <option value="Reinstallation">Reinstallation</option>
                            <option value="LOGO & Stamp Update">LOGO & Stamp Update</option>
                            <option value="Config issue">Config issue</option>
                            <option value="Billfree POP Up">Billfree POP Up</option>
                            <option value="Printer issue">Printer issue</option>
                            <option value="Background Merging">Background Merging</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <label class="modal-label">‚öôÔ∏è Configuration</label>
                    <select class="modal-input" id="new-config" style="min-height: auto; height: 42px;">
                        <option value="">-- Select Configuration --</option>
                        <option value="No Config Available">No Config Available</option>
                        <option value="Complete Config">Complete Config</option>
                        <option value="Partial Config(Available)">Partial Config(Available)</option>
                    </select>
                </div>

                <div style="margin-bottom: 16px;">
                    <label class="modal-label">Remark if any</label>
                    <textarea class="modal-input" id="new-remark" style="min-height: 90px;"
                        placeholder="Describe the issue or request in detail..."></textarea>
                </div>

                <div style="margin-bottom: 16px;">
                    <label class="modal-label">üìä Status <span style="color:#DC2626;">*</span></label>
                    <select class="modal-input" id="new-status"
                        style="min-height: auto; height: 42px; font-weight: 600;" onchange="toggleReasonField()">
                        <option value="" selected disabled>-- Select Status --</option>
                        <option value="Completed">‚úÖ Completed</option>
                        <option value="Not Completed">‚è≥ Not Completed</option>
                        <option value="Closed">üîí Closed</option>
                        <option value="Can't Do">‚ùå Can't Do</option>
                    </select>
                </div>

                <div id="reason-field-container" style="display: none; margin-bottom: 16px;">
                    <label class="modal-label" id="reason-field-label">üìã Reason / Note <span
                            style="color:#DC2626;">*</span></label>
                    <textarea class="modal-input" id="new-reason" style="min-height: 80px;"
                        placeholder="Explain the reason..."></textarea>
                    <div id="reason-field-hint" style="font-size: 11px; color: var(--text-sec); margin-top: 6px;">
                        <i class="fas fa-info-circle"></i> Select a status first
                    </div>
                </div>

                <div
                    style="font-size: 11px; color: var(--text-sec); padding: 14px; background: #F8FAFC; border-radius: 8px; border: 1px solid var(--border);">
                    <i class="fas fa-info-circle" style="color: var(--info);"></i>
                    <strong>Note:</strong> Ticket ID will be auto-generated when the ticket is created in the sheet.
                    Fields marked with <span style="color:#DC2626;">*</span> are required.
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeCreateModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" onclick="submitNewTicket()">
                    <i class="fas fa-paper-plane"></i> Create Ticket
                </button>
            </div>
        </div>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:600;">INITIALIZING...</p>
    </div>

    <div class="sidebar">
        <!-- Premium Brand Header -->
        <div class="sidebar-header">
            <div class="brand"><i class="fas fa-bolt"></i> BillFree TechSupport</div>
            <div class="brand-subtitle">
                <span class="status-dot"></span>
                Live ‚Ä¢ v10.0 PRO
            </div>
        </div>

        <!-- Navigation Container -->
        <div class="nav-container">
            <div class="nav-label">
                <i class="fas fa-compass nav-label-icon"></i> Main
            </div>
            <div class="nav-item active" onclick="nav('dash', this)" tabindex="0" role="button" aria-current="page">
                <i class="fas fa-home"></i>
                <span class="nav-item-text">Dashboard</span>
            </div>
            <div class="nav-item" onclick="nav('team', this)" tabindex="0" role="button">
                <i class="fas fa-trophy"></i>
                <span class="nav-item-text">Team Performance</span>
            </div>

            <div class="nav-label">
                <i class="fas fa-database nav-label-icon"></i> Data
            </div>
            <div class="nav-item" onclick="nav('analytics', this)" tabindex="0" role="button">
                <i class="fas fa-chart-pie"></i>
                <span class="nav-item-text">Manager Analytics</span>
            </div>
            <div class="nav-item" onclick="nav('tickets', this)" tabindex="0" role="button">
                <i class="fas fa-server"></i>
                <span class="nav-item-text">Master Database</span>
            </div>

            <div class="nav-label">
                <i class="fas fa-file-alt nav-label-icon"></i> Reports
            </div>
            <div class="nav-item" onclick="nav('history', this)" tabindex="0" role="button">
                <i class="fas fa-history"></i>
                <span class="nav-item-text">Update History</span>
            </div>
            <div class="nav-item" onclick="nav('reports', this)" tabindex="0" role="button">
                <i class="fas fa-file-export"></i>
                <span class="nav-item-text">Monthly Reports</span>
            </div>
        </div>

        <!-- Sidebar Footer with Theme Toggle -->
        <div class="sidebar-footer">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode"
                aria-label="Toggle theme">
                <i class="fas fa-moon moon-icon"></i>
                <i class="fas fa-sun sun-icon"></i>
                <span id="theme-label" style="margin-left: 8px; font-size: 12px;">Light Mode</span>
            </button>
        </div>
    </div>


    </div>

    <div class="main">
        <div class="header">
            <div class="page-title">
                <h1>IT Command Center</h1>
                <p style="font-size:12px; color:#64748B; margin:0;">Live Metrics ‚Ä¢ Version Polling Enabled ‚Ä¢ Combined
                    Update üéØ</p>
            </div>
            <div style="display: flex; gap: 8px;">
                <!-- üîî NOTIFICATION BUTTON -->
                <button class="btn" onclick="toggleNotificationSettings()" title="Notification Settings"
                    style="width: 42px; padding: 8px;">
                    üîî
                </button>

                <!-- ‚å®Ô∏è KEYBOARD SHORTCUTS BUTTON -->
                <button class="btn" onclick="showKeyboardShortcuts()" title="Keyboard Shortcuts"
                    style="width: 42px; padding: 8px;">
                    ‚å®Ô∏è
                </button>

                <button class="btn btn-primary" onclick="openCreateModal()" style="background: #10B981;">

                    <i class="fas fa-plus-circle"></i> Create Ticket
                </button>
                <button class="btn btn-primary" onclick="fetchData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <div class="filter-bar">
            <button class="pill active" onclick="applyDateFilter('all', this)">All Time</button>
            <button class="pill" onclick="applyDateFilter('today', this)">Today</button>
            <button class="pill" onclick="applyDateFilter('yesterday', this)">Yesterday</button>
            <button class="pill" onclick="applyDateFilter('7days', this)">7 Days</button>
            <button class="pill" onclick="applyDateFilter('30days', this)">30 Days</button>
            <button class="pill" onclick="toggleCustomRange(this)">Custom</button>
            <div class="custom-range" id="custom-range-box">
                <input type="date" id="start-date" style="padding:4px;">
                <input type="date" id="end-date" style="padding:4px;">
                <button class="btn btn-primary" style="padding:4px 10px;" onclick="applyCustomDate()">Go</button>
            </div>
        </div>

        <div class="content">

            <!-- DASHBOARD VIEW -->
            <div id="view-dash">
                <div class="kpi-grid">
                    <div class="kpi-card card-total active" onclick="filterTable('Total', this)">
                        <div class="kpi-head"><span class="kpi-label" style="color:var(--primary)">Total
                                Tickets</span><i class="fas fa-ticket-alt kpi-icon" style="color:var(--primary)"></i>
                        </div>
                        <div class="kpi-val" id="k-total">0</div>
                    </div>
                    <div class="kpi-card card-comp" onclick="filterTable('Completed', this)">
                        <div class="kpi-head"><span class="kpi-label" style="color:var(--success)">Completed</span><i
                                class="fas fa-check-circle kpi-icon"></i></div>
                        <div class="kpi-val" id="k-comp">0</div>
                    </div>
                    <div class="kpi-card card-pend" onclick="filterTable('Not Completed', this)">
                        <div class="kpi-head"><span class="kpi-label" style="color:var(--warning)">Pending</span><i
                                class="fas fa-clock kpi-icon"></i></div>
                        <div class="kpi-val" id="k-not">0</div>
                    </div>
                    <div class="kpi-card card-closed" onclick="filterTable('Closed', this)">
                        <div class="kpi-head"><span class="kpi-label" style="color:var(--gray)">Closed</span><i
                                class="fas fa-archive kpi-icon"></i></div>
                        <div class="kpi-val" id="k-closed">0</div>
                    </div>
                    <div class="kpi-card card-cant" onclick="filterTable('Can\'t Do', this)">
                        <div class="kpi-head"><span class="kpi-label" style="color:var(--danger)">Can't Do</span><i
                                class="fas fa-ban kpi-icon"></i></div>
                        <div class="kpi-val" id="k-cant">0</div>
                    </div>
                </div>

                <div class="section-title"><i class="fas fa-trophy" style="color:var(--warning)"></i> Team Overview
                </div>
                <div
                    style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:20px 24px; border-radius:12px; margin-bottom:24px; color:white;">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                        <i class="fas fa-chart-line" style="font-size:20px;"></i>
                        <h3 style="margin:0; font-size:16px; font-weight:700;">üìäScoring System</h3>
                    </div>
                    <div
                        style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:10px; font-size:12px;">
                        <div
                            style="background:rgba(255,255,255,0.15); padding:10px 12px; border-radius:6px; backdrop-filter:blur(10px);">
                            <strong style="font-size:14px;">+10</strong> Completed
                        </div>
                        <div
                            style="background:rgba(255,255,255,0.15); padding:10px 12px; border-radius:6px; backdrop-filter:blur(10px);">
                            <strong style="font-size:14px;">+0</strong> Valid Closed
                        </div>
                        <div
                            style="background:rgba(255,255,255,0.15); padding:10px 12px; border-radius:6px; backdrop-filter:blur(10px);">
                            <strong style="font-size:14px;">-5</strong> Can't Do
                        </div>
                        <div
                            style="background:rgba(255,255,255,0.15); padding:10px 12px; border-radius:6px; backdrop-filter:blur(10px);">
                            <strong style="font-size:14px;">-10</strong> Invalid
                        </div>
                        <div
                            style="background:rgba(255,255,255,0.15); padding:10px 12px; border-radius:6px; backdrop-filter:blur(10px);">
                            <strong style="font-size:14px;">-3</strong> Old Pending
                        </div>
                    </div>
                </div>


                <div class="agent-grid" id="dash-agent-grid"></div>

                <div id="table-scroll-target">
                    <div class="table-wrapper">
                        <div class="table-head-bar">
                            <span style="font-weight:700;" id="table-title">Ticket List</span>
                            <input type="text" id="table-search" placeholder="üîç Search tickets..."
                                oninput="onSearchInputPaginated(this)" autocomplete="off"
                                style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; width: 300px;">
                        </div>

                        <table>
                            <thead id="table-head"></thead>
                            <tbody id="dash-table"></tbody>
                        </table>
                    </div>
                    <div id="pagination-controls"></div>
                </div>
            </div>

            <!-- MOBILE-FIRST QUICK VIEW -->
            <div id="mobile-view" class="hidden" style="display: none;">
                <div class="mobile-stats-grid">
                    <div class="mobile-stat-card">
                        <div class="mobile-stat-val" style="color: #667eea;" id="mobile-total">0</div>
                        <div class="mobile-stat-lbl">Total</div>
                    </div>
                    <div class="mobile-stat-card">
                        <div class="mobile-stat-val" style="color: #D97706;" id="mobile-pending">0</div>
                        <div class="mobile-stat-lbl">Pending</div>
                    </div>
                    <div class="mobile-stat-card">
                        <div class="mobile-stat-val" style="color: #059669;" id="mobile-completed">0</div>
                        <div class="mobile-stat-lbl">Done</div>
                    </div>
                    <div class="mobile-stat-card">
                        <div class="mobile-stat-val" style="color: #DC2626;" id="mobile-critical">0</div>
                        <div class="mobile-stat-lbl">Critical</div>
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px; font-size: 16px; font-weight: 700; color: #1E293B;">
                        <i class="fas fa-fire" style="color: #EF4444;"></i> My Pending Tickets
                    </h3>
                    <div id="mobile-tickets-container"></div>
                </div>
            </div>

            <!-- MOBILE NAVIGATION TOGGLE -->
            <button class="mobile-nav-toggle" onclick="toggleMobileNav()">
                <i class="fas fa-bars"></i>
            </button>

            <!-- MOBILE OVERLAY -->
            <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileNav()"></div>

            <!-- MOBILE QUICK ACTIONS BAR -->
            <div class="mobile-quick-actions">
                <div class="mobile-action-grid">
                    <div class="mobile-action-btn" onclick="openCreateModal()">
                        <i class="fas fa-plus-circle"></i>
                        <span>New</span>
                    </div>
                    <div class="mobile-action-btn" onclick="fetchData()">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh</span>
                    </div>
                    <div class="mobile-action-btn" onclick="nav('analytics', this)">
                        <i class="fas fa-chart-pie"></i>
                        <span>Stats</span>
                    </div>
                    <div class="mobile-action-btn" onclick="nav('tickets', this)">
                        <i class="fas fa-database"></i>
                        <span>All</span>
                    </div>
                </div>
            </div>


            <!-- TEAM PERFORMANCE VIEW (COMBINED) -->
            <div id="view-team" class="hidden">

                <!-- SECTION 1: LEADERBOARD AT TOP -->
                <div
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; border-radius: 16px; margin-bottom: 32px; color: white;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin:0 0 8px; color: white;">üèÜ Team Leaderboard</h2>
                            <p style="margin:0; font-size:13px; opacity:0.9;">
                                <span id="leaderboard-period">This Week</span> ‚Ä¢
                                Updated <span id="leaderboard-updated">just now</span>
                            </p>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="pill" onclick="renderLeaderboard('week', this)"
                                style="background:transparent; color:white; border: 1px solid rgba(255,255,255,0.3);">
                                This Week
                            </button>
                            <button class="pill" onclick="renderLeaderboard('month', this)"
                                style="background:transparent; color:white; border: 1px solid rgba(255,255,255,0.3);">
                                This Month
                            </button>
                            <button class="pill" id="pill-all-time" onclick="renderLeaderboard('all', this)"
                                style="background:rgba(255,255,255,0.2); color:white; border: 1px solid rgba(255,255,255,0.5);">
                                All Time
                            </button>
                        </div>
                    </div>

                    <!-- TOP 3 PODIUM -->
                    <div id="leaderboard-podium" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px;">
                    </div>
                </div>

                <!-- SECTION 2: FULL RANKINGS TABLE -->
                <div style="margin-bottom: 40px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; font-weight:700; color:#1E293B;">üìä Full Rankings</h3>
                        <button class="btn btn-primary" onclick="openComparisonModal()"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="fas fa-balance-scale"></i> Compare Agents
                        </button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:60px;">Rank</th>
                                    <th>Agent</th>
                                    <th>Points</th>
                                    <th>Tickets</th>
                                    <th>Completed</th>
                                    <th>Rate %</th>
                                    <th>Avg Time</th>
                                    <th>Badges</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- SECTION 2.5: WEEKLY GOALS PROGRESS -->
                <div class="goals-section">
                    <div class="goals-header">
                        <div>
                            <h3 style="margin: 0 0 4px; font-weight: 700; color: #1E293B;">
                                <i class="fas fa-bullseye" style="color: #10B981;"></i> Weekly Goals Progress
                            </h3>
                            <p style="margin: 0; font-size: 12px; color: #64748B;">
                                Target: <span id="weekly-goal-target">25</span> tickets per agent this week
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <label style="font-size: 12px; font-weight: 600; color: #64748B;">Goal:</label>
                            <input type="number" id="goal-input" value="25" min="5" max="100"
                                onchange="updateWeeklyGoal(this.value)"
                                style="width: 60px; padding: 6px 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-weight: 600;">
                        </div>
                    </div>
                    <div class="goals-grid" id="goals-grid">
                        <!-- Goals will be rendered here by JavaScript -->
                    </div>
                </div>


                <!-- SECTION 3: DETAILED AGENT REPORTS -->
                <div style="border-top: 2px solid #E2E8F0; padding-top: 32px; margin-top: 32px;">
                    <h3 style="margin: 0 0 20px; font-weight:700; color:#1E293B;">üë• Detailed Performance Reports</h3>
                    <div class="full-agent-grid" id="full-team-report"></div>
                </div>

                <!-- SECTION 4: SCORING SYSTEM INFO -->
                <!-- Replace existing scoring section in view-team -->
                <div
                    style="margin-top:40px; padding:24px; background:#F8FAFC; border-radius:12px; border:1px solid #E2E8F0;">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
                        <i class="fas fa-calculator" style="font-size:20px; color:#667eea;"></i>
                        <h4 style="margin:0; font-size:16px; font-weight:700; color:#1E293B;">üìä Productivity & Scoring
                            System</h4>
                    </div>

                    <div
                        style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px; font-size:13px;">
                        <div
                            style="padding:12px 16px; background:white; border-radius:8px; border-left:4px solid #10B981;">
                            <strong style="color:#10B981; font-size:16px;">+10 points:</strong>
                            <span style="color:#64748B;"> Completed ticket</span>
                        </div>
                        <div
                            style="padding:12px 16px; background:white; border-radius:8px; border-left:4px solid #94A3B8;">
                            <strong style="color:#94A3B8; font-size:16px;">+0 points:</strong>
                            <span style="color:#64748B;"> Valid closed ticket</span>
                        </div>
                        <div
                            style="padding:12px 16px; background:white; border-radius:8px; border-left:4px solid #F59E0B;">
                            <strong style="color:#F59E0B; font-size:16px;">-5 points:</strong>
                            <span style="color:#64748B;"> Can't Do ticket</span>
                        </div>
                        <div
                            style="padding:12px 16px; background:white; border-radius:8px; border-left:4px solid #EF4444;">
                            <strong style="color:#EF4444; font-size:16px;">-10 points:</strong>
                            <span style="color:#64748B;"> Invalid closed</span>
                        </div>
                        <div
                            style="padding:12px 16px; background:white; border-radius:8px; border-left:4px solid #DC2626;">
                            <strong style="color:#DC2626; font-size:16px;">-3 points:</strong>
                            <span style="color:#64748B;"> Pending > 7 days</span>
                        </div>
                    </div>

                    <div
                        style="margin-top:16px; padding:12px; background:#EEF2FF; border-radius:6px; font-size:12px; color:#475569;">
                        <i class="fas fa-info-circle" style="color:#667eea;"></i>
                        <strong>Note:</strong> Points are calculated automatically based on ticket status and resolution
                        time. Higher scores indicate better productivity.
                    </div>
                </div>


            </div>

            <!-- MANAGER ANALYTICS VIEW -->
            <div id="view-analytics" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0;">üìä Manager Analytics Dashboard</h2>
                    <button class="btn" onclick="renderAllAnalytics()" style="padding:6px 12px;">
                        <i class="fas fa-sync-alt"></i> Refresh Analytics
                    </button>
                </div>

                <!-- ‚úÖ SECTION 1: MID & POS ANALYSIS -->
                <h3 style="margin: 30px 0 20px; font-weight:700;">üîç MID & POS Analysis</h3>
                <div class="analytics-grid">
                    <div class="chart-box">
                        <h4 style="margin:0 0 15px; font-size:14px;">üîÅ Top 10 MIDs - Same Recurring Issue</h4>
                        <canvas id="c-mid-same-concern"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4 style="margin:0 0 15px; font-size:14px;">üîÄ Top 10 MIDs - Multiple Different Issues</h4>
                        <canvas id="c-mid-diff-concern"></canvas>
                    </div>
                </div>

                <div class="analytics-grid">
                    <div class="chart-box">
                        <h4 style="margin:0 0 15px; font-size:14px;">üíª Top 10 POS Systems (Issue Count)</h4>
                        <canvas id="c-top-pos"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4 style="margin:0 0 15px; font-size:14px;">üîÑ Repeat Customers (High Ticket Volume)</h4>
                        <canvas id="c-repeat-customers"></canvas>
                    </div>
                </div>

                <!-- ‚úÖ SECTION 2: FLOOR SUPPORT DETAILS TABLE -->
                <h3 style="margin: 30px 0 20px; font-weight:700;">üè¢ Recent IT Floor Support Details (Top 5)</h3>
                <div class="table-wrapper" style="margin-bottom: 30px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Ticket ID</th>
                                <th>Date</th>
                                <th>Agent</th>
                                <th>Requested By</th>
                                <th>Business</th>
                                <th>Concern</th>
                                <th style="max-width:300px;">Remark</th>
                                <th>üìû Phone</th>
                                <th>Status</th>
                                <th>Age</th>
                            </tr>
                        </thead>
                        <tbody id="floor-support-table"></tbody>
                    </table>
                </div>

                <!-- ‚úÖ SECTION 3: TRENDS & INSIGHTS -->
                <h3 style="margin: 30px 0 20px; font-weight:700;">üìà Trends & Insights</h3>
                <div class="analytics-grid">
                    <div class="chart-box">
                        <h4 style="margin:0 0 15px; font-size:14px;">üìä Concern Type Trends (Last 30 vs Previous 30
                            Days)</h4>
                        <canvas id="c-concern-trends"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4 style="margin:0 0 15px; font-size:14px;">üéØ Agent Specialization Matrix</h4>
                        <canvas id="c-agent-specialization"></canvas>
                    </div>
                </div>

                <!-- ‚úÖ SECTION 4: ISSUE & WORKLOAD DISTRIBUTION -->
                <h3 style="margin: 30px 0 20px; font-weight:700;">üìä Issue & Workload Distribution</h3>
                <div class="analytics-grid">
                    <div class="chart-box">
                        <h4 style="margin:0 0 15px; font-size:14px;">üìã Issue Category Distribution</h4>
                        <canvas id="c-issues"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4 style="margin:0 0 15px; font-size:14px;">üèÜ Agent Workload Share</h4>
                        <canvas id="c-agents"></canvas>
                    </div>
                </div>

                <!-- ‚úÖ SECTION 5: PER-AGENT PERFORMANCE -->
                <h3 style="margin: 30px 0 20px; font-weight:700;">üìà Per-Agent Performance Analytics</h3>
                <div class="analytics-grid">
                    <div class="chart-box" style="height:400px;">
                        <h4 style="margin:0 0 15px; font-size:14px;">üìÖ Weekly Ticket Volume per Agent</h4>
                        <canvas id="c-weekly-load"></canvas>
                    </div>
                    <div class="chart-box" style="height:400px;">
                        <h4 style="margin:0 0 15px; font-size:14px;">‚úÖ Completion Rate Breakdown</h4>
                        <canvas id="c-completion-rate"></canvas>
                    </div>
                </div>

                <div class="analytics-grid">
                    <div class="chart-box" style="height:400px;">
                        <h4 style="margin:0 0 15px; font-size:14px;">üìä Status Distribution by Agent</h4>
                        <canvas id="c-status-dist"></canvas>
                    </div>
                </div>

                <!-- ‚úÖ SECTION 6: SKILL-MIX & SPECIALIZATION -->
                <h3 style="margin: 30px 0 20px; font-weight:700;">üéØ Skill-Mix & Specialization Analytics</h3>
                <div id="skill-mix-container"></div>
            </div>


            <!-- MASTER DATABASE VIEW -->
            <div id="view-tickets" class="hidden">
                <!-- Enhanced Search Bar -->
                <div
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <i class="fas fa-database" style="font-size: 24px; color: white;"></i>
                        <h2 style="margin: 0; color: white; font-weight: 800;">Master Database</h2>
                    </div>

                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                        <!-- Main Search Input -->
                        <div style="flex: 2; min-width: 250px;">
                            <div style="position: relative;">
                                <i class="fas fa-search"
                                    style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #94A3B8;"></i>
                                <input type="text" id="master-search-input"
                                    placeholder="Search tickets... (ID, Business, MID, Agent, Concern)"
                                    oninput="onMasterSearchInput(this)"
                                    style="width: 100%; padding: 14px 14px 14px 42px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); background: white; font-size: 14px; font-weight: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            </div>
                        </div>

                        <!-- Status Filter -->
                        <select onchange="onMasterFilterChange('status', this.value)"
                            style="padding: 14px 18px; border-radius: 10px; border: none; background: white; font-weight: 600; font-size: 13px; cursor: pointer; min-width: 150px;">
                            <option value="all">üìä All Status</option>
                            <option value="pending">‚è≥ Pending</option>
                            <option value="completed">‚úÖ Completed</option>
                            <option value="closed">üîí Closed</option>
                            <option value="cantdo">‚ùå Can't Do</option>
                        </select>

                        <!-- Agent Filter -->
                        <select onchange="onMasterFilterChange('agent', this.value)"
                            style="padding: 14px 18px; border-radius: 10px; border: none; background: white; font-weight: 600; font-size: 13px; cursor: pointer; min-width: 150px;">
                            <option value="all">üë• All Agents</option>
                            <option value="Manjeet">Manjeet</option>
                            <option value="Suraj">Suraj</option>
                            <option value="Veer Bahadur">Veer Bahadur</option>
                        </select>

                        <!-- Clear Filters Button -->
                        <button onclick="clearMasterFilters()"
                            style="padding: 14px 20px; border-radius: 10px; border: none; background: rgba(255,255,255,0.2); color: white; font-weight: 700; cursor: pointer; transition: 0.2s;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>

                    <!-- Result Info -->
                    <div id="master-result-info"
                        style="margin-top: 14px; font-size: 13px; color: rgba(255,255,255,0.9);">
                        Loading...
                    </div>
                </div>

                <!-- Table -->
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Age</th>
                                <th>Agent</th>
                                <th>MID</th>
                                <th>Business</th>
                                <th>Concern</th>
                                <th>Status</th>
                                <th style="min-width: 200px;">Reason / Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="master-table"></tbody>
                    </table>
                </div>
                <!-- ‚úÖ Master Pagination Controls -->
                <div id="master-pagination-controls" style="margin-top: 16px;"></div>
            </div>

            <!-- ==========================================
                 üìú UPDATE HISTORY VIEW
                 ========================================== -->
            <div id="view-history" class="hidden">
                <div
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-exchange-alt" style="font-size: 24px; color: white;"></i>
                            <div>
                                <h2 style="margin: 0; color: white; font-weight: 800;">Status Change History</h2>
                                <p style="color: rgba(255,255,255,0.8); margin: 4px 0 0; font-size: 13px;">
                                    Track all ticket status transitions and close denials
                                </p>
                            </div>

                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="exportHistory()"
                                style="background: rgba(255,255,255,0.2); color: white; border: none;">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Filters -->
                <div
                    style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #E2E8F0; margin-bottom: 20px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end;">
                        <!-- Row 1: Text Filters -->
                        <div style="flex: 1; min-width: 180px;">
                            <label
                                style="display: block; font-size: 11px; font-weight: 700; color: #64748B; margin-bottom: 6px; text-transform: uppercase;">Ticket
                                ID</label>
                            <input type="text" id="history-ticket-filter" placeholder="üîç Search..."
                                oninput="debounceFilterHistory()"
                                style="width: 100%; padding: 10px 14px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 13px;">
                        </div>

                        <div style="flex: 1; min-width: 180px;">
                            <label
                                style="display: block; font-size: 11px; font-weight: 700; color: #64748B; margin-bottom: 6px; text-transform: uppercase;">User</label>
                            <input type="text" id="history-user-filter" placeholder="üë§ Search..."
                                oninput="debounceFilterHistory()"
                                style="width: 100%; padding: 10px 14px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 13px;">
                        </div>

                        <div style="min-width: 150px;">
                            <label
                                style="display: block; font-size: 11px; font-weight: 700; color: #64748B; margin-bottom: 6px; text-transform: uppercase;">Action</label>
                            <select id="history-action-filter" onchange="filterHistory()"
                                style="width: 100%; padding: 10px 14px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                <option value="all">All Status Changes</option>
                                <option value="TICKET_UPDATED">üìù Status Updated</option>
                                <option value="CLOSE_ATTEMPT_DENIED">üö´ Close Denied</option>
                            </select>
                        </div>


                        <div style="min-width: 140px;">
                            <label
                                style="display: block; font-size: 11px; font-weight: 700; color: #64748B; margin-bottom: 6px; text-transform: uppercase;">Severity</label>
                            <select id="history-severity-filter" onchange="filterHistory()"
                                style="width: 100%; padding: 10px 14px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                <option value="all">All Levels</option>
                                <option value="INFO">‚ÑπÔ∏è Info</option>
                                <option value="WARNING">‚ö†Ô∏è Warning</option>
                                <option value="ERROR">‚ùå Error</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 2: Date Range -->
                    <div
                        style="display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; margin-top: 16px; padding-top: 16px; border-top: 1px solid #E2E8F0;">
                        <div style="min-width: 160px;">
                            <label
                                style="display: block; font-size: 11px; font-weight: 700; color: #64748B; margin-bottom: 6px; text-transform: uppercase;">
                                <i class="fas fa-calendar" style="margin-right: 4px;"></i>Start Date
                            </label>
                            <input type="date" id="history-start-date" onchange="filterHistory()"
                                style="width: 100%; padding: 10px 14px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 13px;">
                        </div>

                        <div style="min-width: 160px;">
                            <label
                                style="display: block; font-size: 11px; font-weight: 700; color: #64748B; margin-bottom: 6px; text-transform: uppercase;">
                                <i class="fas fa-calendar" style="margin-right: 4px;"></i>End Date
                            </label>
                            <input type="date" id="history-end-date" onchange="filterHistory()"
                                style="width: 100%; padding: 10px 14px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 13px;">
                        </div>

                        <button class="btn" onclick="setHistoryDatePreset('today')"
                            style="padding: 10px 14px; font-size: 12px;">Today</button>
                        <button class="btn" onclick="setHistoryDatePreset('week')"
                            style="padding: 10px 14px; font-size: 12px;">This Week</button>
                        <button class="btn" onclick="setHistoryDatePreset('month')"
                            style="padding: 10px 14px; font-size: 12px;">This Month</button>

                        <div style="margin-left: auto; display: flex; gap: 10px;">
                            <button class="btn" onclick="clearHistoryFilters()" style="padding: 10px 16px;">
                                <i class="fas fa-times"></i> Clear
                            </button>
                            <button class="btn btn-primary" onclick="loadUpdateHistory(1)" style="padding: 10px 16px;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Bar with Duration Insights -->
                <div id="history-stats" style="display: flex; gap: 16px; margin-bottom: 16px;"></div>

                <!-- Duration Stats Bar -->
                <div id="duration-stats" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;"></div>

                <!-- History Table with Duration Column -->
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 150px;">Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Ticket ID</th>
                                <th>Previous Status</th>
                                <th>New Status</th>
                                <th style="text-align: center; width: 110px;">
                                    <i class="fas fa-stopwatch" style="margin-right: 4px;"></i>Duration
                                </th>
                                <th style="text-align: center;">Severity</th>
                                <th style="text-align: center;">Reason</th>
                            </tr>
                        </thead>
                        <tbody id="history-table"></tbody>
                    </table>
                </div>
                <div id="history-pagination" style="margin-top: 16px;"></div>
            </div>


            <!-- ==========================================
                 üìä MONTHLY REPORTS VIEW (Phase 3 Enhanced)
                 ========================================== -->
            <div id="view-reports" class="hidden">
                <div
                    style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); padding: 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 8px 30px rgba(16, 185, 129, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-file-export" style="font-size: 24px; color: white;"></i>
                            <div>
                                <h2 style="margin: 0; color: white; font-weight: 800;">Monthly Operations Report</h2>
                                <p style="color: rgba(255,255,255,0.8); margin: 4px 0 0; font-size: 13px;">
                                    Generate comprehensive reports with insights and recommendations
                                </p>
                            </div>
                        </div>
                        <div id="current-month-badge"
                            style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 8px;">
                            <span style="color: white; font-size: 12px; font-weight: 600;"
                                id="current-month-label"></span>
                        </div>
                    </div>
                </div>

                <!-- Report Generator -->
                <div
                    style="background: white; padding: 24px; border-radius: 12px; border: 1px solid #E2E8F0; margin-bottom: 24px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; font-weight: 700;">
                            <i class="fas fa-calendar-alt" style="color: #4F46E5;"></i> Select Report Period
                        </h3>
                        <span style="font-size: 12px; color: #64748B;">
                            <i class="fas fa-info-circle"></i> Reports include performance grades, trends, and
                            recommendations
                        </span>
                    </div>

                    <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end;">
                        <div>
                            <label
                                style="display: block; font-size: 11px; font-weight: 700; color: #64748B; margin-bottom: 6px; text-transform: uppercase;">Month</label>
                            <select id="report-month"
                                style="padding: 12px 20px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px; font-weight: 600; min-width: 150px; cursor: pointer;">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>

                        <div>
                            <label
                                style="display: block; font-size: 11px; font-weight: 700; color: #64748B; margin-bottom: 6px; text-transform: uppercase;">Year</label>
                            <select id="report-year"
                                style="padding: 12px 20px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px; font-weight: 600; min-width: 120px; cursor: pointer;">
                                <option value="2026">2026</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>

                        <div style="border-left: 1px solid #E2E8F0; padding-left: 16px; display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="generateReport()"
                                style="background: #4F46E5; padding: 12px 24px;">
                                <i class="fas fa-chart-bar"></i> Generate Report
                            </button>

                            <button class="btn" onclick="setReportToLastMonth()" style="padding: 12px 16px;">
                                <i class="fas fa-calendar-minus"></i> Last Month
                            </button>
                        </div>
                    </div>

                    <!-- Export Options (visible after report generated) -->
                    <div id="report-export-options"
                        style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #E2E8F0;">
                        <label
                            style="display: block; font-size: 11px; font-weight: 700; color: #64748B; margin-bottom: 10px; text-transform: uppercase;">Export
                            Options</label>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn" onclick="emailReport()"
                                style="background: #3B82F6; color: white; border-color: #3B82F6; padding: 10px 20px;">
                                <i class="fas fa-envelope"></i> Email Report
                            </button>

                            <button class="btn" onclick="exportReportCSV()"
                                style="background: #10B981; color: white; border-color: #10B981; padding: 10px 20px;">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>

                            <button class="btn" onclick="printReportPDF()" style="padding: 10px 20px;">
                                <i class="fas fa-print"></i> Print / PDF
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Preview -->
                <div id="report-preview" style="display: none;">
                    <!-- Report content will be rendered here -->
                </div>

                <!-- Report Loading -->
                <div id="report-loading" style="display: none; text-align: center; padding: 60px;">
                    <div class="spinner" style="margin: 0 auto 20px;"></div>
                    <p style="color: #64748B; font-weight: 600;">Generating report...</p>
                </div>
            </div>


        </div>
    </div>


    <script>


        // ==========================================
        // üè¢ ENTERPRISE LOGIC ENGINE v9.9 PRO
        // ==========================================

        /**
         * üîß FRONTEND CONFIGURATION
         */
        const FRONTEND_CONFIG = Object.freeze({
            VERSION: '9.9.0',
            POLLING_INTERVAL_MS: 15000,
            DEBOUNCE_DELAY_MS: 300,
            TOAST_DURATION_MS: 4000,
            MAX_RETRIES: 3,
            RETRY_DELAY_MS: 1000
        });

        // Data State
        let RAW_DATA = [], DATE_DATA = [], DISPLAY_DATA = [];
        let CHARTS = {};

        /**
         * üõ°Ô∏è SECURITY: HTML Sanitization utility to prevent XSS
         */
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        /**
         * üîê ACCESSIBILITY: Focus Trap for Modals
         * Traps focus within a container for keyboard users
         */
        function trapFocus(container) {
            const focusableElements = container.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            function handleKeydown(e) {
                if (e.key !== 'Tab') return;

                if (e.shiftKey) {
                    if (document.activeElement === firstFocusable) {
                        e.preventDefault();
                        lastFocusable.focus();
                    }
                } else {
                    if (document.activeElement === lastFocusable) {
                        e.preventDefault();
                        firstFocusable.focus();
                    }
                }
            }

            container.addEventListener('keydown', handleKeydown);
            firstFocusable?.focus();

            return () => container.removeEventListener('keydown', handleKeydown);
        }

        /**
         * ‚úÖ CONFIRMATION DIALOG
         * Enterprise-grade confirmation before destructive actions
         */
        function showConfirmDialog(options) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay show';
                overlay.style.zIndex = '10000';

                const title = escapeHtml(options.title || 'Confirm Action');
                const message = escapeHtml(options.message || 'Are you sure?');
                const confirmText = escapeHtml(options.confirmText || 'Confirm');
                const cancelText = escapeHtml(options.cancelText || 'Cancel');
                const type = options.type || 'warning'; // danger, warning, info

                const iconMap = {
                    danger: '<i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>',
                    warning: '<i class="fas fa-exclamation-circle" style="color: var(--warning);"></i>',
                    info: '<i class="fas fa-info-circle" style="color: var(--info);"></i>'
                };

                overlay.innerHTML = `
            <div class="modal" style="max-width: 400px;" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title">
                <div class="modal-header">
                    <div class="modal-title" id="confirm-title">${iconMap[type]} ${title}</div>
                </div>
                <div class="modal-body">
                    <p style="margin: 0; font-size: 14px; color: var(--text-main);">${message}</p>
                </div>
                <div class="modal-footer">
                    <button class="btn" id="confirm-cancel">${cancelText}</button>
                    <button class="btn btn-primary" id="confirm-ok" style="background: var(--${type});">${confirmText}</button>
                </div>
            </div>
        `;

                document.body.appendChild(overlay);

                const cleanup = trapFocus(overlay.querySelector('.modal'));

                const handleConfirm = () => { cleanup(); overlay.remove(); resolve(true); };
                const handleCancel = () => { cleanup(); overlay.remove(); resolve(false); };

                overlay.querySelector('#confirm-ok').addEventListener('click', handleConfirm);
                overlay.querySelector('#confirm-cancel').addEventListener('click', handleCancel);
                overlay.addEventListener('click', (e) => { if (e.target === overlay) handleCancel(); });
                document.addEventListener('keydown', function escHandler(e) {
                    if (e.key === 'Escape') { handleCancel(); document.removeEventListener('keydown', escHandler); }
                });
            });
        }

        /**
         * üîÑ RETRY WRAPPER
         * Automatic retry with exponential backoff for failed API calls
         */
        async function withRetry(fn, retries = FRONTEND_CONFIG.MAX_RETRIES, delay = FRONTEND_CONFIG.RETRY_DELAY_MS) {
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    return await fn();
                } catch (error) {
                    if (attempt === retries) throw error;
                    await new Promise(r => setTimeout(r, delay * Math.pow(2, attempt - 1)));
                    console.warn(`Retry attempt ${attempt}/${retries}...`);
                }
            }
        }

        let CURRENT_FILTER_RANGE = 'all';
        let CURRENT_EDIT_TICKET = null;
        let CURRENT_VERSION = 0;
        let IS_POLLING = false;

        // ==========================================
        // üåô THEME TOGGLE SYSTEM
        // ==========================================

        /**
         * Toggle between light and dark themes
         * Persists preference to localStorage
         */
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            // Apply theme
            html.setAttribute('data-theme', newTheme);

            // Persist to localStorage
            localStorage.setItem('theme', newTheme);

            // Update label
            const label = document.getElementById('theme-label');
            if (label) {
                label.textContent = newTheme === 'dark' ? 'Dark Mode' : 'Light Mode';
            }

            // Haptic feedback
            if (typeof hapticFeedback === 'function') {
                hapticFeedback('light');
            }

            // Announce to screen readers
            if (typeof announceToScreenReader === 'function') {
                announceToScreenReader(`Theme changed to ${newTheme} mode`);
            }

            // Show toast notification
            if (typeof showToast === 'function') {
                showToast(newTheme === 'dark' ? 'üåô Dark mode enabled' : '‚òÄÔ∏è Light mode enabled', 'success', 2000);
            }

            console.log(`üé® Theme switched to: ${newTheme}`);
        }

        /**
         * Initialize theme based on:
         * 1. localStorage preference (if exists)
         * 2. System preference (prefers-color-scheme)
         * 3. Default to light mode
         */
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            let theme = 'light'; // Default

            if (savedTheme) {
                theme = savedTheme;
            } else if (systemPrefersDark) {
                theme = 'dark';
            }

            // Apply theme without transition initially
            document.documentElement.style.transition = 'none';
            document.documentElement.setAttribute('data-theme', theme);

            // Restore transitions after a brief delay
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    document.documentElement.style.transition = '';
                });
            });

            // Update label
            const label = document.getElementById('theme-label');
            if (label) {
                label.textContent = theme === 'dark' ? 'Dark Mode' : 'Light Mode';
            }

            console.log(`üé® Theme initialized: ${theme}`);
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            // Only auto-switch if user hasn't set a preference
            if (!localStorage.getItem('theme')) {
                const newTheme = e.matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);

                const label = document.getElementById('theme-label');
                if (label) {
                    label.textContent = newTheme === 'dark' ? 'Dark Mode' : 'Light Mode';
                }

                console.log(`üé® System theme changed to: ${newTheme}`);
            }
        });

        // Initialize theme on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTheme);
        } else {
            initTheme();
        }

        // ‚úÖ ADD THESE NEW LINES
        let PENDING_UPDATES = new Map(); // Track optimistic updates

        // ‚úÖ Structured View State (consolidated - single source of truth)
        let VIEW_STATE = {
            currentView: 'dash',
            filterType: 'status', // 'status' or 'agent'
            filterStatus: 'Total',
            filterAgent: null,
            currentTableBtn: null,
            preventAutoScroll: false
        };

        // PAGINATION SYSTEM
        let PAGINATION = {
            currentPage: 1,
            pageSize: 100,
            totalRows: 0,
            totalPages: 0,
            cache: new Map(),
            version: null,
            lastFetch: null,

            filters: {
                search: '',
                agent: 'all',
                status: 'all',
                dateStart: null,
                dateEnd: null
            },

            sort: {
                field: 'Date',
                order: 'desc'
            }
        };


        /* ==================================================
           üîî NOTIFICATION SYSTEM VARIABLES
           ================================================== */
        const NOTIFICATION_SETTINGS = {
            enabled: true,
            criticalAge: 15,
            warningAge: 7,
            soundEnabled: true,
            checkInterval: 300000
        };

        let LAST_NOTIFICATION_CHECK = 0;
        let NOTIFICATION_PERMISSION = 'default';

        /* ==================================================
           ‚å®Ô∏è KEYBOARD SHORTCUTS MAPPING
           ================================================== */
        const KEYBOARD_SHORTCUTS = {
            'Ctrl+K': { action: 'openCreateModal', description: 'Create New Ticket' },
            '/': { action: 'focusSearch', description: 'Quick Search' },
            'Escape': { action: 'closeAllModals', description: 'Close Modals' }
        };

        /* ==================================================
           üîê CSRF PROTECTION
           ================================================== */
        let CSRF_TOKEN = null;

        function fetchCSRFToken() {
            google.script.run
                .withSuccessHandler(function (res) {
                    try {
                        const result = JSON.parse(res);
                        if (result.success) {
                            CSRF_TOKEN = result.token;
                            console.log('üîê CSRF token loaded');
                        }
                    } catch (e) {
                        console.error('CSRF token parse error:', e);
                    }
                })
                .withFailureHandler(function (err) {
                    console.error('Failed to fetch CSRF token:', err);
                })
                .getCSRFToken();
        }

        // Fetch CSRF token on page load
        fetchCSRFToken();


        // ‚úÖ Performance Cache
        let AGENT_STATS_CACHE = null;


        /* ==================================================
           üîî SMART NOTIFICATION SYSTEM
           ================================================== */

        function requestNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        NOTIFICATION_PERMISSION = permission;
                        if (permission === 'granted') {
                            showToast('‚úÖ Desktop notifications enabled!', 'success');
                        }
                    });
                } else {
                    NOTIFICATION_PERMISSION = Notification.permission;
                }
            }
        }

        function showDesktopNotification(title, message, type = 'info') {
            if (!NOTIFICATION_SETTINGS.enabled) return;
            if (NOTIFICATION_PERMISSION !== 'granted') return;

            const icons = {
                critical: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23DC2626"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',
                warning: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23F59E0B"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>',
                success: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2310B981"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',
                info: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234F46E5"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>'
            };

            try {
                const notification = new Notification(title, {
                    body: message,
                    icon: icons[type],
                    badge: icons[type],
                    tag: `billfree-${type}-${Date.now()}`,
                    requireInteraction: type === 'critical',
                    silent: !NOTIFICATION_SETTINGS.soundEnabled
                });

                notification.onclick = function () {
                    window.focus();
                    this.close();
                    if (type === 'critical' || type === 'warning') {
                        nav('dash', document.querySelector('.nav-item'));
                    }
                };

                if (type !== 'critical') {
                    setTimeout(() => notification.close(), 10000);
                }

            } catch (e) {
                console.error('Notification error:', e);
            }
        }

        function checkTicketAlerts() {
            const now = Date.now();

            if (now - LAST_NOTIFICATION_CHECK < NOTIFICATION_SETTINGS.checkInterval) {
                return;
            }

            LAST_NOTIFICATION_CHECK = now;

            if (!DISPLAY_DATA || DISPLAY_DATA.length === 0) return;

            const criticalTickets = DISPLAY_DATA.filter(t =>
                t.ageDays >= NOTIFICATION_SETTINGS.criticalAge &&
                t.status.toLowerCase() === 'not completed'
            );

            if (criticalTickets.length > 0) {
                showDesktopNotification(
                    'üö® CRITICAL TICKETS!',
                    `You have ${criticalTickets.length} ticket${criticalTickets.length > 1 ? 's' : ''} older than ${NOTIFICATION_SETTINGS.criticalAge} days requiring immediate attention!`,
                    'critical'
                );
            }

            const warningTickets = DISPLAY_DATA.filter(t =>
                t.ageDays >= NOTIFICATION_SETTINGS.warningAge &&
                t.ageDays < NOTIFICATION_SETTINGS.criticalAge &&
                t.status.toLowerCase() === 'not completed'
            );

            if (warningTickets.length > 0 && criticalTickets.length === 0) {
                showDesktopNotification(
                    '‚ö†Ô∏è Aging Tickets Alert',
                    `${warningTickets.length} ticket${warningTickets.length > 1 ? 's are' : ' is'} approaching critical age (${NOTIFICATION_SETTINGS.warningAge}+ days old)`,
                    'warning'
                );
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            const existing = document.getElementById('toast-container');
            if (existing) existing.remove();

            const colors = {
                success: '#10B981',
                error: '#DC2626',
                warning: '#F59E0B',
                info: '#4F46E5'
            };

            const icons = {
                success: '‚úì',
                error: '‚úï',
                warning: '‚ö†',
                info: '‚Ñπ'
            };

            const toast = document.createElement('div');
            toast.id = 'toast-container';
            toast.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: white;
    color: #1E293B;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    font-size: 14px;
    border-left: 4px solid ${colors[type]};
    animation: slideInRight 0.3s ease-out;
    max-width: 400px;
  `;

            toast.innerHTML = `
    <span style="font-size: 20px;">${icons[type]}</span>
    <span>${message}</span>
  `;

            document.body.appendChild(toast);

            // üîä Also announce to screen readers
            if (type === 'error' || type === 'warning') {
                announceAlertToScreenReader(message);
            } else {
                announceToScreenReader(message);
            }

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        /* ==================================================
           üîä SCREEN READER ANNOUNCEMENT UTILITIES
           WCAG 2.1 AA Compliant - Live Region Support
           ================================================== */

        /**
         * Announces a message to screen readers using aria-live="polite"
         * Use for status updates that don't require immediate attention
         * @param {string} message - The message to announce
         */
        function announceToScreenReader(message) {
            const announcer = document.getElementById('status-announcer');
            if (announcer) {
                // Clear and re-set to trigger announcement
                announcer.textContent = '';
                // Small delay to ensure the DOM update is processed
                setTimeout(() => {
                    announcer.textContent = message;
                }, 50);
            }
        }

        /**
         * Announces a critical message to screen readers using aria-live="assertive"
         * Use for errors, warnings, or time-sensitive information
         * @param {string} message - The critical message to announce
         */
        function announceAlertToScreenReader(message) {
            const announcer = document.getElementById('alert-announcer');
            if (announcer) {
                // Clear and re-set to trigger announcement
                announcer.textContent = '';
                setTimeout(() => {
                    announcer.textContent = message;
                }, 50);
            }
        }

        /* ==================================================
           üéØ PREMIUM MICRO-INTERACTION UTILITIES v2.0
           ================================================== */

        /**
         * üî¢ Animate number counting with easing
         * @param {HTMLElement} element - Element to animate
         * @param {number} start - Starting value
         * @param {number} end - Ending value  
         * @param {number} duration - Animation duration in ms
         */
        function animateCount(element, start, end, duration = 600) {
            if (!element || start === end) return;

            const range = end - start;
            const startTime = performance.now();

            // Easing function (ease-out-expo)
            const easeOutExpo = t => t === 1 ? 1 : 1 - Math.pow(2, -10 * t);

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = easeOutExpo(progress);
                const current = Math.round(start + (range * eased));

                element.textContent = current;

                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    // Add pulse effect on complete
                    element.classList.add('counting');
                    setTimeout(() => element.classList.remove('counting'), 300);
                }
            }

            requestAnimationFrame(update);
        }

        /**
         * üîÑ Set button loading state (Enhanced v2.0)
         * Uses CSS-based spinner for smoother 60fps animation
         * @param {HTMLElement} button - Button element
         * @param {boolean} loading - Loading state
         * @param {string} loadingText - Text for screen readers while loading
         */
        function setButtonLoading(button, loading, loadingText = 'Processing...') {
            if (!button) return;

            if (loading) {
                // Store original state
                button.dataset.originalText = button.textContent;
                button.dataset.originalHtml = button.innerHTML;

                // Set loading state
                button.disabled = true;
                button.classList.add('is-loading');

                // Accessibility: Announce loading state
                button.setAttribute('aria-busy', 'true');
                button.setAttribute('aria-label', loadingText);

                // Screen reader announcement
                announceToScreenReader(loadingText);
            } else {
                // Remove loading state
                button.disabled = false;
                button.classList.remove('is-loading');

                // Restore original state
                button.removeAttribute('aria-busy');
                if (button.dataset.originalText) {
                    button.setAttribute('aria-label', button.dataset.originalText);
                }

                if (button.dataset.originalHtml) {
                    button.innerHTML = button.dataset.originalHtml;
                    delete button.dataset.originalHtml;
                    delete button.dataset.originalText;
                }
            }
        }

        /**
         * ‚ôø FOCUS TRAP for Modals (Accessibility)
         * Traps keyboard focus within a container
         * @param {HTMLElement} container - The modal container
         * @returns {Function} Cleanup function to remove event listeners
         */
        function trapFocus(container) {
            if (!container) return () => { };

            const focusableSelectors = [
                'button:not([disabled])',
                'a[href]',
                'input:not([disabled])',
                'select:not([disabled])',
                'textarea:not([disabled])',
                '[tabindex]:not([tabindex="-1"])'
            ].join(', ');

            const focusableElements = container.querySelectorAll(focusableSelectors);
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            // Focus first element
            if (firstElement) {
                setTimeout(() => firstElement.focus(), 50);
            }

            function handleKeyDown(e) {
                if (e.key !== 'Tab') return;

                if (e.shiftKey) {
                    // Shift + Tab: going backwards
                    if (document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement?.focus();
                    }
                } else {
                    // Tab: going forwards
                    if (document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement?.focus();
                    }
                }
            }

            function handleEscape(e) {
                if (e.key === 'Escape') {
                    // Find and click close button
                    const closeBtn = container.querySelector('.modal-close, [data-dismiss="modal"]');
                    if (closeBtn) closeBtn.click();
                }
            }

            container.addEventListener('keydown', handleKeyDown);
            container.addEventListener('keydown', handleEscape);

            // Return cleanup function
            return function releaseFocusTrap() {
                container.removeEventListener('keydown', handleKeyDown);
                container.removeEventListener('keydown', handleEscape);
            };
        }

        /**
         * üî≤ Generate table skeleton HTML
         * @param {number} rows - Number of skeleton rows
         * @param {number} cols - Number of columns
         * @returns {string} HTML string for table skeleton
         */
        function generateTableSkeleton(rows = 5, cols = 6) {
            let html = '<div class="table-skeleton">';
            for (let i = 0; i < rows; i++) {
                html += '<div class="skeleton-row">';
                for (let j = 0; j < cols; j++) {
                    const width = j === 0 ? 'short' : (j === cols - 1 ? 'short' : 'medium');
                    html += `<div class="skeleton skeleton-text ${width}"></div>`;
                }
                html += '</div>';
            }
            html += '</div>';
            return html;
        }

        /**
         * üåä Create ripple effect on element
         * @param {Event} event - Click event
         */
        function createRipple(event) {
            const button = event.currentTarget;
            const circle = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - button.offsetLeft - radius}px`;
            circle.style.top = `${event.clientY - button.offsetTop - radius}px`;
            circle.classList.add('ripple-circle');

            const ripple = button.getElementsByClassName('ripple-circle')[0];
            if (ripple) ripple.remove();

            button.appendChild(circle);

            setTimeout(() => circle.remove(), 600);
        }

        /**
         * üì≥ Simulate haptic feedback (for mobile devices)
         */
        function hapticFeedback(type = 'light') {
            if (!navigator.vibrate) return;

            const patterns = {
                light: [10],
                medium: [25],
                heavy: [50],
                success: [10, 50, 10],
                error: [50, 50, 50],
                warning: [30, 30]
            };

            navigator.vibrate(patterns[type] || patterns.light);
        }

        /**
         * ‚ú® Add stagger animation to children
         * @param {HTMLElement} container - Parent container
         * @param {string} animationClass - CSS animation class
         * @param {number} delay - Delay between children in ms
         */
        function staggerChildren(container, animationClass = 'fade-in', delay = 50) {
            if (!container) return;

            const children = container.children;
            Array.from(children).forEach((child, index) => {
                child.style.animationDelay = `${index * delay}ms`;
                child.classList.add(animationClass);
            });
        }

        /**
         * üîî Premium toast with haptic and animation
         */
        function showPremiumToast(message, type = 'info', duration = 3000) {
            hapticFeedback(type === 'error' ? 'error' : type === 'success' ? 'success' : 'light');
            showToast(message, type, duration);
        }

        /**
         * üé≠ Smooth element visibility toggle
         */
        function smoothToggle(element, show) {
            if (!element) return;

            if (show) {
                element.style.display = 'block';
                element.style.opacity = '0';
                element.style.transform = 'translateY(10px)';

                requestAnimationFrame(() => {
                    element.style.transition = 'all 0.3s var(--ease-decelerate)';
                    element.style.opacity = '1';
                    element.style.transform = 'translateY(0)';
                });
            } else {
                element.style.transition = 'all 0.2s var(--ease-accelerate)';
                element.style.opacity = '0';
                element.style.transform = 'translateY(-10px)';

                setTimeout(() => {
                    element.style.display = 'none';
                }, 200);
            }
        }

        /**
         * üéØ Add click with visual feedback
         */
        function addPremiumClick(element, callback) {
            if (!element) return;

            element.addEventListener('click', function (e) {
                // Visual feedback
                this.style.transform = 'scale(0.96)';

                // Haptic
                hapticFeedback('light');

                // Reset
                setTimeout(() => {
                    this.style.transform = '';
                }, 100);

                // Execute callback
                if (callback) callback(e);
            });
        }

        // ‚úÖ Apply counting animation to KPI values when updating
        const originalUpdateKPIs = {};

        /**
         * üî¢ Update KPI with counting animation
         */
        function updateKPIWithAnimation(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const currentValue = parseInt(element.textContent) || 0;
            if (currentValue !== newValue) {
                animateCount(element, currentValue, newValue, 500);
            }
        }

        // Add ripple effect style dynamically
        const rippleStyle = document.createElement('style');
        rippleStyle.textContent = `
    .ripple-circle {
        position: absolute;
        border-radius: 50%;
        transform: scale(0);
        animation: ripple-effect 0.6s linear;
        background: rgba(255, 255, 255, 0.4);
        pointer-events: none;
    }
    
    @keyframes ripple-effect {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }
    
    /* Premium fade-in class */
    .fade-in {
        animation: premiumFadeIn 0.4s var(--ease-decelerate) backwards;
    }
    
    @keyframes premiumFadeIn {
        from {
            opacity: 0;
            transform: translateY(15px);
        }
    }
    
    /* Button press effect */
    .btn:active,
    .action-btn:active,
    .pill:active {
        transform: scale(0.97) !important;
        transition-duration: 0.05s !important;
    }
    
    /* Smooth height transition for containers */
    .smooth-height {
        transition: max-height 0.3s var(--ease-standard),
                    opacity 0.3s var(--ease-standard);
        overflow: hidden;
    }
`;
        document.head.appendChild(rippleStyle);

        /**
         * Announces page or view changes to screen readers
         * @param {string} viewName - The name of the new view/page
         */
        function announceViewChange(viewName) {
            announceToScreenReader(`Navigated to ${viewName}`);
        }

        /**
         * Announces data loading status
         * @param {string} status - 'loading', 'loaded', or 'error'
         * @param {string} context - What is being loaded (e.g., 'tickets', 'report')
         */
        function announceLoadingStatus(status, context = 'data') {
            const messages = {
                loading: `Loading ${context}, please wait...`,
                loaded: `${context} loaded successfully`,
                error: `Failed to load ${context}`
            };
            announceToScreenReader(messages[status] || status);
        }


        function toggleNotificationSettings() {
            const existingPanel = document.getElementById('notification-settings-panel');

            if (existingPanel) {
                existingPanel.remove();
                return;
            }

            const panel = document.createElement('div');
            panel.id = 'notification-settings-panel';
            panel.style.cssText = `
    position: fixed;
    top: 70px;
    right: 20px;
    background: white;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 9999;
    min-width: 320px;
    border: 1px solid #E2E8F0;
  `;

            panel.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0; font-size: 16px; font-weight: 700;">üîî Notification Settings</h3>
      <span onclick="this.parentElement.parentElement.remove()" style="cursor: pointer; font-size: 24px; color: #64748B;">&times;</span>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 16px;">
      <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
        <input type="checkbox" id="notif-enabled" ${NOTIFICATION_SETTINGS.enabled ? 'checked' : ''} 
          onchange="NOTIFICATION_SETTINGS.enabled = this.checked; saveNotificationSettings();">
        <span style="font-size: 13px; font-weight: 600;">Enable Notifications</span>
      </label>
      
      <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
        <input type="checkbox" id="notif-sound" ${NOTIFICATION_SETTINGS.soundEnabled ? 'checked' : ''}
          onchange="NOTIFICATION_SETTINGS.soundEnabled = this.checked; saveNotificationSettings();">
        <span style="font-size: 13px; font-weight: 600;">Enable Sound</span>
      </label>
      
      <div>
        <label style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748B; display: block; margin-bottom: 6px;">
          Critical Age (days)
        </label>
        <input type="number" id="notif-critical-age" value="${NOTIFICATION_SETTINGS.criticalAge}" 
          min="1" max="30" 
          onchange="NOTIFICATION_SETTINGS.criticalAge = parseInt(this.value); saveNotificationSettings();"
          style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 14px;">
      </div>
      
      <div>
        <label style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748B; display: block; margin-bottom: 6px;">
          Warning Age (days)
        </label>
        <input type="number" id="notif-warning-age" value="${NOTIFICATION_SETTINGS.warningAge}" 
          min="1" max="30"
          onchange="NOTIFICATION_SETTINGS.warningAge = parseInt(this.value); saveNotificationSettings();"
          style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 14px;">
      </div>
      
      <button onclick="requestNotificationPermission(); showToast('Notification permission requested', 'info');" 
        style="padding: 10px; background: #4F46E5; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
        ${NOTIFICATION_PERMISSION === 'granted' ? '‚úì Permissions Granted' : 'Grant Permissions'}
      </button>
      
      <button onclick="checkTicketAlerts(); showToast('Alert check triggered', 'info');"
        style="padding: 10px; background: #10B981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
        Test Notifications
      </button>
    </div>
    
    <div style="margin-top: 16px; padding: 12px; background: #F8FAFC; border-radius: 8px; font-size: 11px; color: #64748B;">
      <strong>Status:</strong> ${NOTIFICATION_PERMISSION === 'granted' ? '‚úÖ Enabled' : '‚ùå Disabled'}<br>
      Last check: ${LAST_NOTIFICATION_CHECK ? new Date(LAST_NOTIFICATION_CHECK).toLocaleTimeString() : 'Never'}
    </div>
  `;

            document.body.appendChild(panel);
        }

        function saveNotificationSettings() {
            localStorage.setItem('BF_NOTIFICATION_SETTINGS', JSON.stringify(NOTIFICATION_SETTINGS));
            showToast('Settings saved', 'success', 2000);
        }

        function loadNotificationSettings() {
            const saved = localStorage.getItem('BF_NOTIFICATION_SETTINGS');
            if (saved) {
                Object.assign(NOTIFICATION_SETTINGS, JSON.parse(saved));
            }
        }

        // DEBOUNCE UTILITY FOR SEARCH
        function debounce(func, delay = 300) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                const context = this;
                timeoutId = setTimeout(() => func.apply(context, args), delay);
            };
        }


        /* ==================================================
           ‚å®Ô∏è KEYBOARD SHORTCUTS SYSTEM
           ================================================== */

        document.addEventListener('keydown', (e) => {
            const isInputField = ['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName);


            let combo = '';
            if (e.altKey) combo += 'Alt+';
            if (e.ctrlKey) combo += 'Ctrl+';
            if (e.shiftKey) combo += 'Shift+';

            const key = e.key.length === 1 ? e.key.toUpperCase() : e.key;
            combo += key;

            const shortcut = KEYBOARD_SHORTCUTS[combo];

            if (shortcut) {
                if (combo === '/' && isInputField) return;

                e.preventDefault();

                if (typeof shortcut.action === 'function') {
                    shortcut.action();
                } else if (typeof window[shortcut.action] === 'function') {
                    window[shortcut.action]();
                }

                showShortcutFeedback(combo, shortcut.description);
            }
        });


        function showShortcutFeedback(combo, description) {
            const existing = document.getElementById('shortcut-feedback');
            if (existing) existing.remove();

            const feedback = document.createElement('div');
            feedback.id = 'shortcut-feedback';
            feedback.style.cssText = `
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 24px;
    border-radius: 30px;
    font-size: 13px;
    font-weight: 700;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    z-index: 10001;
    animation: shortcutPulse 0.5s ease-out;
    display: flex;
    align-items: center;
    gap: 12px;
  `;

            feedback.innerHTML = `
    <kbd style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; font-size: 11px;">${combo}</kbd>
    <span>${description}</span>
  `;

            document.body.appendChild(feedback);

            setTimeout(() => {
                feedback.style.animation = 'shortcutFadeOut 0.3s ease-out';
                setTimeout(() => feedback.remove(), 300);
            }, 1500);
        }

        function focusSearch() {
            const searchInputs = [
                document.querySelector('#table-scroll-target input[placeholder*="Search"]'),
                document.querySelector('.filter-bar input[type="text"]'),
                document.querySelector('input[placeholder*="search"]')
            ];

            const searchInput = searchInputs.find(input => input && input.offsetParent !== null);

            if (searchInput) {
                searchInput.focus();
                searchInput.select();
                showToast('üîç Search activated', 'info', 1500);
            }
        }

        function closeAllModals() {
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(modal => modal.classList.remove('show'));

            const settingsPanel = document.getElementById('notification-settings-panel');
            if (settingsPanel) settingsPanel.remove();

            const shortcutsPanel = document.getElementById('shortcuts-panel');
            if (shortcutsPanel) shortcutsPanel.remove();

            showToast('All modals closed', 'info', 1500);
        }

        // ‚úÖ NEW: Show keyboard shortcuts panel
        function showKeyboardShortcuts() {
            const existingPanel = document.getElementById('shortcuts-panel');
            if (existingPanel) {
                existingPanel.remove();
                return;
            }

            const panel = document.createElement('div');
            panel.id = 'shortcuts-panel';
            panel.style.cssText = `
    position: fixed;
    top: 70px;
    right: 20px;
    background: white;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 9999;
    min-width: 280px;
    border: 1px solid #E2E8F0;
  `;

            const shortcuts = Object.entries(KEYBOARD_SHORTCUTS).map(([key, val]) =>
                `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #E2E8F0;">
      <kbd style="background:#F1F5F9; padding:4px 8px; border-radius:4px; font-size:12px;">${key}</kbd>
      <span style="font-size:13px; color:#475569;">${val.description}</span>
    </div>`
            ).join('');

            panel.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3 style="margin:0; font-size:16px; font-weight:700;">‚å®Ô∏è Keyboard Shortcuts</h3>
      <span onclick="this.parentElement.parentElement.remove()" style="cursor:pointer; font-size:24px; color:#64748B;">&times;</span>
    </div>
    ${shortcuts}
    <div style="margin-top:12px; font-size:11px; color:#94A3B8;">
      Press <kbd style="background:#F1F5F9; padding:2px 4px; border-radius:2px;">Escape</kbd> to close all modals
    </div>
  `;

            document.body.appendChild(panel);
        }

        // Add animation styles
        const shortcutStyles = document.createElement('style');
        shortcutStyles.textContent = `
  @keyframes shortcutPulse {
    0% {
      transform: translate(-50%, 20px);
      opacity: 0;
      scale: 0.9;
    }
    100% {
      transform: translate(-50%, 0);
      opacity: 1;
      scale: 1;
    }
  }
  
  @keyframes shortcutFadeOut {
    to {
      opacity: 0;
      transform: translate(-50%, -10px);
    }
  }
  
  @keyframes slideInRight {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }
  
  kbd {
    font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
  }
`;
        document.head.appendChild(shortcutStyles);

        // ==========================================
        // ‚úÖ INITIALIZATION WITH VERSION POLLING
        // ==========================================
        let CURRENT_USER_EMAIL = ''; // Global variable

        window.onload = function () {
            loadNotificationSettings();
            requestNotificationPermission();

            // Initialize report month/year selectors
            initReportSelectors();


            // 1. ‚úÖ Fetch User Email with proper JSON parsing
            google.script.run
                .withSuccessHandler(response => {
                    try {
                        const result = JSON.parse(response);
                        if (result.success) {
                            CURRENT_USER_EMAIL = result.email;
                            console.log("‚úÖ Logged in as:", CURRENT_USER_EMAIL);
                        } else {
                            console.warn("‚ö†Ô∏è Could not fetch user email");
                            CURRENT_USER_EMAIL = '';
                        }
                    } catch (e) {
                        console.error("‚ùå Error parsing user email:", e);
                        CURRENT_USER_EMAIL = '';
                    }
                })
                .withFailureHandler(err => {
                    console.error("‚ùå Failed to fetch user email:", err);
                    CURRENT_USER_EMAIL = '';
                })
                .getCurrentUserEmail();

            renderTicketsTablePaginated(1);
            startVersionPolling();
            setInterval(() => {
                PAGINATION.cache.clear();
                renderTicketsTablePaginated(PAGINATION.currentPage);
            }, 300000);
            setInterval(checkTicketAlerts, 300000);

        };




        // ==========================================
        // üõ†Ô∏è MODAL LOGIC (UPDATES & CREATION)
        // ==========================================

        function openReasonModalSafe(btn) {
            // üõ°Ô∏è Safe wrapper for update button
            const ticketId = btn.getAttribute('data-ticket-id');
            const ticket = RAW_DATA.find(t => String(t.id).trim() === String(ticketId).trim());

            if (!ticket) {
                showToast('Error: Ticket not found', 'error');
                return;
            }

            // Populate Info
            const infoDiv = document.getElementById('modal-ticket-info');
            if (infoDiv) {
                infoDiv.innerHTML = `
            <div style="font-weight:700; color:#1E293B; margin-bottom:4px;">${escapeHtml(ticket.business)}</div>
            <div style="font-size:12px; color:#64748B; display:flex; gap:8px;">
                <span style="background:#F1F5F9; padding:2px 6px; border-radius:4px;">#${ticket.id}</span>
                <span style="background:#F1F5F9; padding:2px 6px; border-radius:4px;">${escapeHtml(ticket.concern)}</span>
                <span style="background:#F1F5F9; padding:2px 6px; border-radius:4px;">${escapeHtml(ticket.agent)}</span>
            </div>
        `;
            }

            // Set Status
            const statusSelect = document.getElementById('modal-status-select');
            if (statusSelect) {
                // Find matching option case-insensitive
                const opts = Array.from(statusSelect.options);
                const match = opts.find(o => o.value.toLowerCase() === (ticket.status || '').toLowerCase());
                statusSelect.value = match ? match.value : 'Not Completed';
            }

            // Previous Reasons
            const reasonPreview = document.getElementById('existing-reason-preview');
            const reasonText = document.getElementById('existing-reason-text');
            if (reasonPreview && reasonText) {
                if (ticket.reason && ticket.reason.trim()) {
                    reasonText.textContent = ticket.reason;
                    reasonPreview.style.display = 'block';
                } else {
                    reasonPreview.style.display = 'none';
                }
            }

            // Clear current reason input
            const reasonInput = document.getElementById('reason-input');
            if (reasonInput) reasonInput.value = '';

            // Show Modal
            const modal = document.getElementById('reason-modal');
            if (modal) {
                modal.classList.add('show');
                modal.setAttribute('data-current-ticket', ticket.id);
                trapFocus(modal);
            }
        }

        function closeReasonModal() {
            const modal = document.getElementById('reason-modal');
            if (modal) {
                modal.classList.remove('show');
                modal.removeAttribute('data-current-ticket');
            }
        }

        function submitStatusAndReason() {
            const modal = document.getElementById('reason-modal');
            const ticketId = modal.getAttribute('data-current-ticket');
            const statusSelect = document.getElementById('modal-status-select');
            const reasonInput = document.getElementById('reason-input');

            if (!ticketId) return;

            const status = statusSelect.value;
            const reason = reasonInput.value.trim();

            const btn = modal.querySelector('.btn-primary');
            setButtonLoading(btn, true, 'Updating...');

            google.script.run
                .withSuccessHandler(res => {
                    setButtonLoading(btn, false);
                    try {
                        const result = JSON.parse(res);
                        if (result.success) {
                            showPremiumToast('Ticket updated successfully', 'success');
                            closeReasonModal();

                            // Optimistic update
                            const ticket = RAW_DATA.find(t => String(t.id) === String(ticketId));
                            if (ticket) {
                                ticket.status = status;
                                if (reason) {
                                    const timestamp = new Date().toLocaleString();
                                    ticket.reason = ticket.reason ? ticket.reason + '\n[' + timestamp + '] ' + reason : '[' + timestamp + '] ' + reason;
                                }
                            }
                            if (typeof refreshAll === 'function') {
                                refreshAll(true); // Silent refresh
                            } else if (typeof fetchData === 'function') {
                                fetchData();
                            }

                        } else {
                            showPremiumToast('Update failed: ' + result.error, 'error');
                        }
                    } catch (e) {
                        showPremiumToast('Error parsing response', 'error');
                    }
                })
                .withFailureHandler(err => {
                    setButtonLoading(btn, false);
                    showPremiumToast('Network error', 'error');
                })
                .updateTicketStatus(ticketId, status, reason);
        }

        function updateReasonRequirement() {
            // Optional: make reason mandatory for certain statuses
        }

        // === CREATE MODAL ===

        function openCreateModal() {
            const modal = document.getElementById('create-ticket-modal');
            if (modal) {
                modal.classList.add('show');
                trapFocus(modal);
            }
        }

        function closeCreateModal() {
            const modal = document.getElementById('create-ticket-modal');
            if (modal) modal.classList.remove('show');
            // Reset inputs
            const inputs = modal.querySelectorAll('input, textarea, select');
            inputs.forEach(i => i.value = i.defaultValue || '');
        }

        function submitNewTicket() {
            const business = document.getElementById('new-business').value;
            const agent = document.getElementById('new-agent').value;
            const concern = document.getElementById('new-concern').value;
            const remark = document.getElementById('new-remark').value;

            if (!business || !agent || !concern) {
                showPremiumToast('Please fill required fields (*)', 'warning');
                return;
            }

            const btn = document.querySelector('#create-ticket-modal .btn-primary');
            setButtonLoading(btn, true, 'Creating...');

            const ticketData = {
                email: document.getElementById('new-email').value,
                agent: agent,
                requestedBy: document.getElementById('new-requested').value,
                mid: document.getElementById('new-mid').value,
                business: business,
                phone: document.getElementById('new-phone').value,  // ‚ú® NEW: Phone field
                pos: document.getElementById('new-pos').value,
                supportType: document.getElementById('new-support-type').value,
                concern: concern,
                config: document.getElementById('new-config').value,
                remark: remark,
                status: document.getElementById('new-status').value || 'Not Completed',
                reason: document.getElementById('new-reason').value
            };

            google.script.run
                .withSuccessHandler(res => {
                    setButtonLoading(btn, false);
                    try {
                        const result = JSON.parse(res);
                        if (result.success) {
                            showPremiumToast('Ticket created! ID: ' + result.ticketId, 'success');
                            closeCreateModal();
                            if (typeof fetchData === 'function') fetchData();
                        } else {
                            showPremiumToast('Creation failed: ' + result.error, 'error');
                        }
                    } catch (e) {
                        showPremiumToast('Error parsing response', 'error');
                    }
                })
                .withFailureHandler(err => {
                    setButtonLoading(btn, false);
                    showPremiumToast('Network error', 'error');
                })
                .createNewTicket(ticketData);
        }

        function toggleReasonField() {
            const status = document.getElementById('new-status').value;
            const container = document.getElementById('reason-field-container');
            if (container) {
                if (status === 'Completed' || status === 'Closed' || status === "Can't Do") {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            }
        }

        function updateConcernList() {
            // Helper to update dynamic concerns
        }

        function setupEventListeners() {
            // ESC key closes modals
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeReasonModal();
                    closeCreateModal();
                }
            });

            // Click overlay to close modals
            const reasonModal = document.getElementById('reason-modal');
            if (reasonModal) {
                reasonModal.addEventListener('click', function (e) {
                    if (e.target === this) closeReasonModal();
                });
            }

            const createModal = document.getElementById('create-ticket-modal');
            if (createModal) {
                createModal.addEventListener('click', function (e) {
                    if (e.target === this) closeCreateModal();
                });

            }
            // ============================================================
            // KEYBOARD SHORTCUTS FOR STATUS DROPDOWNS
            // ============================================================
            const statusSelects = [
                document.getElementById('modal-status-select'),
                document.getElementById('new-status')
            ];

            statusSelects.forEach(select => {
                if (select) {
                    // Keyboard shortcuts
                    select.addEventListener('keydown', function (e) {
                        const key = e.key.toLowerCase();

                        // Prevent default browser behavior for our shortcuts
                        if (['n', 'c', 'x', 'd'].includes(key)) {
                            e.preventDefault();

                            if (key === 'n') {
                                this.value = 'Not Completed';
                                showToast('‚úì Status: Not Completed', 'info', 1500);
                            }
                            else if (key === 'c') {
                                this.value = 'Completed';
                                showToast('‚úì Status: Completed', 'success', 1500);
                            }
                            else if (key === 'x') {
                                this.value = 'Closed';
                                showToast('‚úì Status: Closed', 'info', 1500);
                            }
                            else if (key === 'd') {
                                this.value = 'Can\'t Do';
                                showToast('‚úì Status: Can\'t Do', 'warning', 1500);
                            }

                            // Trigger change event to update reason field visibility
                            const changeEvent = new Event('change', { bubbles: true });
                            this.dispatchEvent(changeEvent);
                        }
                    });
                }
            });
        }

        // ‚úÖ OPTIMIZED Version Polling with Visibility-Based Pausing
        let pollingIntervalId = null;
        const POLLING_INTERVAL_MS = 30000; // 30 seconds (was 10s)

        function startVersionPolling() {
            // Clear any existing interval
            if (pollingIntervalId) {
                clearInterval(pollingIntervalId);
            }

            pollingIntervalId = setInterval(function () {
                // Skip if tab is hidden or already polling
                if (document.hidden || IS_POLLING) {
                    if (document.hidden) {
                        console.log('‚è∏Ô∏è Polling paused - tab is hidden');
                    }
                    return;
                }

                IS_POLLING = true;

                google.script.run
                    .withSuccessHandler(function (res) {
                        IS_POLLING = false;
                        try {
                            const result = JSON.parse(res);
                            if (result.success && result.version > CURRENT_VERSION) {
                                console.log(`üîÑ Update detected: v${CURRENT_VERSION} ‚Üí v${result.version}`);
                                fetchData();
                            }
                        } catch (e) {
                            console.error('‚ùå Version check parse error:', e);
                        }
                    })
                    .withFailureHandler(function (err) {
                        IS_POLLING = false;
                        console.log('‚ö†Ô∏è Version check failed:', err);
                    })
                    .checkVersion();
            }, POLLING_INTERVAL_MS);

            // Resume polling immediately when tab becomes visible again
            document.addEventListener('visibilitychange', function () {
                if (!document.hidden && !IS_POLLING) {
                    console.log('‚ñ∂Ô∏è Tab visible - checking for updates');
                    // Immediate check when tab becomes visible
                    google.script.run
                        .withSuccessHandler(function (res) {
                            try {
                                const result = JSON.parse(res);
                                if (result.success && result.version > CURRENT_VERSION) {
                                    fetchData();
                                }
                            } catch (e) { }
                        })
                        .withFailureHandler(function () { })
                        .checkVersion();
                }
            });
        }



        function fetchData() {
            // ‚ôø Announce loading state
            announceToScreenReader('Loading ticket data...');

            google.script.run
                .withSuccessHandler(init)
                .withFailureHandler(function (err) {
                    console.error('‚ùå Data fetch failed:', err);
                    document.getElementById('loader').style.display = 'none';

                    // ‚ôø Accessible error handling - no alert()
                    showToast('Failed to load data. Please refresh the page.', 'error', 5000);
                    announceAlertToScreenReader('Error: Failed to load data. Please refresh the page.');
                })
                .getTicketData();
        }

        function init(res) {
            const json = JSON.parse(res);
            if (!json.success) {
                // ‚ôø Accessible error handling - no alert()
                showToast('‚ùå Error loading data: ' + json.error, 'error', 5000);
                announceAlertToScreenReader('Error loading data: ' + json.error);
                return;
            }

            RAW_DATA = json.tickets;

            // ‚úÖ CHECK FOR NEW DATA AND SHOW TOAST
            const newVersion = json.version || 0;
            if (CURRENT_VERSION > 0 && newVersion > CURRENT_VERSION) {
                showToast('üîÑ Data updated automatically', 'info', 2000);
            }
            CURRENT_VERSION = newVersion; // ‚úÖ Track version

            const pills = document.querySelectorAll('.pill');
            let activePill = null;
            pills.forEach(p => {
                const text = p.innerText.toLowerCase().replace(' ', '');
                const target = CURRENT_FILTER_RANGE.replace('days', '');
                if (text.includes(target)) activePill = p;
                if (CURRENT_FILTER_RANGE === 'all' && p.innerText === 'All Time') activePill = p;
            });

            if (!activePill) activePill = pills[0];
            applyDateFilter(CURRENT_FILTER_RANGE, activePill, true);

            document.getElementById('loader').style.display = 'none';

            // ‚úÖ CHECK FOR ALERTS AFTER DATA LOADS
            checkTicketAlerts();
        }


        // ==========================================
        // üóìÔ∏è DATE FILTERS
        // ==========================================
        function applyDateFilter(range, btn, silent = false) {
            CURRENT_FILTER_RANGE = range;

            if (btn) {
                document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            document.getElementById('custom-range-box').classList.remove('show');

            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

            if (range === 'all') DATE_DATA = RAW_DATA;
            else if (range === 'today') DATE_DATA = RAW_DATA.filter(t => t.sortDate >= todayStart);
            else if (range === 'yesterday') {
                const yest = todayStart - 864e5;
                DATE_DATA = RAW_DATA.filter(t => t.sortDate >= yest && t.sortDate < todayStart);
            }
            else if (range === '7days') DATE_DATA = RAW_DATA.filter(t => t.sortDate >= (todayStart - 7 * 864e5));
            else if (range === '30days') DATE_DATA = RAW_DATA.filter(t => t.sortDate >= (todayStart - 30 * 864e5));

            refreshAll(silent);
        }

        function toggleCustomRange(btn) {
            document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('custom-range-box').classList.add('show');
        }

        function applyCustomDate() {
            const s = document.getElementById('start-date').valueAsNumber;
            const e = document.getElementById('end-date').valueAsNumber;
            if (!s || !e) return alert('Select both start and end dates');
            CURRENT_FILTER_RANGE = 'custom';
            DATE_DATA = RAW_DATA.filter(t => t.sortDate >= s && t.sortDate < (e + 864e5));
            refreshAll(false);
        }

        function refreshAll(silent) {
            AGENT_STATS_CACHE = null; // ‚úÖ Invalidate cache

            renderKPIs();
            renderDashboardAgents();

            // ‚úÖ Restore correct filter context
            if (VIEW_STATE.filterType === 'agent') {
                filterByAgent(VIEW_STATE.filterAgent, VIEW_STATE.filterStatus);
            } else {
                if (VIEW_STATE.currentTableBtn) {
                    filterTable(VIEW_STATE.filterStatus, VIEW_STATE.currentTableBtn, true);
                } else {
                    filterTable('Total', document.querySelector('.kpi-card'), silent);
                }
            }

            // Refresh other views if active
            if (!document.getElementById('view-team').classList.contains('hidden')) renderDetailedTeamReport();
            if (!document.getElementById('view-analytics').classList.contains('hidden')) {
                setTimeout(() => renderAnalytics(), 100); // ‚úÖ Delay for DOM update
            }
        }

        // ==========================================
        // üìä KPI METRICS
        // ==========================================
        function renderKPIs() {
            let s = { total: 0, comp: 0, not: 0, closed: 0, cant: 0 };
            DATE_DATA.forEach(t => {
                s.total++;
                const st = t.status.toLowerCase();
                if (st === 'completed') s.comp++;
                else if (st === 'closed') s.closed++;
                else if (st.includes("can't") || st.includes('cant') || st.includes("can‚Äôt")) s.cant++;
                else s.not++;
            });
            ['total', 'comp', 'not', 'closed', 'cant'].forEach(k => {
                const el = document.getElementById('k-' + k);
                if (el) el.innerText = s[k];
            });
        }

        // ==========================================
        // ‚úÖ CACHED AGENT STATS (PERFORMANCE FIX)
        // ==========================================
        function getAgentStats(forceRefresh = false) {
            if (!forceRefresh && AGENT_STATS_CACHE && AGENT_STATS_CACHE.version === CURRENT_VERSION) {
                return AGENT_STATS_CACHE.data;
            }

            const agents = {};
            DATE_DATA.forEach(t => {
                if (!agents[t.agent]) {
                    agents[t.agent] = {
                        name: t.agent,
                        total: 0,
                        comp: 0,
                        not: 0,
                        closed: 0,
                        validClosed: 0,
                        cant: 0,
                        invalidClosed: 0,
                        pendingOld: 0,
                        score: 0,
                        completion: 0
                    };
                }

                const a = agents[t.agent];
                a.total++;
                const st = t.status.toLowerCase();

                if (st === 'completed') {
                    a.comp++;
                } else if (st === 'closed') {
                    a.closed++;
                    if (!t.invalidClosed) {
                        a.validClosed++;
                    } else {
                        a.invalidClosed++;
                    }
                } else if (st.includes("can't") || st.includes('cant') || st.includes("can‚Äôt")) {
                    a.cant++;
                } else {
                    a.not++;
                }

                if (t.ageDays > 7 && st !== 'completed' && st !== 'closed') {
                    a.pendingOld++;
                }
            });

            Object.values(agents).forEach(a => {
                // ‚úÖ UPDATED SCORING
                a.score = (a.comp * 10) + (a.validClosed * 0) - (a.cant * 5) - (a.invalidClosed * 10) - (a.pendingOld * 3);

                a.completionRate = a.total ? Math.round((a.comp + a.validClosed) / a.total * 100) : 0;

                // üî• ADD THIS - Extract recent tickets with phone numbers
                a.recentTicketsWithPhone = DATE_DATA
                    .filter(t => t.agent === a.name && t.phone && t.phone.trim() !== '')
                    .sort((a, b) => b.sortDate - a.sortDate)
                    .slice(0, 3);
            });

            const result = Object.values(agents).sort((a, b) => b.score - a.score);

            AGENT_STATS_CACHE = { version: CURRENT_VERSION, data: result };
            return result;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PAGINATION SYSTEM - FETCH, RENDER, AND CONTROL FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function fetchTicketsPage(page = 1, forceRefresh = false) {
            const config = {
                page: page,
                pageSize: PAGINATION.pageSize,
                filters: PAGINATION.filters,
                sort: PAGINATION.sort
            };

            const cacheKey = JSON.stringify(config);

            if (!forceRefresh && PAGINATION.cache.has(cacheKey)) {
                console.log('üì¶ Cache HIT for page', page);
                const cached = PAGINATION.cache.get(cacheKey);
                updatePaginationState(cached);
                return cached;
            }

            showTableLoadingSkeleton();
            console.log('üåê Fetching page', page, 'from server...');
            console.log('üìã Config:', config); // ‚Üê ADD THIS DEBUG LINE

            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(response => {
                        console.log('üì• Response received:', response); // ‚Üê ADD THIS DEBUG LINE

                        let parsed = response;
                        if (typeof response === 'string') {
                            try {
                                parsed = JSON.parse(response);
                            } catch (e) {
                                console.error('‚ùå Failed to parse response JSON:', e);
                                hideTableLoadingSkeleton();
                                showErrorMessage('Backend returned invalid JSON.');
                                reject(e);
                                return;
                            }
                        }

                        // ‚úÖ FIX: Check if response is null or undefined
                        if (!parsed) {
                            console.error('‚ùå Response is null or undefined');
                            hideTableLoadingSkeleton();
                            showErrorMessage('Backend returned null. Check Code.gs function exists.');
                            reject('Null response');
                            return;
                        }

                        if (!parsed.success) {
                            console.error('‚ùå Server error:', parsed.error);
                            hideTableLoadingSkeleton();
                            showErrorMessage('Failed to load tickets: ' + (parsed.error || 'Unknown error'));
                            reject(parsed.error);
                            return;
                        }

                        console.log('‚úÖ Loaded page', page, '-', (parsed.data || []).length, 'tickets');
                        updatePaginationState(parsed);
                        PAGINATION.cache.set(cacheKey, parsed);

                        const parsedVersion = parsed && parsed.version !== undefined ? Number(parsed.version) : null;
                        if (parsedVersion !== null && PAGINATION.version && PAGINATION.version !== parsedVersion) {
                            console.log('üîÑ Data version changed - clearing cache');
                            PAGINATION.cache.clear();
                        }
                        if (parsedVersion !== null) PAGINATION.version = parsedVersion;
                        PAGINATION.lastFetch = new Date();

                        hideTableLoadingSkeleton();
                        resolve(parsed);
                    })
                    .withFailureHandler(error => {
                        console.error('‚ùå Network error:', error);
                        hideTableLoadingSkeleton();
                        showErrorMessage('Network error: ' + (error && error.message ? error.message : String(error)));
                        reject(error);
                    })
                    .getTicketsPaginated(config); // ‚Üê CHECK: Is this the EXACT function name in Code.gs?
            });
        }


        function updatePaginationState(response) {
            if (!response || !response.pagination) return;
            PAGINATION.currentPage = response.pagination.page;
            PAGINATION.totalRows = response.pagination.totalRows;
            PAGINATION.totalPages = response.pagination.totalPages;
        }

        async function renderTicketsTablePaginated(page = 1) {
            try {
                const response = await fetchTicketsPage(page);
                if (!response.success) return;

                // ‚úÖ Switch to Server Pagination Mode
                VIEW_STATE.useLocalPagination = false;

                // ‚úÖ Helper: Get date from row (try multiple column names)
                function getDateFromRow(row) {
                    const dateKeys = ['Date', 'Timestamp', 'date', 'timestamp', 'Created', 'created'];
                    for (const key of dateKeys) {
                        if (row[key]) {
                            const d = new Date(row[key]);
                            if (!isNaN(d.getTime())) return d;
                        }
                    }
                    return null;
                }

                DISPLAY_DATA = (response.data || []).map(row => {
                    const dateObj = getDateFromRow(row) || new Date();
                    const isValidDate = dateObj && !isNaN(dateObj.getTime());

                    // ‚úÖ Use pre-computed fields from backend when available (more reliable)
                    const computedSortDate = row['_sortDate'] || (isValidDate ? dateObj.getTime() : 0);
                    const computedAgeDays = row['_ageDays'] !== undefined ? row['_ageDays'] : (isValidDate ? calculateAgeDays(dateObj) : 0);
                    const computedAgeCategory = row['_ageCategory'] || (isValidDate ? getAgeCategory(computedAgeDays) : 'fresh');

                    // ‚úÖ Field mapping: Handle both backend and API response formats
                    const getSupportType = () => {
                        return row['Support Type'] || row['supportType'] || 'Customer Support';
                    };

                    return {
                        id: row['Ticket ID'] || row['id'] || '',
                        rowIndex: 0,
                        timestamp: dateObj,
                        date: isValidDate ? formatDate(dateObj) : '-',
                        sortDate: computedSortDate,
                        hourIST: isValidDate ? dateObj.getHours() : 0,
                        ageDays: computedAgeDays,
                        ageCategory: computedAgeCategory,
                        email: row['IT Person Email'] || row['email'] || '',
                        agent: row['IT Person'] || row['agent'] || 'Unassigned',
                        requestedBy: row['Requested By'] || row['requestedBy'] || '-',
                        mid: row['MID'] || row['mid'] || '-',
                        business: row['Business Name'] || row['business'] || '-',
                        pos: row['POS System'] || row['pos'] || '-',
                        supportType: getSupportType(),
                        concern: row['Concern Related to'] || row['concern'] || 'Unspecified',
                        config: row['System Configuration'] || row['config'] || '',
                        remark: row['Remark'] || row['remark'] || '',
                        status: row['Status'] || row['status'] || 'Not Completed',
                        reason: row['Follow-up Reason/ Remark'] || row['reason'] || '',
                        invalidClosed: row['Invalid Closed'] || row['invalidClosed'] || false,
                        reasonQuality: row['_reasonQuality'] || calculateReasonQuality(row['Follow-up Reason/ Remark'] || row['reason'] || '')
                    };
                });

                // ‚úÖ FIX: Always ensure descending sort (newest first) after mapping
                DISPLAY_DATA.sort((a, b) => b.sortDate - a.sortDate);

                renderTable('Tickets - Page ' + page + ' of ' + response.pagination.totalPages);
                renderPaginationControls();
                renderKPIs();

            } catch (error) {
                console.error('Error rendering paginated table:', error);
            }
        }

        function calculateReasonQuality(reason) {
            if (!reason || reason.trim().length === 0) return 'none';
            if (reason.trim().length < 10) return 'minimal';   // Very short
            if (reason.trim().length < 30) return 'brief';     // Basic explanation
            return 'detailed';  // Well documented
        }

        function renderPaginationControls() {
            const container = document.getElementById('pagination-controls');
            if (!container) {
                console.warn('‚ö†Ô∏è Pagination container not found');
                return;
            }

            const { currentPage, totalPages, totalRows, pageSize } = PAGINATION;

            if (totalRows === 0) {
                container.innerHTML =
                    '<div style="padding: 20px; text-align: center; color: var(--text-sec);">No tickets found</div>';
                return;
            }

            const start = ((currentPage - 1) * pageSize) + 1;
            const end = Math.min(currentPage * pageSize, totalRows);
            const pageNumbers = getPageNumbers(currentPage, totalPages);

            container.innerHTML = `
    <div style="display: flex; align-items: center; justify-content: space-between; 
                padding: 16px 24px; background: white; border-top: 2px solid var(--border);
                position: sticky; bottom: 0; z-index: 20; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);">

      <div style="font-size: 13px; font-weight: 600; color: var(--text-main);">
        Showing <strong style="color: var(--primary);">${start}-${end}</strong> 
        of <strong>${totalRows.toLocaleString()}</strong> tickets
      </div>

      <div style="display: flex; align-items: center; gap: 6px;">
        <button class="btn" onclick="goToPage(1)" 
                ${currentPage === 1 ? 'disabled style="opacity: 0.5;"' : ''}>
          <i class="fas fa-angle-double-left"></i> First
        </button>

        <button class="btn" onclick="goToPage(${currentPage - 1})" 
                ${currentPage === 1 ? 'disabled style="opacity: 0.5;"' : ''}>
          <i class="fas fa-angle-left"></i> Prev
        </button>

        ${pageNumbers.map(num => {
                if (num === '...') {
                    return '<span style="padding: 0 8px; color: var(--text-sec);">...</span>';
                }
                return `
            <button class="btn ${num === currentPage ? 'btn-primary' : ''}" 
                    onclick="goToPage(${num})"
                    style="min-width: 40px;">
              ${num}
            </button>
          `;
            }).join('')}

        <button class="btn" onclick="goToPage(${currentPage + 1})" 
                ${currentPage >= totalPages ? 'disabled style="opacity: 0.5;"' : ''}>
          Next <i class="fas fa-angle-right"></i>
        </button>

        <button class="btn" onclick="goToPage(${totalPages})" 
                ${currentPage >= totalPages ? 'disabled style="opacity: 0.5;"' : ''}>
          Last <i class="fas fa-angle-double-right"></i>
        </button>
      </div>

      <div style="display: flex; align-items: center; gap: 8px;">
        <label style="font-size: 12px; font-weight: 600; color: var(--text-sec);">
          Per page:
        </label>
        <select onchange="changePageSize(this.value)" 
                style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border);
                       font-size: 13px; font-weight: 600; cursor: pointer;">
          <option value="50" ${pageSize === 50 ? 'selected' : ''}>50</option>
          <option value="100" ${pageSize === 100 ? 'selected' : ''}>100</option>
          <option value="250" ${pageSize === 250 ? 'selected' : ''}>250</option>
          <option value="500" ${pageSize === 500 ? 'selected' : ''}>500</option>
        </select>
      </div>
    </div>
  `;
        }

        function getPageNumbers(current, total) {
            const delta = 2;
            const range = [];
            const rangeWithDots = [];
            let l;

            for (let i = 1; i <= total; i++) {
                if (i === 1 || i === total || (i >= current - delta && i <= current + delta)) {
                    range.push(i);
                }
            }

            range.forEach(i => {
                if (l) {
                    if (i - l === 2) {
                        rangeWithDots.push(l + 1);
                    } else if (i - l !== 1) {
                        rangeWithDots.push('...');
                    }
                }
                rangeWithDots.push(i);
                l = i;
            });

            return rangeWithDots;
        }

        function goToPage(page) {
            if (page < 1 || page > PAGINATION.totalPages || page === PAGINATION.currentPage) {
                return;
            }

            const tableWrapper = document.querySelector('.table-wrapper');
            if (tableWrapper) {
                tableWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            setTimeout(() => {
                if (VIEW_STATE.useLocalPagination) {
                    // ‚úÖ Handle Local Pagination (for KPI filters)
                    renderTable(VIEW_STATE.currentTitle || 'Tickets', page);
                } else {
                    // ‚úÖ Handle Server Pagination
                    renderTicketsTablePaginated(page);
                }
            }, 200);
        }

        function changePageSize(newSize) {
            PAGINATION.pageSize = parseInt(newSize);
            PAGINATION.cache.clear();
            renderTicketsTablePaginated(1);
            showToast('Page size changed to ' + newSize, 'info', 2000);
        }

        const debouncedSearch = debounce(function (searchTerm) {
            console.log('üîç Searching for:', searchTerm);
            PAGINATION.filters.search = searchTerm;
            PAGINATION.cache.clear();
            renderTicketsTablePaginated(1);
        }, 300);

        function onSearchInputPaginated(input) {
            debouncedSearch(input.value);
        }

        function showTableLoadingSkeleton() {
            const tbody = document.getElementById('dash-table');
            if (!tbody) return;

            tbody.innerHTML = Array(8).fill(0).map(() => `
    <tr style="animation: pulse 1.5s ease-in-out infinite;">
      <td><div class="skeleton-box" style="width: 70%;"></div></td>
      <td><div class="skeleton-box" style="width: 85%;"></div></td>
      <td><div class="skeleton-box" style="width: 60%;"></div></td>
      <td><div class="skeleton-box" style="width: 75%;"></div></td>
      <td><div class="skeleton-box" style="width: 50%;"></div></td>
      <td><div class="skeleton-box" style="width: 40%;"></div></td>
      <td><div class="skeleton-box" style="width: 65%;"></div></td>
      <td><div class="skeleton-box" style="width: 55%;"></div></td>
    </tr>
  `).join('');
        }

        function hideTableLoadingSkeleton() {
            // actual data will overwrite skeleton via renderTable()
        }

        function showErrorMessage(message) {
            const tbody = document.getElementById('dash-table');
            if (!tbody) return;

            // üõ°Ô∏è Phase 1.3: XSS Prevention - escape error messages
            const safeMessage = escapeHtml(message);

            tbody.innerHTML = `
    <tr>
      <td colspan="10" style="padding: 40px; text-align: center;">
        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--danger); margin-bottom: 16px;"></i>
        <div style="font-size: 16px; font-weight: 600; color: var(--text-main); margin-bottom: 8px;">
          ${safeMessage}
        </div>
        <button class="btn btn-primary" onclick="renderTicketsTablePaginated(PAGINATION.currentPage)">
          <i class="fas fa-redo"></i> Retry
        </button>
      </td>
    </tr>
  `;
        }


        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function calculateAgeDays(date) {
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        function getAgeCategory(days) {
            if (days >= 15) return 'critical';
            if (days >= 8) return 'old';
            if (days >= 4) return 'aging';
            return 'fresh';
        }


        // ==========================================
        // üë• DASHBOARD AGENT CARDS
        // ==========================================
        function renderDashboardAgents() {
            const agents = getAgentStats();
            const teamAvg = agents.length ? agents.reduce((sum, a) => sum + (a.total ? (a.comp / a.total) * 100 : 0), 0) / agents.length : 0;

            document.getElementById('dash-agent-grid').innerHTML = agents.map((a, i) => {
                let medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                let topClass = i === 0 ? 'top-performer' : '';
                const rate = a.total ? Math.round((a.comp / a.total) * 100) : 0;

                const scoreClass = a.score > 0 ? 'score-positive' : a.score < 0 ? 'score-negative' : 'score-neutral';
                const effClass = a.completionRate >= 60 ? 'score-positive' : a.completionRate >= 30 ? 'score-neutral' : 'score-negative';
                const peerBarColor = rate >= teamAvg ? '#10B981' : rate >= teamAvg - 10 ? '#F59E0B' : '#EF4444';

                return '<div class="agent-card ' + topClass + '">' +
                    '<div class="crown-badge"><i class="fas fa-crown"></i> TOP AGENT</div>' +
                    '<div class="ac-header">' +
                    '<div class="ac-user">' +
                    '<span class="ac-medal">' + medal + '</span>' +
                    '<span class="ac-name">' + a.name + '</span>' +
                    '</div>' +
                    '<span class="ac-rate">' + rate + '% Rate</span>' +
                    '</div>' +

                    '<div class="ac-stats-row">' +
                    '<div class="stat-btn sb-total" onclick="filterByAgent(\'' + a.name + '\', \'Total\')">' +
                    '<span class="sb-val">' + a.total + '</span><span class="sb-lbl">Total</span>' +
                    '</div>' +
                    '<div class="stat-btn sb-done" onclick="filterByAgent(\'' + a.name + '\', \'Completed\')">' +
                    '<span class="sb-val">' + a.comp + '</span><span class="sb-lbl">Done</span>' +
                    '</div>' +
                    '<div class="stat-btn sb-pend" onclick="filterByAgent(\'' + a.name + '\', \'Not Completed\')">' +
                    '<span class="sb-val">' + a.not + '</span><span class="sb-lbl">Pend</span>' +
                    '</div>' +
                    '<div class="stat-btn sb-closed" onclick="filterByAgent(\'' + a.name + '\', \'Closed\')">' +
                    '<span class="sb-val">' + a.closed + '</span><span class="sb-lbl">Close</span>' +
                    '</div>' +
                    '<div class="stat-btn sb-cant" onclick="filterByAgent(\'' + a.name + '\', \'Can\\\'t Do\')">' +
                    '<span class="sb-val">' + a.cant + '</span><span class="sb-lbl">Can\'t</span>' +
                    '</div>' +
                    '</div>' +

                    '<div class="ac-stats-row" style="margin-top:8px;">' +
                    '<div class="stat-btn sb-invalid" onclick="filterByAgent(\'' + a.name + '\', \'Invalid Closed\')" style="grid-column: span 2;">' +
                    '<span class="sb-val">' + a.invalidClosed + '</span><span class="sb-lbl" style="color:#DC2626;">‚ö† Invalid</span>' +
                    '</div>' +
                    '<div class="stat-btn sb-pend" onclick="filterByAgent(\'' + a.name + '\', \'Old Pending\')" style="grid-column: span 3;">' +
                    '<span class="sb-val">' + a.pendingOld + '</span><span class="sb-lbl">Pending >7d</span>' +
                    '</div>' +
                    '</div>' +

                    '<div class="ac-score-row">' +
                    '<div class="score-box">' +
                    '<span class="score-val ' + scoreClass + '">' + (a.score > 0 ? '+' : '') + a.score + '</span>' +
                    '<span class="score-lbl">Points</span>' +
                    '</div>' +
                    '<div class="score-box">' +
                    '<span class="score-val ' + effClass + '">' + a.completionRate + '%</span>' +
                    '<span class="score-lbl">Completion Rate</span>' +
                    '</div>' +
                    '<div class="score-box">' +
                    '<span class="score-val" style="color:var(--warning);">#' + (i + 1) + '</span>' +
                    '<span class="score-lbl">Rank</span>' +
                    '</div>' +
                    '</div>' +

                    '<div class="peer-compare">' +
                    '<div class="peer-label">Performance vs Team</div>' +
                    '<div class="peer-bar-bg">' +
                    '<div class="peer-bar-fill" style="width:' + rate + '%; background:' + peerBarColor + ';"></div>' +
                    '<div class="peer-avg-line" style="left:' + teamAvg + '%;"></div>' +
                    '</div>' +
                    '</div>' +

                    '</div>';
            }).join('');
        }


        // ==========================================
        // üéØ TABLE FILTERS
        // ==========================================
        function filterTable(type, btn, silent) {
            VIEW_STATE.filterType = 'status';
            VIEW_STATE.filterStatus = type;
            VIEW_STATE.filterAgent = null;
            VIEW_STATE.currentTableBtn = btn;
            // ‚úÖ Switch to Local Pagination Mode
            VIEW_STATE.useLocalPagination = true;
            VIEW_STATE.currentTitle = type === 'Total' ? 'All Tickets' : type;

            document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // ‚úÖ ENHANCED: Properly filter DISPLAY_DATA based on KPI card type
            if (type === 'Total') {
                DISPLAY_DATA = [...DATE_DATA];
            } else if (type === 'Completed') {
                DISPLAY_DATA = DATE_DATA.filter(t => t.status.toLowerCase() === 'completed');
            } else if (type === 'Not Completed') {
                DISPLAY_DATA = DATE_DATA.filter(t => {
                    const s = t.status.toLowerCase();
                    return s === 'not completed' || s === 'pending' || s === 'in progress';
                });
            } else if (type === 'Closed') {
                // ‚úÖ FIXED: Show ALL closed tickets (includes both valid and invalid closed)
                DISPLAY_DATA = DATE_DATA.filter(t => t.status.toLowerCase() === 'closed');
            } else if (type === "Can't Do") {
                DISPLAY_DATA = DATE_DATA.filter(t => {
                    const s = t.status.toLowerCase();
                    return s.includes("can't") || s.includes('cant') || s.includes("can‚Äôt");
                });
            } else if (type === 'Invalid Closed') {
                DISPLAY_DATA = DATE_DATA.filter(t => t.invalidClosed);
            } else if (type === 'Old Pending') {
                DISPLAY_DATA = DATE_DATA.filter(t => {
                    const s = t.status.toLowerCase();
                    return t.ageDays >= 7 && s !== 'completed' && s !== 'closed';
                });
            } else {
                DISPLAY_DATA = [...DATE_DATA];
            }

            // ‚úÖ Sort descending (recent first)
            DISPLAY_DATA.sort((a, b) => b.sortDate - a.sortDate);

            // ‚úÖ Render table with proper KPI card name as title
            const titleMap = {
                'Total': 'üìä Total Tickets',
                'Completed': '‚úÖ Completed',
                'Not Completed': '‚è≥ Not Completed',
                'Closed': 'üîí Closed',
                "Can't Do": "‚ùå Can't Do",
                'Invalid Closed': '‚ö†Ô∏è Invalid Closed',
                'Old Pending': 'üïê Old Pending (>7 days)'
            };

            // Always start at page 1 for new filter
            renderTable(titleMap[type] || type, 1);

            if (!silent) {
                const tableWrapper = document.querySelector('.table-wrapper');
                if (tableWrapper) {
                    setTimeout(() => {
                        tableWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            }
        }


        function filterByAgent(agent, status) {
            VIEW_STATE.filterType = 'agent';
            VIEW_STATE.filterAgent = agent;
            VIEW_STATE.filterStatus = status;

            let base = DATE_DATA.filter(t => t.agent === agent);

            if (status === 'Total') DISPLAY_DATA = base;
            else if (status === 'Completed') DISPLAY_DATA = base.filter(t => t.status.toLowerCase() === 'completed');
            else if (status === 'Not Completed') DISPLAY_DATA = base.filter(t => {
                const s = t.status.toLowerCase();
                return s === 'not completed' || s === 'pending' || s === 'in progress';
            });
            else if (status === 'Closed') {
                // ‚úÖ AGENT VIEW: "Closed" button now shows ALL closed tickets (Valid + Invalid)
                DISPLAY_DATA = base.filter(t => t.status.toLowerCase() === 'closed');
            }
            else if (status === "Can't Do")
                DISPLAY_DATA = base.filter(t => {
                    const s = t.status.toLowerCase();
                    return s.includes("can't") || s.includes('cant') || s.includes("can‚Äôt");
                });
            else if (status === 'Invalid Closed') DISPLAY_DATA = base.filter(t => t.invalidClosed);
            else if (status === 'Old Pending') DISPLAY_DATA = base.filter(t => {
                const s = t.status.toLowerCase();
                return t.ageDays >= 7 && s !== 'completed' && s !== 'closed';
            });
            // ‚úÖ ENHANCED: Sort by date descending (recent first)
            DISPLAY_DATA.sort((a, b) => b.sortDate - a.sortDate);

            renderTable(`${agent} ‚Ä¢ ${status}`);
            document.getElementById('table-scroll-target').scrollIntoView({ behavior: 'smooth' });
        }

        // ‚úÖ Fixed Search with Proper Context Restore
        function searchLocalTable(q) {
            if (!q || q.trim() === '') {
                // Restore previous filter context
                if (VIEW_STATE.filterType === 'agent') {
                    filterByAgent(VIEW_STATE.filterAgent, VIEW_STATE.filterStatus);
                } else if (VIEW_STATE.currentTableBtn) {
                    filterTable(VIEW_STATE.filterStatus, VIEW_STATE.currentTableBtn, true);
                } else {
                    DISPLAY_DATA = DATE_DATA;
                    renderTable('All Tickets');
                }
                return;
            }

            q = q.toLowerCase();
            DISPLAY_DATA = DATE_DATA.filter(t =>
                t.id.toLowerCase().includes(q) ||
                t.business.toLowerCase().includes(q) ||
                t.mid.toLowerCase().includes(q) ||
                t.agent.toLowerCase().includes(q) ||
                t.concern.toLowerCase().includes(q)
            );
            renderTable('Search Results');
        }

        // ==========================================
        // üìã TABLE RENDERING
        // ==========================================
        function renderTable(title, page = 1) {
            // Save title for local pagination context
            VIEW_STATE.currentTitle = title;

            let dataToRender;

            if (VIEW_STATE.useLocalPagination) {
                // ‚úÖ Local Pagination Logic (Expert Mode)
                // 1. Sort global data
                DISPLAY_DATA.sort((a, b) => b.sortDate - a.sortDate);

                // 2. Update Pagination State
                PAGINATION.totalRows = DISPLAY_DATA.length;
                PAGINATION.pageSize = PAGINATION.pageSize || 100;
                PAGINATION.totalPages = Math.ceil(PAGINATION.totalRows / PAGINATION.pageSize) || 1;

                // 3. Validate Page
                if (page < 1) page = 1;
                if (page > PAGINATION.totalPages) page = PAGINATION.totalPages;
                PAGINATION.currentPage = page;

                // 4. Update Title with Counts
                document.getElementById('table-title').innerText = title + ` (${PAGINATION.totalRows})`;

                // 5. Slice Data
                const start = (page - 1) * PAGINATION.pageSize;
                const end = start + PAGINATION.pageSize;
                dataToRender = DISPLAY_DATA.slice(start, end);

                // 6. Update Pagination UI
                renderPaginationControls();
            } else {
                // ‚úÖ Server Pagination Mode (Normal)
                // Data is already sliced by server
                dataToRender = DISPLAY_DATA;

                // Title uses server-provided totalRows
                document.getElementById('table-title').innerText = title + ` (${PAGINATION.totalRows})`;

                // Pagination buttons are rendered by renderTicketsTablePaginated -> renderPaginationControls
            }

            const thead = document.getElementById('table-head');
            thead.innerHTML = `
  <tr>
    <th>ID</th>
    <th>Date</th>
    <th>Age</th>
    <th>Agent</th>
    <th>Business</th>
    <th>MID</th>
    <th style="min-width: 140px">üìû Phone</th>
    <th>Concern</th>
    <th>Status</th>
    <th style="min-width: 200px">Reason / Notes</th>
    <th>Actions</th>
  </tr>
`;


            // Sort logic is already handled above for Local, or by Server

            const tbody = document.getElementById('dash-table');
            tbody.innerHTML = dataToRender.map(t => {
                let statusBadge = 's-pend';
                const st = t.status.toLowerCase();
                if (st === 'completed') statusBadge = 's-done';
                else if (st === 'closed') statusBadge = t.invalidClosed ? 's-invalid' : 's-closed';
                else if (st.includes("can't") || st.includes('cant')) statusBadge = 's-cant';

                if (t.invalidClosed) statusBadge = 's-invalid';

                // ‚úÖ Safe display helpers to prevent NaN
                const rqClass = `rq-${t.reasonQuality || 'none'}`;
                const safeDate = t.date && t.date !== 'NaN-NaN-NaN' && t.date !== '-' ? escapeHtml(t.date) : 'N/A';
                const safeAge = !isNaN(t.ageDays) && t.ageDays !== null ? t.ageDays + 'd' : '-';

                return `
  <tr class="age-${t.ageCategory}">
    <td><strong>${escapeHtml(t.id)}</strong></td>
    <td>${safeDate}</td>
    <td><strong>${safeAge}</strong></td>
    <td>${escapeHtml(t.agent)}</td>
    <td>${escapeHtml(t.business)}</td>
    <td>${escapeHtml(t.mid)}</td>
    <td>
      ${t.phone ? `
        <div style="display: flex; align-items: center; gap: 8px;">
          <a href="tel:${escapeHtml(t.phone)}" 
             class="phone-link" 
             title="Click to call ${escapeHtml(t.phoneDisplay)}"
             style="display: flex; align-items: center; gap: 6px; color: #667eea; font-weight: 600; text-decoration: none; padding: 6px 10px; background: #EEF2FF; border-radius: 6px; transition: all 0.2s; font-size: 12px;"
             onmouseover="this.style.background='#667eea'; this.style.color='white';"
             onmouseout="this.style.background='#EEF2FF'; this.style.color='#667eea';">
            <i class="fas fa-phone" style="font-size: 11px;"></i>
            <span>${escapeHtml(t.phoneDisplay)}</span>
          </a>
        </div>
      ` : '<span style="color: #CBD5E1;">‚Äî</span>'}
    </td>
    <td>${escapeHtml(t.concern)}</td>
    <td>
      <span class="badge ${statusBadge}">${escapeHtml(t.status)}</span>
      ${t.reason && t.reasonQuality && t.reasonQuality !== 'none' ?
                        `<span class="reason-quality ${rqClass}">${escapeHtml(t.reasonQuality)}</span>` : ''}
    </td>
    <td style="max-width: 350px; font-size: 11px; color: #475569;">
      ${t.reason ?
                        `<div style="max-height: 80px; overflow-y: auto; white-space: pre-wrap; line-height: 1.5; padding: 4px 8px; background: #F8FAFC; border-radius: 6px; border-left: 3px solid #CBD5E1;">
          ${escapeHtml(t.reason)}
        </div>` :
                        `<span style="color: #CBD5E1; font-style: italic;">‚Äî</span>`
                    }
    </td>
    <td>
      <button class="action-btn action-btn-update" data-ticket-id="${escapeHtml(t.id)}" onclick="openReasonModalSafe(this)">
        <i class="fas fa-edit"></i> Update
      </button>
    </td>
  </tr>
`;

            }).join('');

            // ‚úÖ Also render mobile cards for responsive view
            renderMobileTicketCards(dataToRender);
        }

        // ==========================================
        // üì± MOBILE TICKET CARDS RENDERER v2.0
        // Premium Touch-Optimized Experience
        // ==========================================
        function renderMobileTicketCards(dataToRender) {
            let container = document.getElementById('mobile-tickets-container');

            // Create container if it doesn't exist
            if (!container) {
                const tableWrapper = document.querySelector('.table-wrapper');
                if (!tableWrapper) return;

                // Add wrapper class for responsive CSS
                tableWrapper.classList.add('desktop-table-wrapper');

                // Create mobile container
                container = document.createElement('div');
                container.id = 'mobile-tickets-container';
                container.className = 'mobile-tickets-container';
                tableWrapper.parentNode.insertBefore(container, tableWrapper.nextSibling);

                // Create mobile search bar
                const searchBar = document.createElement('div');
                searchBar.className = 'mobile-search-bar';
                searchBar.innerHTML = `
            <div class="mobile-search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" 
                       class="mobile-search-input" 
                       placeholder="Search tickets..." 
                       oninput="searchLocalTable(this.value)"
                       aria-label="Search tickets">
            </div>
        `;
                container.parentNode.insertBefore(searchBar, container);

                // Create mobile stats bar
                const statsBar = document.createElement('div');
                statsBar.className = 'mobile-stats-bar';
                statsBar.id = 'mobile-stats-bar';
                container.parentNode.insertBefore(statsBar, container);
            }

            // Update mobile stats bar
            updateMobileStatsBar();

            // Render tickets
            if (!dataToRender || dataToRender.length === 0) {
                container.innerHTML = `
            <div class="mobile-empty-state">
                <i class="fas fa-inbox"></i>
                <p>No tickets found</p>
            </div>
        `;
                return;
            }

            container.innerHTML = dataToRender.map((t, index) => {
                // Status badge class
                let statusClass = 'status-pending';
                let statusIcon = 'fa-hourglass-half';
                const st = t.status.toLowerCase();

                if (st === 'completed') {
                    statusClass = 'status-completed';
                    statusIcon = 'fa-check-circle';
                } else if (st === 'closed') {
                    statusClass = t.invalidClosed ? 'status-invalid' : 'status-closed';
                    statusIcon = t.invalidClosed ? 'fa-exclamation-triangle' : 'fa-lock';
                } else if (st.includes("can't") || st.includes('cant')) {
                    statusClass = 'status-cant';
                    statusIcon = 'fa-times-circle';
                }

                if (t.invalidClosed) {
                    statusClass = 'status-invalid';
                    statusIcon = 'fa-exclamation-triangle';
                }

                // Age category and icon
                const ageCategory = t.ageCategory || 'fresh';
                let ageIcon = 'fa-clock';
                if (ageCategory === 'critical') ageIcon = 'fa-fire';
                else if (ageCategory === 'old') ageIcon = 'fa-exclamation';
                else if (ageCategory === 'aging') ageIcon = 'fa-hourglass-start';

                // Safe values
                const safeDate = t.date && t.date !== 'NaN-NaN-NaN' && t.date !== '-' ? escapeHtml(t.date) : 'N/A';
                const safeAge = !isNaN(t.ageDays) && t.ageDays !== null ? t.ageDays + 'd' : '-';

                return `
        <div class="mobile-ticket-card age-${ageCategory}" data-ticket-id="${escapeHtml(t.id)}">
            <!-- Header: ID + Age Badge -->
            <div class="mobile-ticket-header">
                <div class="mobile-ticket-id">
                    <span class="id-icon"><i class="fas fa-ticket-alt"></i></span>
                    ${escapeHtml(t.id)}
                </div>
                <div class="mobile-ticket-age age-${ageCategory}">
                    <i class="fas ${ageIcon}"></i>
                    ${safeAge}
                </div>
            </div>
            
            <!-- Body: Main Content -->
            <div class="mobile-ticket-body">
                <div class="mobile-ticket-business">${escapeHtml(t.business)}</div>
                
                <div class="mobile-ticket-meta">
                    <div class="mobile-ticket-meta-item">
                        <i class="fas fa-user"></i>
                        <span>${escapeHtml(t.agent)}</span>
                    </div>
                    <div class="mobile-ticket-meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>${safeDate}</span>
                    </div>
                    <div class="mobile-ticket-meta-item">
                        <i class="fas fa-hashtag"></i>
                        <span>${escapeHtml(t.mid)}</span>
                    </div>
                </div>
                ${t.phone ? `
  <a href="tel:${escapeHtml(t.phone)}" 
     class="mobile-phone-cta"
     style="display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px 20px; border-radius: 12px; text-decoration: none; font-weight: 700; font-size: 15px; margin: 12px 0; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s;">
    <i class="fas fa-phone-alt" style="font-size: 16px;"></i>
    <span>${escapeHtml(t.phoneDisplay)}</span>
    <i class="fas fa-arrow-right" style="font-size: 12px; margin-left: auto;"></i>
  </a>
` : ''}
                <div class="mobile-ticket-concern">
                    <i class="fas fa-comment-dots"></i>
                    ${escapeHtml(t.concern || 'No concern specified')}
                </div>
            </div>
            
            <!-- Status Row -->
            <div class="mobile-ticket-status">
                <span class="mobile-status-badge ${statusClass}">
                    <i class="fas ${statusIcon}"></i>
                    ${escapeHtml(t.status)}
                </span>
                ${t.reasonQuality && t.reasonQuality !== 'none' ?
                        `<span class="reason-quality rq-${t.reasonQuality}">${escapeHtml(t.reasonQuality)}</span>` : ''}
            </div>
            
            ${t.reason ? `
            <!-- Reason Preview -->
            <div class="mobile-ticket-reason">
                <div class="mobile-ticket-reason-label">
                    <i class="fas fa-file-alt"></i>
                    Notes / Reason
                </div>
                <div class="mobile-ticket-reason-text">${escapeHtml(t.reason)}</div>
            </div>
            ` : ''}
            
            <!-- Actions -->
            <div class="mobile-ticket-actions">
                <button class="mobile-btn mobile-btn-primary" onclick="openReasonModalSafe('${escapeHtml(t.id)}')">
                    <i class="fas fa-edit"></i>
                    Update
                </button>
                <button class="mobile-btn mobile-btn-secondary" onclick="showMobileTicketDetails('${escapeHtml(t.id)}')">
                    <i class="fas fa-eye"></i>
                    Details
                </button>
            </div>
        </div>
        `;
            }).join('');

            // Add load more button if there are more pages
            if (PAGINATION.currentPage < PAGINATION.totalPages) {
                container.innerHTML += `
            <button class="mobile-load-more" onclick="loadMoreMobileTickets()">
                <i class="fas fa-chevron-down"></i>
                Load More (${PAGINATION.currentPage}/${PAGINATION.totalPages})
            </button>
        `;
            }
        }

        // Update mobile stats bar
        function updateMobileStatsBar() {
            const statsBar = document.getElementById('mobile-stats-bar');
            if (!statsBar || !DATE_DATA) return;

            const stats = {
                total: DATE_DATA.length,
                completed: DATE_DATA.filter(t => t.status.toLowerCase() === 'completed').length,
                pending: DATE_DATA.filter(t => {
                    const s = t.status.toLowerCase();
                    return s === 'not completed' || s === 'pending' || s === 'in progress';
                }).length,
                closed: DATE_DATA.filter(t => t.status.toLowerCase() === 'closed').length,
                cant: DATE_DATA.filter(t => {
                    const s = t.status.toLowerCase();
                    return s.includes("can't") || s.includes('cant');
                }).length
            };

            statsBar.innerHTML = `
        <div class="mobile-stats-grid">
            <div class="mobile-stat-item stat-total ${VIEW_STATE.filterStatus === 'Total' ? 'active' : ''}" 
                 onclick="filterTable('Total', null)">
                <div class="mobile-stat-val">${stats.total}</div>
                <div class="mobile-stat-lbl">Total</div>
            </div>
            <div class="mobile-stat-item stat-done ${VIEW_STATE.filterStatus === 'Completed' ? 'active' : ''}" 
                 onclick="filterTable('Completed', null)">
                <div class="mobile-stat-val">${stats.completed}</div>
                <div class="mobile-stat-lbl">Done</div>
            </div>
            <div class="mobile-stat-item stat-pend ${VIEW_STATE.filterStatus === 'Not Completed' ? 'active' : ''}" 
                 onclick="filterTable('Not Completed', null)">
                <div class="mobile-stat-val">${stats.pending}</div>
                <div class="mobile-stat-lbl">Pend</div>
            </div>
            <div class="mobile-stat-item stat-closed ${VIEW_STATE.filterStatus === 'Closed' ? 'active' : ''}" 
                 onclick="filterTable('Closed', null)">
                <div class="mobile-stat-val">${stats.closed}</div>
                <div class="mobile-stat-lbl">Closed</div>
            </div>
            <div class="mobile-stat-item stat-cant ${VIEW_STATE.filterStatus === "Can't Do" ? 'active' : ''}" 
                 onclick="filterTable('Can\\'t Do', null)">
                <div class="mobile-stat-val">${stats.cant}</div>
                <div class="mobile-stat-lbl">Can't</div>
            </div>
        </div>
    `;
        }

        // Load more tickets for mobile pagination
        function loadMoreMobileTickets() {
            if (PAGINATION.currentPage < PAGINATION.totalPages) {
                PAGINATION.currentPage++;
                renderTable(VIEW_STATE.currentTitle, PAGINATION.currentPage);

                // Haptic feedback
                hapticFeedback('light');

                // Announce for accessibility
                announceToScreenReader(`Loaded page ${PAGINATION.currentPage} of ${PAGINATION.totalPages}`);
            }
        }

        // Show full ticket details in a modal
        function showMobileTicketDetails(ticketId) {
            const ticket = RAW_DATA.find(t => String(t.id).trim() === String(ticketId).trim());
            if (!ticket) {
                showToast('Ticket not found', 'error');
                return;
            }

            // Haptic feedback
            hapticFeedback('light');

            // Create details modal
            let modal = document.getElementById('mobile-details-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'mobile-details-modal';
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
            }

            const safeDate = ticket.date && ticket.date !== 'NaN-NaN-NaN' ? escapeHtml(ticket.date) : 'N/A';
            const safeAge = !isNaN(ticket.ageDays) ? ticket.ageDays + ' days' : '-';

            modal.innerHTML = `
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <span class="modal-title">
                    <i class="fas fa-ticket-alt" style="color: #667eea; margin-right: 8px;"></i>
                    ${escapeHtml(ticket.id)}
                </span>
                <span class="modal-close" onclick="closeMobileDetailsModal()">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid #E2E8F0;">
                        <td style="padding: 12px 0; font-weight: 700; color: #64748B; width: 35%;">Business</td>
                        <td style="padding: 12px 0; color: #1E293B;">${escapeHtml(ticket.business)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #E2E8F0;">
                        <td style="padding: 12px 0; font-weight: 700; color: #64748B;">MID</td>
                        <td style="padding: 12px 0; color: #1E293B;">${escapeHtml(ticket.mid)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #E2E8F0;">
                        <td style="padding: 12px 0; font-weight: 700; color: #64748B;">Agent</td>
                        <td style="padding: 12px 0; color: #1E293B;">${escapeHtml(ticket.agent)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #E2E8F0;">
                        <td style="padding: 12px 0; font-weight: 700; color: #64748B;">Date</td>
                        <td style="padding: 12px 0; color: #1E293B;">${safeDate}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #E2E8F0;">
                        <td style="padding: 12px 0; font-weight: 700; color: #64748B;">Age</td>
                        <td style="padding: 12px 0; color: #1E293B;">${safeAge}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #E2E8F0;">
                        <td style="padding: 12px 0; font-weight: 700; color: #64748B;">Status</td>
                        <td style="padding: 12px 0;">
                            <span class="badge s-${ticket.status.toLowerCase().replace(/[^a-z]/g, '')}">${escapeHtml(ticket.status)}</span>
                        </td>
                    </tr>
                    <tr style="border-bottom: 1px solid #E2E8F0;">
                        <td style="padding: 12px 0; font-weight: 700; color: #64748B;">Concern</td>
                        <td style="padding: 12px 0; color: #1E293B;">${escapeHtml(ticket.concern || '-')}</td>
                    </tr>
                </table>
                
                ${ticket.reason ? `
                <div style="margin-top: 16px;">
                    <div style="font-weight: 700; color: #64748B; margin-bottom: 8px; font-size: 12px; text-transform: uppercase;">
                        <i class="fas fa-file-alt" style="margin-right: 6px;"></i>Notes / Reason
                    </div>
                    <div style="background: #F8FAFC; padding: 12px; border-radius: 8px; border-left: 3px solid #667eea; line-height: 1.6; white-space: pre-wrap; font-size: 13px;">
                        ${escapeHtml(ticket.reason)}
                    </div>
                </div>
                ` : ''}
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px;">
                <button class="btn" onclick="closeMobileDetailsModal()" style="flex: 1;">
                    <i class="fas fa-times"></i> Close
                </button>
                <button class="btn btn-primary" onclick="closeMobileDetailsModal(); openReasonModalSafe('${escapeHtml(ticket.id)}')" style="flex: 1;">
                    <i class="fas fa-edit"></i> Update Status
                </button>
            </div>
        </div>
    `;

            modal.classList.add('show');

            // Trap focus for accessibility
            requestAnimationFrame(() => {
                const closeBtn = modal.querySelector('.modal-close');
                if (closeBtn) closeBtn.focus();
            });
        }

        // Close mobile details modal
        function closeMobileDetailsModal() {
            const modal = document.getElementById('mobile-details-modal');
            if (modal) {
                modal.classList.remove('show');
            }
        }




        // ‚úÖ ADD this helper function
        function openReasonModalSafe(input) {
            let ticketId;

            if (typeof input === 'string') {
                // Called from Mobile View (Direct ID)
                ticketId = input;
            } else if (input && input.getAttribute) {
                // Called from Desktop Table (Button Element)
                ticketId = input.getAttribute('data-ticket-id');
            }

            console.log('üéØ Update button clicked for ticket:', ticketId);
            if (ticketId) openReasonModal(ticketId);
        }


        // ==========================================
        // üéØ MODAL FUNCTIONS (Enhanced with Accessibility)
        // ==========================================

        // Store cleanup function for focus trap
        let currentModalFocusTrap = null;
        let previousActiveElement = null;


        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EXPERT FIX #1: Enhanced Ticket Lookup with Fallback Chain
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üéØ PROBLEM: "Ticket not found in local data!" error
        // ‚úÖ SOLUTION: Multi-source search with fallback + better debugging

        function openReasonModal(ticketId) {
            console.log('üîç openReasonModal called with:', ticketId);

            // Validation
            if (!ticketId || ticketId === null || ticketId === undefined || ticketId === '') {
                showToast('‚ùå Error: Invalid ticket ID', 'error');
                announceAlertToScreenReader('Error: Invalid ticket ID');
                return;
            }

            // Normalize ticket ID for comparison
            const normalizedSearchId = String(ticketId).trim().toUpperCase();
            console.log('üîç Searching for ticket:', normalizedSearchId);

            // EXPERT FALLBACK CHAIN - Search in multiple data sources
            let ticket = null;
            let foundIn = '';

            // Source 1: RAW_DATA (all tickets, unfiltered)
            if (typeof RAW_DATA !== 'undefined' && RAW_DATA && RAW_DATA.length > 0) {
                ticket = RAW_DATA.find(t => String(t.id).trim().toUpperCase() === normalizedSearchId);
                if (ticket) foundIn = 'RAW_DATA';
            }

            // Source 2: DATE_DATA (date-filtered tickets)
            if (!ticket && typeof DATE_DATA !== 'undefined' && DATE_DATA && DATE_DATA.length > 0) {
                ticket = DATE_DATA.find(t => String(t.id).trim().toUpperCase() === normalizedSearchId);
                if (ticket) foundIn = 'DATE_DATA';
            }

            // Source 3: DISPLAY_DATA (currently displayed filtered data)
            if (!ticket && typeof DISPLAY_DATA !== 'undefined' && DISPLAY_DATA && DISPLAY_DATA.length > 0) {
                ticket = DISPLAY_DATA.find(t => String(t.id).trim().toUpperCase() === normalizedSearchId);
                if (ticket) foundIn = 'DISPLAY_DATA';
            }

            // Final check - ticket not found
            if (!ticket) {
                console.error('‚ùå Ticket NOT FOUND:', normalizedSearchId);
                console.log('üìä Debug Info:');
                console.log('  - RAW_DATA available:', typeof RAW_DATA !== 'undefined' && RAW_DATA ? RAW_DATA.length : 0, 'tickets');
                console.log('  - DATE_DATA available:', typeof DATE_DATA !== 'undefined' && DATE_DATA ? DATE_DATA.length : 0, 'tickets');
                console.log('  - DISPLAY_DATA available:', typeof DISPLAY_DATA !== 'undefined' && DISPLAY_DATA ? DISPLAY_DATA.length : 0, 'tickets');

                showToast(`‚ùå Ticket ${ticketId} not found! Try refreshing the page.`, 'error', 4000);
                announceAlertToScreenReader(`Error: Ticket ${ticketId} not found`);
                return;
            }

            console.log(`‚úÖ Ticket found in: ${foundIn}`, ticket);

            const modal = document.getElementById('reason-modal');
            const modalContent = modal.querySelector('.modal');

            // Store currently focused element to restore later
            previousActiveElement = document.activeElement;

            // Store ticket ID in modal
            modal.setAttribute('data-current-ticket', ticket.id);

            // Set ARIA attributes for screen readers
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            modal.setAttribute('aria-labelledby', 'modal-title');

            // Update modal ticket info
            document.getElementById('modal-ticket-info').innerHTML = `
    <strong>Ticket ID:</strong> ${escapeHtml(ticket.id)}<br>
    <strong>Business:</strong> ${escapeHtml(ticket.business)}<br>
    <strong>Agent:</strong> ${escapeHtml(ticket.agent)}<br>
    <strong>Current Status:</strong> <span class="badge s-pend">${escapeHtml(ticket.status)}</span>
  `;

            // Pre-select current status
            document.getElementById('modal-status-select').value = ticket.status;

            // Show existing reason if available
            if (ticket.reason) {
                document.getElementById('existing-reason-preview').style.display = 'block';
                document.getElementById('existing-reason-text').innerText = ticket.reason;
            } else {
                document.getElementById('existing-reason-preview').style.display = 'none';
            }

            // Clear reason input
            document.getElementById('reason-input').value = '';

            // ‚ö° CRITICAL: Call updateReasonRequirement to show/hide reason field
            updateReasonRequirement();

            // Show modal
            modal.classList.add('show');

            // Enable focus trap
            if (modalContent) {
                currentModalFocusTrap = trapFocus(modalContent);
            }

            // Announce to screen readers
            announceToScreenReader(`Update ticket dialog opened for ticket ${ticket.id}`);
        }

        // Helper function for openReasonModalSafe - handles both string and button element
        function openReasonModalSafe(input) {
            let ticketId;

            if (typeof input === 'string') {
                // Called from Mobile View - Direct ID
                ticketId = input;
            } else if (input && input.getAttribute) {
                // Called from Desktop Table - Button Element
                ticketId = input.getAttribute('data-ticket-id');
            }

            console.log('üîò Update button clicked for ticket:', ticketId);

            if (ticketId) {
                openReasonModal(ticketId);
            }
        }


        function closeReasonModal() {
            const modal = document.getElementById('reason-modal');
            modal.classList.remove('show');
            modal.setAttribute('data-current-ticket', '');

            // ‚ôø Remove ARIA attributes
            modal.removeAttribute('aria-modal');

            // ‚ôø Release focus trap
            if (currentModalFocusTrap) {
                currentModalFocusTrap();
                currentModalFocusTrap = null;
            }

            // ‚ôø Restore focus to previously focused element
            if (previousActiveElement && previousActiveElement.focus) {
                previousActiveElement.focus();
                previousActiveElement = null;
            }

            // ‚ôø Announce to screen readers
            announceToScreenReader('Dialog closed');
        }

        function updateReasonRequirement() {
            const status = document.getElementById('modal-status-select').value;
            const reasonInput = document.getElementById('reason-input');
            const reasonLabel = reasonInput.previousElementSibling; // Get the label

            console.log('Status changed to:', status);

            // ‚úÖ Show reason requirement based on status
            if (status === 'Completed') {
                // Reason is OPTIONAL for Completed
                if (reasonLabel) {
                    reasonLabel.innerHTML = 'üí¨ Add Reason / Follow-up Notes <span style="color:#64748B;font-weight:400;">(Optional)</span>';
                }
                reasonInput.placeholder = 'Optional: Add completion notes or next steps...';
                reasonInput.style.borderColor = '#E2E8F0';
            } else {
                // Reason is REQUIRED for all other statuses
                if (reasonLabel) {
                    reasonLabel.innerHTML = 'üí¨ Add Reason / Follow-up Notes <span style="color:#DC2626;">*</span>';
                }
                reasonInput.placeholder = 'Required: Explain why ticket is ' + status + '...';
                reasonInput.style.borderColor = '#F59E0B';
            }

            // ‚úÖ Always show the reason field
            reasonInput.style.display = 'block';
            reasonInput.parentElement.style.display = 'block';
        }


        function submitStatusAndReason() {
            const modal = document.getElementById('reason-modal');
            const ticketId = modal.getAttribute('data-current-ticket');

            if (!ticketId || ticketId === 'null') {
                alert('ERROR: No ticket selected!');
                return;
            }

            const newStatus = document.getElementById('modal-status-select').value;
            const newReason = document.getElementById('reason-input').value.trim();

            // Validation
            if (!newStatus) {
                alert('Please select a status');
                return;
            }

            if (newStatus !== 'Completed') {
                if (!newReason || newReason.length < 10) {
                    alert('Reason is REQUIRED and must be at least 10 characters long.\nCurrent length: ' + newReason.length + ' characters');
                    document.getElementById('reason-input').focus();
                    return;
                }
            }

            // ‚úÖ STEP 1: OPTIMISTIC UPDATE (Instant!)
            updateTicketOptimistic(ticketId, newStatus, newReason);

            // ‚úÖ Show success immediately
            showToast('‚úÖ Updated successfully', 'success', 2000);
            closeReasonModal();

            // ‚úÖ STEP 2: Background sync
            google.script.run
                .withSuccessHandler(response => {
                    try {
                        const result = JSON.parse(response);

                        if (result.success) {
                            console.log('‚úÖ Backend confirmed update for', ticketId);
                        } else {
                            // ‚ùå Rollback on error
                            console.error('‚ùå Backend error:', result.error);
                            revertTicketUpdate(ticketId);
                            showToast('‚ùå Update failed: ' + result.error, 'error', 4000);
                        }
                    } catch (e) {
                        console.error('‚ùå Parse error:', e);
                        revertTicketUpdate(ticketId);
                        showToast('‚ùå Server error', 'error', 4000);
                    }
                })
                .withFailureHandler(err => {
                    console.error('‚ùå Network error:', err);
                    revertTicketUpdate(ticketId);
                    showToast('‚ùå Network error. Please try again.', 'error', 4000);
                })
                .updateTicketFull(ticketId, newStatus, newReason);
        }

        // ‚úÖ NEW FUNCTION 1: Optimistic Update
        function updateTicketOptimistic(ticketId, newStatus, newReason) {
            const ticket = RAW_DATA.find(t => t.id === ticketId);  // ‚úÖ RAW_DATA with underscore
            if (!ticket) {
                console.error('Ticket not found:', ticketId);
                return;
            }

            // Store original for rollback
            ticket._backup = {
                status: ticket.status,
                reason: ticket.reason
            };

            // Update immediately
            ticket.status = newStatus;

            if (newReason && newReason.trim() !== '') {
                const now = new Date();
                const dd = now.getDate().toString().padStart(2, '0');
                const mmm = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][now.getMonth()];
                const hh = now.getHours().toString().padStart(2, '0');
                const mm = now.getMinutes().toString().padStart(2, '0');
                const timestamp = `${dd}-${mmm} ${hh}:${mm}`;

                const entry = `[${timestamp}] ${newReason.trim()}`;
                ticket.reason = ticket.reason ? `${ticket.reason}\n${entry}` : entry;
            }

            // Quick re-render
            refreshCurrentView();
        }


        // ‚úÖ NEW FUNCTION 2: Rollback Update
        function revertTicketUpdate(ticketId) {
            const ticket = RAW_DATA.find(t => t.id === ticketId);
            if (!ticket || !ticket._backup) return;

            // Restore original values
            ticket.status = ticket._backup.status;
            ticket.reason = ticket._backup.reason;
            delete ticket._backup;

            // Re-render
            refreshCurrentView();
        }

        // ‚úÖ NEW FUNCTION 3: Smart Refresh
        function refreshCurrentView() {
            // Update derived data
            DATE_DATA = [...RAW_DATA];      // ‚úÖ DATE_DATA and RAW_DATA
            DISPLAY_DATA = [...DATE_DATA];

            // Refresh UI components
            renderKPIs();
            renderDashboardAgents();

            // Preserve current filter
            if (VIEW_STATE.filterType === 'agent') {
                filterByAgent(VIEW_STATE.filterAgent, VIEW_STATE.filterStatus);
            } else if (VIEW_STATE.currentTableBtn) {
                filterTable(VIEW_STATE.filterStatus, VIEW_STATE.currentTableBtn, true);
            } else {
                renderTable('All Tickets');
            }
        }


        // ==========================================
        // üé´ CREATE TICKET FUNCTIONS
        // ==========================================

        // üîß Phase 3.3: Cache for agents list (dynamic population)
        let AGENTS_CACHE = null;

        /**
         * üìã Populate agent dropdowns dynamically from backend
         * Phase 3.3: Eliminates hardcoded agent lists in HTML
         */
        function populateAgentDropdowns() {
            if (AGENTS_CACHE) {
                // Use cached data
                renderAgentOptions(AGENTS_CACHE);
                return;
            }

            google.script.run
                .withSuccessHandler(function (res) {
                    try {
                        const result = JSON.parse(res);
                        if (result.success && result.agents) {
                            AGENTS_CACHE = result.agents;
                            renderAgentOptions(result.agents);
                            console.log('‚úÖ Loaded ' + result.count + ' agents dynamically');
                        } else {
                            console.error('‚ùå Failed to load agents:', result.error);
                            showToast('‚ö†Ô∏è Could not load agent list', 'warning', 3000);
                        }
                    } catch (e) {
                        console.error('Error parsing agent list:', e);
                    }
                })
                .withFailureHandler(function (err) {
                    console.error('Failed to fetch agent list:', err);
                    showToast('‚ö†Ô∏è Could not load agents. Using defaults.', 'warning', 3000);
                })
                .getAgentList();
        }

        /**
         * üé® Render agent options in all agent dropdowns
         */
        function renderAgentOptions(agents) {
            const dropdowns = [
                document.getElementById('new-agent'),
                document.getElementById('compare-agent-1'),
                document.getElementById('compare-agent-2')
            ];

            dropdowns.forEach(select => {
                if (!select) return;

                // Preserve the first option (placeholder)
                const placeholder = select.options[0];
                select.innerHTML = '';
                select.appendChild(placeholder);

                // Add agent options
                agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.name;
                    option.textContent = agent.name;
                    select.appendChild(option);
                });
            });
        }

        function openCreateModal() {
            // Clear all fields first
            document.getElementById('new-email').value = '';
            document.getElementById('new-agent').value = '';
            document.getElementById('new-requested').value = '';
            document.getElementById('new-mid').value = '';
            document.getElementById('new-business').value = '';
            document.getElementById('new-pos').value = '';
            document.getElementById('new-support-type').value = '';
            document.getElementById('new-concern').value = '';
            document.getElementById('new-config').value = '';
            document.getElementById('new-remark').value = '';
            document.getElementById('new-status').value = '';  // ‚úÖ Reset to placeholder (no default)
            document.getElementById('new-reason').value = '';

            // ‚úÖ Hide reason field initially (will show when status is selected)
            document.getElementById('reason-field-container').style.display = 'none';

            // ‚úÖ Show modal first
            document.getElementById('create-ticket-modal').classList.add('show');

            // üîß Phase 3.3: Dynamically populate agent dropdown
            populateAgentDropdowns();

            // ‚úÖ Auto-fetch and fill logged-in user's email
            google.script.run
                .withSuccessHandler(function (res) {
                    try {
                        const result = JSON.parse(res);
                        if (result.success && result.email) {
                            document.getElementById('new-email').value = result.email;
                            console.log('‚úÖ Auto-filled email: ' + result.email);
                        } else {
                            console.log('‚ö†Ô∏è Could not fetch user email');
                        }
                    } catch (e) {
                        console.error('Error parsing user email:', e);
                    }
                })
                .withFailureHandler(function (err) {
                    console.error('Failed to fetch user email:', err);
                })
                .getCurrentUserEmail();
        }

        function closeCreateModal() {
            document.getElementById('create-ticket-modal').classList.remove('show');
        }


        function toggleReasonField() {
            const status = document.getElementById('new-status').value;
            const reasonContainer = document.getElementById('reason-field-container');
            const reasonField = document.getElementById('new-reason');
            const reasonLabel = document.getElementById('reason-field-label');
            const reasonHint = document.getElementById('reason-field-hint');

            // ‚úÖ Handle each status case
            if (!status || status === '') {
                // ‚ùì NO SELECTION: Hide reason field
                reasonContainer.style.display = 'none';
                reasonField.removeAttribute('required');
                reasonField.value = '';

            } else if (status === 'Completed') {
                // ‚úÖ COMPLETED: Hide reason field (not required)
                reasonContainer.style.display = 'none';
                reasonField.removeAttribute('required');
                reasonField.value = '';

            } else if (status === 'Not Completed') {
                // ‚è≥ NOT COMPLETED: Show & REQUIRED
                reasonContainer.style.display = 'block';
                reasonLabel.innerHTML = 'üìã Reason for Incomplete <span style="color:#DC2626;">*</span>';
                reasonField.placeholder = 'Explain why this ticket cannot be completed immediately...';
                reasonHint.innerHTML = '<i class="fas fa-info-circle"></i> This field is required when status is "Not Completed"';
                reasonField.setAttribute('required', 'required');
                reasonField.style.borderColor = '#F59E0B';

            } else if (status === 'Closed') {
                // üîí CLOSED: Show & REQUIRED
                reasonContainer.style.display = 'block';
                reasonLabel.innerHTML = 'üìã Closure Reason <span style="color:#DC2626;">*</span>';
                reasonField.placeholder = 'Explain why this ticket is being closed...';
                reasonHint.innerHTML = '<i class="fas fa-info-circle"></i> Closure reason is required';
                reasonField.setAttribute('required', 'required');
                reasonField.style.borderColor = '#64748B';

            } else if (status === "Can't Do") {
                // ‚ùå CAN'T DO: Show & REQUIRED
                reasonContainer.style.display = 'block';
                reasonLabel.innerHTML = 'üìã Reason Why Can\'t Do <span style="color:#DC2626;">*</span>';
                reasonField.placeholder = 'Explain why this ticket cannot be handled...';
                reasonHint.innerHTML = '<i class="fas fa-info-circle"></i> Explanation is required for "Can\'t Do" status';
                reasonField.setAttribute('required', 'required');
                reasonField.style.borderColor = '#DC2626';
            }
        }

        function submitNewTicket() {
            // Validation
            const agent = document.getElementById('new-agent').value;
            const concern = document.getElementById('new-concern').value;
            const business = document.getElementById('new-business').value;

            if (!agent || agent === '-- Select Agent --') {
                alert('‚ùå Please select an agent');
                return;
            }

            if (!concern || concern === '-- Select Concern --') {
                alert('‚ùå Please select a concern');
                return;
            }

            if (!business || business.trim() === '') {
                alert('‚ùå Please enter business name');
                return;
            }

            // ‚úÖ Validate status is selected
            const status = document.getElementById('new-status').value;
            if (!status || status === '') {
                alert('‚ùå Please select a status');
                document.getElementById('new-status').focus();
                return;
            }

            // ‚úÖ Validate reason field based on status
            const reason = document.getElementById('new-reason').value.trim();

            // Reason is REQUIRED ONLY for Not Completed, Closed, and Can't Do
            if (status !== 'Completed') {
                if (!reason || reason.length < 5) {
                    const statusLabels = {
                        'Not Completed': 'Reason for Incomplete',
                        'Closed': 'Closure Reason',
                        "Can't Do": 'Reason Why Can\'t Do'
                    };
                    alert(`‚ùå Please provide ${statusLabels[status] || 'a reason'} (minimum 5 characters)`);
                    document.getElementById('new-reason').focus();
                    return;
                }
            }

            // Gather data
            const ticketData = {
                email: document.getElementById('new-email').value || '',
                agent: agent,
                requestedBy: document.getElementById('new-requested').value || '-',
                mid: document.getElementById('new-mid').value || '-',
                business: business,
                pos: document.getElementById('new-pos').value || '-',
                supportType: document.getElementById('new-support-type').value || 'Customer Support',
                concern: concern,
                config: document.getElementById('new-config').value || '',
                remark: document.getElementById('new-remark').value || '',
                status: document.getElementById('new-status').value || 'Not Completed',
                reason: document.getElementById('new-reason').value || '',
                phone: document.getElementById('new-phone')?.value || '' // ‚ú® NEW: Phone Capture
            };

            // Show loading
            document.getElementById('loading-overlay').classList.add('show');

            google.script.run
                .withSuccessHandler(function (res) {
                    document.getElementById('loading-overlay').classList.remove('show');

                    try {
                        const result = JSON.parse(res);

                        if (result.success) {
                            showToast('‚úÖ Ticket created: ' + result.ticketId, 'success', 3000);
                            closeCreateModal();

                            // ‚úÖ Try optimistic update, fallback to full refresh
                            try {
                                addTicketOptimistic(result.ticketId, ticketData);
                                console.log('‚úÖ Optimistic update successful');
                            } catch (optimisticError) {
                                console.warn('‚ö†Ô∏è Optimistic update failed, using full refresh:', optimisticError);
                                fetchData(); // Fallback to full data refresh
                            }
                        } else {
                            showToast('‚ùå ' + result.error, 'error', 4000);
                        }
                    } catch (e) {
                        console.error('‚ùå Parse error:', e);
                        console.error('Raw response:', res);
                        showToast('‚ùå Parse error: ' + e.message, 'error', 4000);
                    }
                })
                .withFailureHandler(function (err) {
                    document.getElementById('loading-overlay').classList.remove('show');
                    console.error('‚ùå Network error:', err);
                    showToast('‚ùå Failed to create ticket: ' + err.message, 'error', 4000);
                })
                .createNewTicket(ticketData);
        }



        // ‚úÖ NEW: Add ticket optimistically
        function addTicketOptimistic(ticketId, ticketData) {
            const now = new Date();

            // ‚úÖ Format date correctly for frontend (dd-MM-yyyy)
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            const formattedDate = `${day}-${month}-${year}`;

            const newTicket = {
                id: ticketId,
                rowIndex: RAW_DATA.length + 2,
                timestamp: now,
                date: formattedDate,  // ‚úÖ Now uses frontend formatting
                sortDate: now.getTime(),
                hourIST: now.getHours(),
                ageDays: 0,
                ageCategory: 'fresh',
                email: ticketData.email || '',
                agent: ticketData.agent || 'Unassigned',
                requestedBy: ticketData.requestedBy || '-',
                mid: ticketData.mid || '-',
                business: ticketData.business || '-',
                pos: ticketData.pos || '-',
                supportType: ticketData.supportType || 'Customer Support',
                concern: ticketData.concern || 'Unspecified',
                config: ticketData.config || '',
                remark: ticketData.remark || '',
                status: ticketData.status || 'Not Completed',
                reason: ticketData.reason || '',
                invalidClosed: false,
                validationReason: '',
                validationWarnings: [],
                reasonQuality: calculateReasonQuality(ticketData.reason || '')  // ‚úÖ FIXED: Added missing reasonQuality
            };

            // Add to start of array (newest first)
            RAW_DATA.unshift(newTicket);

            // Refresh view
            refreshCurrentView();

            console.log('‚úÖ New ticket added to UI:', ticketId);
        }



        // ==========================================
        // üìä TEAM PERFORMANCE VIEW
        // ==========================================
        function renderDetailedTeamReport() {
            const agents = getAgentStats();

            document.getElementById('full-team-report').innerHTML = agents.map((a, i) => {
                const rate = a.total ? Math.round((a.comp / a.total) * 100) : 0;
                const scoreClass = a.score > 0 ? 'score-positive' : a.score < 0 ? 'score-negative' : 'score-neutral';
                const rankClass = i < 3 ? `rank-${i + 1}` : '';

                // Concern breakdown for this agent
                const concernCounts = {};
                DATE_DATA.filter(t => t.agent === a.name).forEach(t => {
                    concernCounts[t.concern] = (concernCounts[t.concern] || 0) + 1;
                });

                const topConcerns = Object.entries(concernCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([name, count]) => {
                        const pct = a.total ? Math.round((count / a.total) * 100) : 0;
                        return `
                <div class="bar-row">
                    <span class="bar-name">${name}</span>
                    <div class="bar-visual"><div class="bar-in" style="width:${pct}%; background:#4F46E5;"></div></div>
                    <span class="bar-count">${count}</span>
                </div>
                `;
                    }).join('');

                // Support type breakdown
                const typeCounts = {};
                DATE_DATA.filter(t => t.agent === a.name).forEach(t => {
                    typeCounts[t.supportType] = (typeCounts[t.supportType] || 0) + 1;
                });

                const topTypes = Object.entries(typeCounts)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, count]) => {
                        const pct = a.total ? Math.round((count / a.total) * 100) : 0;
                        return `
                <div class="bar-row">
                    <span class="bar-name">${name}</span>
                    <div class="bar-visual"><div class="bar-in" style="width:${pct}%; background:#059669;"></div></div>
                    <span class="bar-count">${count}</span>
                </div>
                `;
                    }).join('');

                return `
        <div class="report-card ${rankClass}">
            <div class="rep-header">
                <div class="rep-info">
                    <h3>${a.name}</h3>
                    <p>Rank #${i + 1} ‚Ä¢ ${rate}% Completion Rate</p>
                </div>
                <div class="rep-score-box">
                    <span class="rep-score-val ${scoreClass}">${a.score > 0 ? '+' : ''}${a.score}</span>
                    <span class="rep-score-lbl">Performance Score</span>
                </div>
            </div>
            <div class="rep-body">
                <div class="rep-stats-row">
                    <div class="s-box sb-total">
                        <span class="sb-val">${a.total}</span><span class="sb-lbl">Total</span>
                    </div>
                    <div class="s-box sb-done">
                        <span class="sb-val">${a.comp}</span><span class="sb-lbl">Completed</span>
                    </div>
                    <div class="s-box sb-pend">
                        <span class="sb-val">${a.not}</span><span class="sb-lbl">Pending</span>
                    </div>
                    <div class="s-box sb-closed">
                        <span class="sb-val">${a.validClosed}</span><span class="sb-lbl">Closed</span>
                    </div>
                    <div class="s-box sb-cant">
                        <span class="sb-val">${a.cant}</span><span class="sb-lbl">Can't Do</span>
                    </div>
                    <div class="s-box sb-invalid">
                        <span class="sb-val">${a.invalidClosed}</span><span class="sb-lbl">Invalid</span>
                    </div>
                </div>
                
                <div class="load-bar-wrap">
                    <div class="load-meta">
                        <span>Workload Share</span>
                        <span>${a.total} tickets (${Math.round((a.total / DATE_DATA.length) * 100)}%)</span>
                    </div>
                    <div class="load-bg">
                        <div class="load-fill" style="width:${(a.total / DATE_DATA.length) * 100}%;"></div>
                    </div>
                </div>
                
                <div class="lists-grid">
                    <div>
                        <span class="lg-title">Top Issues Handled</span>
                        ${topConcerns || '<p style="color:#999;">No data</p>'}
                    </div>
                    <div>
                        <span class="lg-title">Support Type Mix</span>
                        ${topTypes || '<p style="color:#999;">No data</p>'}
                    </div>
                </div>
            </div>
        </div>
        `;
            }).join('');
        }
        /* ==========================================
           üèÜ AGENT PERFORMANCE LEADERBOARD
           ========================================== */

        function renderLeaderboard(period = 'all', btn) {
            console.log('üìä Rendering leaderboard for period:', period);

            // Update active button - NEW STYLING
            if (btn) {
                document.querySelectorAll('#view-team .pill').forEach(p => {
                    p.style.background = 'transparent';
                    p.style.color = 'white';
                    p.style.border = '1px solid rgba(255,255,255,0.3)';
                });
                btn.style.background = 'rgba(255,255,255,0.2)';
                btn.style.color = 'white';
                btn.style.border = '1px solid rgba(255,255,255,0.5)';
            }

            // Filter tickets by period
            const now = new Date();
            let startDate;

            if (period === 'week') {
                startDate = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
                document.getElementById('leaderboard-period').textContent = 'This Week';
            } else if (period === 'month') {
                startDate = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                document.getElementById('leaderboard-period').textContent = 'This Month';
            } else {
                startDate = new Date(0); // All time
                document.getElementById('leaderboard-period').textContent = 'All Time';
            }

            const filteredTickets = RAW_DATA.filter(t => t.sortDate >= startDate.getTime());

            // Calculate agent stats
            const agents = {};

            filteredTickets.forEach(t => {
                if (!agents[t.agent]) {
                    agents[t.agent] = {
                        name: t.agent,
                        total: 0,
                        completed: 0,
                        closed: 0,
                        validClosed: 0,
                        cantDo: 0,
                        invalidClosed: 0,
                        pendingOld: 0,
                        totalDays: 0,
                        completedDays: 0,
                        badges: []
                    };
                }

                const a = agents[t.agent];
                a.total++;
                const st = t.status.toLowerCase();

                // ‚úÖ ONLY COUNT TICKETS - NO SCORING HERE
                if (st === 'completed') {
                    a.completed++;
                    a.completedDays += t.ageDays;
                } else if (st === 'closed') {
                    a.closed++;
                    if (!t.invalidClosed) {
                        a.validClosed++;
                    } else {
                        a.invalidClosed++;
                    }
                } else if (st.includes("can't")) {
                    a.cantDo++;
                }

                // Count old pending
                if (t.ageDays > 7 && st !== 'completed' && st !== 'closed') {
                    a.pendingOld++;
                }
            });



            // Calculate derived metrics and assign badges
            const agentArray = Object.values(agents);

            agentArray.forEach(a => {
                // ‚úÖ UNIFIED SCORING FORMULA (matches getAgentStats)
                a.points = (a.completed * 10) + (a.validClosed * 0) - (a.cantDo * 5) - (a.invalidClosed * 10) - (a.pendingOld * 3);

                a.completionRate = a.total > 0 ? Math.round((a.completed / a.total) * 100) : 0;
                a.avgResolutionDays = a.completed > 0 ? Math.round(a.completedDays / a.completed) : 0;

                // Award badges
                if (a.completionRate >= 90) a.badges.push({ icon: 'üéØ', name: 'Sharpshooter', color: '#10B981' });
                if (a.avgResolutionDays <= 2) a.badges.push({ icon: '‚ö°', name: 'Speed Demon', color: '#F59E0B' });
                if (a.total >= 50 && period === 'week') a.badges.push({ icon: 'üí™', name: 'Workhorse', color: '#8B5CF6' });
                if (a.invalidClosed === 0 && a.total >= 10) a.badges.push({ icon: '‚ú®', name: 'Quality Pro', color: '#3B82F6' });
                if (a.cantDo === 0 && a.total >= 20) a.badges.push({ icon: 'üîß', name: 'Problem Solver', color: '#EF4444' });
                // Bonus points for excellence
                if (a.completionRate >= 95) a.points += 20;

            });



            // Sort by points
            agentArray.sort((a, b) => b.points - a.points);

            // Render podium (top 3)
            renderPodium(agentArray.slice(0, 3));

            // Render full table
            renderLeaderboardTable(agentArray);

            // Update timestamp
            document.getElementById('leaderboard-updated').textContent = 'just now';
        }

        function renderPodium(top3) {
            const podium = document.getElementById('leaderboard-podium');

            if (top3.length === 0) {
                podium.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color:#94A3B8;">No data available</p>';
                return;
            }

            // Rearrange as: 2nd, 1st, 3rd
            const order = [top3[1], top3[0], top3[2]].filter(Boolean);

            podium.innerHTML = order.map((agent, idx) => {
                if (!agent) return '';

                const position = idx === 1 ? 1 : idx === 0 ? 2 : 3;
                const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : 'ü•â';
                const height = position === 1 ? '200px' : position === 2 ? '160px' : '140px';
                const bgGradient = position === 1
                    ? 'linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%)'
                    : position === 2
                        ? 'linear-gradient(135deg, #F1F5F9 0%, #E2E8F0 100%)'
                        : 'linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%)';

                return `
        <div style="background:white; border-radius:16px; padding:24px; text-align:center; border:2px solid ${position === 1 ? '#F59E0B' : position === 2 ? '#94A3B8' : '#D97706'}; order:${idx === 1 ? 1 : idx === 0 ? 2 : 3};">
            <div style="font-size:48px; margin-bottom:12px;">${medal}</div>
            <div style="font-size:18px; font-weight:800; color:#1E293B; margin-bottom:8px;">${agent.name}</div>
            <div style="font-size:36px; font-weight:800; color:#667eea; margin-bottom:8px;">${agent.points}</div>
            <div style="font-size:11px; font-weight:700; text-transform:uppercase; color:#64748B; margin-bottom:16px;">points</div>
            <div style="display:flex; justify-content:space-around; margin-bottom:12px; font-size:12px;">
                <div>
                    <div style="font-weight:800; color:#059669;">${agent.completed}</div>
                    <div style="font-size:10px; color:#64748B;">Done</div>
                </div>
                <div>
                    <div style="font-weight:800; color:#667eea;">${agent.completionRate}%</div>
                    <div style="font-size:10px; color:#64748B;">Rate</div>
                </div>
                <div>
                    <div style="font-weight:800; color:#F59E0B;">${agent.avgResolutionDays}d</div>
                    <div style="font-size:10px; color:#64748B;">Avg</div>
                </div>
            </div>
            <div style="display:flex; gap:4px; justify-content:center; flex-wrap:wrap;">
                ${agent.badges.map(b => `<span title="${b.name}" style="font-size:20px;">${b.icon}</span>`).join('')}
            </div>
        </div>
        `;
            }).join('');
        }

        function renderLeaderboardTable(agents) {
            const tbody = document.getElementById('leaderboard-table');

            tbody.innerHTML = agents.map((agent, idx) => {
                const rank = idx + 1;
                const rankDisplay = rank <= 3
                    ? `<span style="font-size:24px;">${rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : 'ü•â'}</span>`
                    : `<strong>#${rank}</strong>`;

                const badgesHTML = agent.badges.length > 0
                    ? agent.badges.map(b => `<span title="${b.name}" style="font-size:18px; margin:0 2px;">${b.icon}</span>`).join('')
                    : '<span style="color:#94A3B8;">-</span>';

                return `
        <tr style="${rank <= 3 ? 'background: linear-gradient(to right, #F8FAFC, white);' : ''}">
            <td style="text-align:center;">${rankDisplay}</td>
            <td><strong>${agent.name}</strong></td>
            <td><strong style="color:#667eea; font-size:16px;">${agent.points}</strong></td>
            <td>${agent.total}</td>
            <td><span style="color:#059669; font-weight:700;">${agent.completed}</span></td>
            <td><strong>${agent.completionRate}%</strong></td>
            <td>${agent.avgResolutionDays}d</td>
            <td>${badgesHTML}</td>
        </tr>
        `;
            }).join('');
        }


        // ==========================================
        // üìä ANALYTICS VIEW
        // ==========================================
        function renderAnalytics() {
            renderMIDChart();
            renderHoursChart();
            renderIssuesChart();
            renderAgentsChart();
            renderDailyLoadChart();
            renderWeeklyLoadChart();
            renderCompletionRateChart();
            renderStatusDistChart();
            renderSkillMix();
        }

        // ‚úÖ Fixed Hours Chart (Uses hourIST from backend)
        function renderHoursChart() {
            const canvas = document.getElementById('c-hours');
            if (!canvas) return; // ‚úÖ Canvas check

            if (CHARTS['hours']) {
                CHARTS['hours'].destroy();
                delete CHARTS['hours'];
            }

            const hours = {};
            DATE_DATA.forEach(t => {
                // ‚úÖ Use hourIST from backend (already in India timezone)
                if (t.hourIST !== undefined) {
                    hours[t.hourIST] = (hours[t.hourIST] || 0) + 1;
                }
            });

            const labels = Array.from({ length: 24 }, (_, i) => i + ':00');
            const data = labels.map((l, i) => hours[i] || 0);

            CHARTS['hours'] = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tickets per Hour',
                        data: data,
                        borderColor: '#4F46E5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderMIDChart() {
            const canvas = document.getElementById('c-mids');
            if (!canvas) return; // ‚úÖ Canvas check

            if (CHARTS['mids']) {
                CHARTS['mids'].destroy();
                delete CHARTS['mids'];
            }

            const midCounts = {};
            DATE_DATA.forEach(t => {
                if (t.mid && t.mid !== '-') {
                    midCounts[t.mid] = (midCounts[t.mid] || 0) + 1;
                }
            });

            const sorted = Object.entries(midCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

            CHARTS['mids'] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: sorted.map(x => x[0]),
                    datasets: [{
                        label: 'Ticket Count',
                        data: sorted.map(x => x[1]),
                        backgroundColor: '#DC2626'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderIssuesChart() {
            const canvas = document.getElementById('c-issues');
            if (!canvas) return;

            if (CHARTS['issues']) {
                CHARTS['issues'].destroy();
                delete CHARTS['issues'];
            }

            const counts = {};
            DATE_DATA.forEach(t => {
                counts[t.concern] = (counts[t.concern] || 0) + 1;
            });

            CHARTS['issues'] = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: ['#4F46E5', '#059669', '#D97706', '#DC2626', '#2563EB', '#F59E0B']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderAgentsChart() {
            const canvas = document.getElementById('c-agents');
            if (!canvas) return;

            if (CHARTS['agents']) {
                CHARTS['agents'].destroy();
                delete CHARTS['agents'];
            }

            const agents = getAgentStats();

            CHARTS['agents'] = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: agents.map(a => a.name),
                    datasets: [{
                        data: agents.map(a => a.total),
                        backgroundColor: ['#4F46E5', '#059669', '#D97706', '#DC2626']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderDailyLoadChart() {
            const canvas = document.getElementById('c-daily-load');
            if (!canvas) return;

            if (CHARTS['daily']) {
                CHARTS['daily'].destroy();
                delete CHARTS['daily'];
            }

            const agents = getAgentStats();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

            // ‚úÖ Calculate actual tickets per day of week
            const datasets = agents.map((agent, i) => {
                const colors = ['#4F46E5', '#059669', '#D97706', '#DC2626'];
                const agentTickets = DATE_DATA.filter(t => t.agent === agent.name);

                // Count tickets per day of week (0=Sunday, 6=Saturday)
                const dayCounts = [0, 0, 0, 0, 0, 0, 0];
                agentTickets.forEach(t => {
                    if (t.timestamp instanceof Date) {
                        const dayOfWeek = t.timestamp.getDay(); // Returns 0-6
                        dayCounts[dayOfWeek]++;
                    }
                });

                return {
                    label: agent.name,
                    data: dayCounts,
                    backgroundColor: colors[i % colors.length],
                    borderWidth: 1,
                    borderColor: '#fff'
                };
            });

            CHARTS['daily'] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: dayNames,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        x: { stacked: false },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });
        }


        function renderWeeklyLoadChart() {
            const canvas = document.getElementById('c-weekly-load');
            if (!canvas) return;

            if (CHARTS['weekly']) {
                CHARTS['weekly'].destroy();
                delete CHARTS['weekly'];
            }

            const agents = getAgentStats();

            CHARTS['weekly'] = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: agents.map(a => a.name),
                    datasets: [{
                        label: 'Total Tickets',
                        data: agents.map(a => a.total),
                        borderColor: '#4F46E5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderCompletionRateChart() {
            const canvas = document.getElementById('c-completion-rate');
            if (!canvas) return;

            if (CHARTS['completion']) {
                CHARTS['completion'].destroy();
                delete CHARTS['completion'];
            }

            const agents = getAgentStats();

            CHARTS['completion'] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: agents.map(a => a.name),
                    datasets: [{
                        label: 'Completion Rate (%)',
                        data: agents.map(a => a.completionRate),
                        backgroundColor: agents.map(a => a.completionRate >= 60 ? '#059669' : a.completionRate >= 30 ? '#D97706' : '#DC2626')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { max: 100 } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderStatusDistChart() {
            const canvas = document.getElementById('c-status-dist');
            if (!canvas) return;

            if (CHARTS['statusdist']) {
                CHARTS['statusdist'].destroy();
                delete CHARTS['statusdist'];
            }

            const agents = getAgentStats();

            CHARTS['statusdist'] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: agents.map(a => a.name),
                    datasets: [
                        {
                            label: 'Completed',
                            data: agents.map(a => a.comp),
                            backgroundColor: '#059669'
                        },
                        {
                            label: 'Pending',
                            data: agents.map(a => a.not),
                            backgroundColor: '#D97706'
                        },
                        {
                            label: 'Closed',
                            data: agents.map(a => a.validClosed),
                            backgroundColor: '#475569'
                        },
                        {
                            label: "Can't Do",
                            data: agents.map(a => a.cant),
                            backgroundColor: '#DC2626'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } }
                }
            });
        }

        function renderSkillMix() {
            const agents = getAgentStats();

            const skillData = agents.map(a => {
                const agentTickets = DATE_DATA.filter(t => t.agent === a.name);
                const concernCounts = {};

                agentTickets.forEach(t => {
                    concernCounts[t.concern] = (concernCounts[t.concern] || 0) + 1;
                });

                const topSkill = Object.entries(concernCounts)
                    .sort((a, b) => b[1] - a[1])[0];

                return {
                    name: a.name,
                    specialty: topSkill ? topSkill[0] : 'N/A',
                    count: topSkill ? topSkill[1] : 0,
                    diversity: Object.keys(concernCounts).length
                };
            });

            document.getElementById('skill-mix-container').innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 12px; border: 1px solid var(--border);">
            <h4 style="margin: 0 0 20px; font-size: 16px;">Agent Specialization Matrix</h4>
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Agent</th>
                        <th>Top Specialty</th>
                        <th>Count</th>
                        <th>Issue Diversity</th>
                    </tr>
                </thead>
                <tbody>
                    ${skillData.map(s => `
                        <tr>
                            <td><strong>${s.name}</strong></td>
                            <td>${s.specialty}</td>
                            <td>${s.count}</td>
                            <td>${s.diversity} types</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
        }

        // ========================================
        // üìä ADVANCED ANALYTICS WITH DATE FILTER SUPPORT
        // ========================================
        function renderAdvancedAnalytics() {
            console.log('üîÑ Rendering advanced analytics with filtered data...');
            console.log('üìä DATE_DATA length:', DATE_DATA ? DATE_DATA.length : 0);

            if (!DATE_DATA || DATE_DATA.length === 0) {
                console.warn('‚ö†Ô∏è No data available in selected date range');
                clearAllAdvancedCharts();
                return;
            }

            const tickets = DATE_DATA; // ‚úÖ CORRECTED: DATE_DATA not DATEDATA

            try {
                // 1. Top MIDs - Same Recurring Issue
                renderMIDSameConcern(tickets);

                // 2. Top MIDs - Different Concerns
                renderMIDDiffConcern(tickets);

                // 3. Top POS Systems
                renderTopPOS(tickets);

                // 4. Repeat Customers
                renderRepeatCustomers(tickets);

                // 5. Floor Support Table
                renderFloorSupport(tickets);

                // 6. Concern Trends
                renderConcernTrends(tickets);

                // 7. Agent Specialization
                renderAgentSpecialization(tickets);

                console.log('‚úÖ Advanced analytics rendered successfully');
            } catch (e) {
                console.error('‚ùå Error rendering advanced analytics:', e);
            }
        }

        // Clear all charts when no data
        function clearAllAdvancedCharts() {
            const chartIds = [
                'c-mid-same-concern',
                'c-mid-diff-concern',
                'c-top-pos',
                'c-repeat-customers',
                'c-concern-trends',
                'c-agent-specialization'
            ];

            chartIds.forEach(id => {
                if (CHARTS[id]) {
                    CHARTS[id].destroy();
                    delete CHARTS[id];
                }
                const ctx = document.getElementById(id);
                if (ctx) {
                    const parent = ctx.parentElement;
                    parent.innerHTML = `<canvas id="${id}"></canvas><div style="text-align:center;padding:40px;color:#94A3B8;">No data in selected date range</div>`;
                }
            });

            const tbody = document.getElementById('floor-support-table');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:30px;color:#94A3B8;">No IT Floor Support tickets in selected date range</td></tr>';
            }
        }

        // ========================================
        // 1Ô∏è‚É£ TOP MIDs - SAME RECURRING ISSUE
        // ========================================
        function renderMIDSameConcern(tickets) {
            const excludeMIDs = ['301', '201', '202', '302'];  // ‚úÖ FIXED: Renamed + added '201'
            const midConcernMap = {};

            tickets.forEach(t => {
                // ‚úÖ FIXED: Now checks t.mid against excludeMIDs
                if (!t.mid || t.mid === '-' || excludeMIDs.includes(t.mid)) return;

                const key = `${t.mid}|||${t.concern}`;
                if (!midConcernMap[key]) {
                    midConcernMap[key] = {
                        mid: t.mid,
                        concern: t.concern,
                        business: t.business,
                        count: 0
                    };
                }
                midConcernMap[key].count++;
            });

            const data = Object.values(midConcernMap)
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            console.log('üìä Same Concern Data:', data.length, 'items');

            const ctx = document.getElementById('c-mid-same-concern');
            if (!ctx) {
                console.error('Canvas element c-mid-same-concern not found');
                return;
            }

            if (CHARTS['c-mid-same-concern']) {
                CHARTS['c-mid-same-concern'].destroy();
            }

            if (data.length === 0) {
                ctx.parentElement.innerHTML = '<canvas id="c-mid-same-concern"></canvas><div style="text-align:center;padding:40px;color:#94A3B8;">No recurring issues found</div>';
                return;
            }

            CHARTS['c-mid-same-concern'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => `${d.mid}\n${d.business.substring(0, 20)}`),
                    datasets: [{
                        label: 'Ticket Count',
                        data: data.map(d => d.count),
                        backgroundColor: '#EF4444',
                        borderColor: '#DC2626',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const item = data[context.dataIndex];
                                    return [
                                        `Tickets: ${item.count}`,
                                        `Concern: ${item.concern}`,
                                        `Business: ${item.business}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, ticks: { precision: 0 } }
                    }
                }
            });
        }

        // ========================================
        // 2Ô∏è‚É£ TOP MIDs - DIFFERENT CONCERNS
        // ========================================
        function renderMIDDiffConcern(tickets) {
            const excludeMIDs = ['301', '201', '202', '302'];  // ‚úÖ FIXED: Renamed + added '201'
            const midMap = {};

            tickets.forEach(t => {
                // ‚úÖ FIXED: Now checks t.mid against excludeMIDs
                if (!t.mid || t.mid === '-' || excludeMIDs.includes(t.mid)) return;

                if (!midMap[t.mid]) {
                    midMap[t.mid] = {
                        mid: t.mid,
                        business: t.business,
                        concerns: new Set(),
                        totalTickets: 0
                    };
                }
                midMap[t.mid].concerns.add(t.concern);
                midMap[t.mid].totalTickets++;
            });

            const data = Object.values(midMap)
                .map(m => ({
                    mid: m.mid,
                    business: m.business,
                    concernCount: m.concerns.size,
                    concerns: Array.from(m.concerns),
                    totalTickets: m.totalTickets
                }))
                .filter(m => m.concernCount > 1)
                .sort((a, b) => b.concernCount - a.concernCount)
                .slice(0, 10);

            console.log('üìä Different Concerns Data:', data.length, 'items');

            const ctx = document.getElementById('c-mid-diff-concern');
            if (!ctx) {
                console.error('Canvas element c-mid-diff-concern not found');
                return;
            }

            if (CHARTS['c-mid-diff-concern']) {
                CHARTS['c-mid-diff-concern'].destroy();
            }

            if (data.length === 0) {
                ctx.parentElement.innerHTML = '<canvas id="c-mid-diff-concern"></canvas><div style="text-align:center;padding:40px;color:#94A3B8;">No MIDs with multiple issues</div>';
                return;
            }

            CHARTS['c-mid-diff-concern'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => `${d.mid}\n${d.business.substring(0, 20)}`),
                    datasets: [{
                        label: 'Different Concerns',
                        data: data.map(d => d.concernCount),
                        backgroundColor: '#F59E0B',
                        borderColor: '#D97706',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const item = data[context.dataIndex];
                                    return [
                                        `Different Issues: ${item.concernCount}`,
                                        `Total Tickets: ${item.totalTickets}`,
                                        `Concerns: ${item.concerns.join(', ')}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, ticks: { precision: 0 } }
                    }
                }
            });
        }

        // ========================================
        // 3Ô∏è‚É£ TOP POS SYSTEMS
        // ========================================
        function renderTopPOS(tickets) {
            const excludePOS = ['bf', 'Bf', 'BF', 'Billfree', 'billfree', 'BillFree', '-', ''];
            const posMap = {};

            tickets.forEach(t => {
                const pos = String(t.pos || '').trim();
                if (!pos || excludePOS.includes(pos)) return;

                if (!posMap[pos]) {
                    posMap[pos] = {
                        pos: pos,
                        count: 0,
                        businesses: new Set()
                    };
                }
                posMap[pos].count++;
                posMap[pos].businesses.add(t.business);
            });

            const data = Object.values(posMap)
                .map(p => ({
                    pos: p.pos,
                    count: p.count,
                    businessCount: p.businesses.size
                }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            console.log('üìä POS Data:', data.length, 'items');

            const ctx = document.getElementById('c-top-pos');
            if (!ctx) {
                console.error('Canvas element c-top-pos not found');
                return;
            }

            if (CHARTS['c-top-pos']) {
                CHARTS['c-top-pos'].destroy();
            }

            if (data.length === 0) {
                ctx.parentElement.innerHTML = '<canvas id="c-top-pos"></canvas><div style="text-align:center;padding:40px;color:#94A3B8;">No POS data available</div>';
                return;
            }

            CHARTS['c-top-pos'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.pos),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                            '#a8edea', '#fed6e3'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const item = data[context.dataIndex];
                                    return [
                                        `${item.pos}: ${item.count} tickets`,
                                        `Used by ${item.businessCount} businesses`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // ========================================
        // 4Ô∏è‚É£ REPEAT CUSTOMERS
        // ========================================
        function renderRepeatCustomers(tickets) {
            const businessMap = {};

            tickets.forEach(t => {
                if (!t.business || t.business === '-') return;

                if (!businessMap[t.business]) {
                    businessMap[t.business] = {
                        business: t.business,
                        mid: t.mid,
                        ticketCount: 0,
                        concerns: new Set(),
                        completedCount: 0,
                        totalDays: 0
                    };
                }
                businessMap[t.business].ticketCount++;
                businessMap[t.business].concerns.add(t.concern);

                if (t.status.toLowerCase() === 'completed') {
                    businessMap[t.business].completedCount++;
                    businessMap[t.business].totalDays += t.ageDays;
                }
            });

            const data = Object.values(businessMap)
                .filter(b => b.ticketCount >= 3)
                .map(b => ({
                    business: b.business,
                    mid: b.mid,
                    ticketCount: b.ticketCount,
                    concernCount: b.concerns.size,
                    completionRate: Math.round((b.completedCount / b.ticketCount) * 100)
                }))
                .sort((a, b) => b.ticketCount - a.ticketCount)
                .slice(0, 10);

            console.log('üìä Repeat Customers Data:', data.length, 'items');

            const ctx = document.getElementById('c-repeat-customers');
            if (!ctx) {
                console.error('Canvas element c-repeat-customers not found');
                return;
            }

            if (CHARTS['c-repeat-customers']) {
                CHARTS['c-repeat-customers'].destroy();
            }

            if (data.length === 0) {
                ctx.parentElement.innerHTML = '<canvas id="c-repeat-customers"></canvas><div style="text-align:center;padding:40px;color:#94A3B8;">No repeat customers (need 3+ tickets)</div>';
                return;
            }

            CHARTS['c-repeat-customers'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.business.substring(0, 25)),
                    datasets: [{
                        label: 'Total Tickets',
                        data: data.map(d => d.ticketCount),
                        backgroundColor: '#8B5CF6',
                        yAxisID: 'y'
                    }, {
                        label: 'Completion Rate %',
                        data: data.map(d => d.completionRate),
                        backgroundColor: '#10B981',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { type: 'linear', position: 'left', beginAtZero: true, ticks: { precision: 0 } },
                        y1: { type: 'linear', position: 'right', beginAtZero: true, max: 100, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        // ========================================
        // 5Ô∏è‚É£ FLOOR SUPPORT TABLE
        // ========================================
        function renderFloorSupport(tickets) {
            const data = tickets
                .filter(t => t.supportType === 'IT Floor Support')
                .sort((a, b) => b.sortDate - a.sortDate)
                .slice(0, 5);

            console.log('üìä Floor Support Data:', data.length, 'items');

            const tbody = document.getElementById('floor-support-table');
            if (!tbody) {
                console.error('Table body floor-support-table not found');
                return;
            }

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:30px;color:#94A3B8;">No IT Floor Support tickets in selected date range</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(t => {
                const statusClass = t.status.toLowerCase() === 'completed' ? 's-done' :
                    t.status.toLowerCase() === 'closed' ? 's-closed' : 's-pend';
                return `
        <tr>
            <td><strong>${t.id}</strong></td>
            <td>${t.date}</td>
            <td>${t.agent}</td>
            <td>${t.requestedBy}</td>
            <td>${t.business}</td>
            <td>${t.concern}</td>
            <td style="max-width:250px;font-size:11px;">${t.remark || '-'}</td>
            <td><span class="badge ${statusClass}">${t.status}</span></td>
            <td><strong>${t.ageDays}d</strong></td>
        </tr>
        `;
            }).join('');
        }

        // ========================================
        // 6Ô∏è‚É£ CONCERN TRENDS
        // ========================================
        function renderConcernTrends(tickets) {
            const now = new Date();
            const last30Days = now.getTime() - (30 * 24 * 60 * 60 * 1000);
            const last60to30Days = now.getTime() - (60 * 24 * 60 * 60 * 1000);

            const concernMapCurrent = {};
            const concernMapPrevious = {};

            tickets.forEach(t => {
                if (t.sortDate >= last30Days) {
                    concernMapCurrent[t.concern] = (concernMapCurrent[t.concern] || 0) + 1;
                } else if (t.sortDate >= last60to30Days && t.sortDate < last30Days) {
                    concernMapPrevious[t.concern] = (concernMapPrevious[t.concern] || 0) + 1;
                }
            });

            const allConcerns = new Set([...Object.keys(concernMapCurrent), ...Object.keys(concernMapPrevious)]);

            const data = Array.from(allConcerns).map(concern => {
                const current = concernMapCurrent[concern] || 0;
                const previous = concernMapPrevious[concern] || 0;
                const change = previous > 0 ? Math.round(((current - previous) / previous) * 100) : (current > 0 ? 100 : 0);

                return {
                    concern: concern,
                    currentMonth: current,
                    previousMonth: previous,
                    changePercent: change,
                    trend: change > 10 ? 'rising' : change < -10 ? 'falling' : 'stable'
                };
            }).sort((a, b) => b.currentMonth - a.currentMonth).slice(0, 10);

            console.log('üìä Concern Trends Data:', data.length, 'items');

            const ctx = document.getElementById('c-concern-trends');
            if (!ctx) {
                console.error('Canvas element c-concern-trends not found');
                return;
            }

            if (CHARTS['c-concern-trends']) {
                CHARTS['c-concern-trends'].destroy();
            }

            if (data.length === 0) {
                ctx.parentElement.innerHTML = '<canvas id="c-concern-trends"></canvas><div style="text-align:center;padding:40px;color:#94A3B8;">Not enough data for trend analysis</div>';
                return;
            }

            CHARTS['c-concern-trends'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.concern),
                    datasets: [{
                        label: 'Last 30 Days',
                        data: data.map(d => d.currentMonth),
                        backgroundColor: '#3B82F6'
                    }, {
                        label: 'Previous 30 Days',
                        data: data.map(d => d.previousMonth),
                        backgroundColor: '#9CA3AF'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { precision: 0 } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function (context) {
                                    const item = data[context.dataIndex];
                                    return `Change: ${item.changePercent > 0 ? '+' : ''}${item.changePercent}% (${item.trend})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ========================================
        // 7Ô∏è‚É£ AGENT SPECIALIZATION MATRIX
        // ========================================
        function renderAgentSpecialization(tickets) {
            const agentConcernMap = {};

            tickets.forEach(t => {
                if (!agentConcernMap[t.agent]) {
                    agentConcernMap[t.agent] = {};
                }
                if (!agentConcernMap[t.agent][t.concern]) {
                    agentConcernMap[t.agent][t.concern] = {
                        total: 0,
                        completed: 0
                    };
                }
                agentConcernMap[t.agent][t.concern].total++;
                if (t.status.toLowerCase() === 'completed') {
                    agentConcernMap[t.agent][t.concern].completed++;
                }
            });

            const specializations = [];
            for (const [agent, concerns] of Object.entries(agentConcernMap)) {
                for (const [concern, stats] of Object.entries(concerns)) {
                    if (stats.total >= 3) {
                        specializations.push({
                            agent: agent,
                            concern: concern,
                            ticketCount: stats.total,
                            completionRate: Math.round((stats.completed / stats.total) * 100),
                            expertise: stats.total >= 10 ? 'Expert' : stats.total >= 5 ? 'Experienced' : 'Learning'
                        });
                    }
                }
            }

            specializations.sort((a, b) => b.completionRate - a.completionRate);
            const data = specializations.slice(0, 20);

            console.log('üìä Agent Specialization Data:', data.length, 'items');

            const ctx = document.getElementById('c-agent-specialization');
            if (!ctx) {
                console.error('Canvas element c-agent-specialization not found');
                return;
            }

            if (CHARTS['c-agent-specialization']) {
                CHARTS['c-agent-specialization'].destroy();
            }

            if (data.length === 0) {
                ctx.parentElement.innerHTML = '<canvas id="c-agent-specialization"></canvas><div style="text-align:center;padding:40px;color:#94A3B8;">Not enough data for specialization analysis</div>';
                return;
            }

            CHARTS['c-agent-specialization'] = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Expert (10+ tickets)',
                        data: data.filter(d => d.expertise === 'Expert').map(d => ({
                            x: d.ticketCount,
                            y: d.completionRate,
                            label: `${d.agent} - ${d.concern}`
                        })),
                        backgroundColor: '#10B981',
                        pointRadius: 6
                    }, {
                        label: 'Experienced (5-9 tickets)',
                        data: data.filter(d => d.expertise === 'Experienced').map(d => ({
                            x: d.ticketCount,
                            y: d.completionRate,
                            label: `${d.agent} - ${d.concern}`
                        })),
                        backgroundColor: '#F59E0B',
                        pointRadius: 6
                    }, {
                        label: 'Learning (3-4 tickets)',
                        data: data.filter(d => d.expertise === 'Learning').map(d => ({
                            x: d.ticketCount,
                            y: d.completionRate,
                            label: `${d.agent} - ${d.concern}`
                        })),
                        backgroundColor: '#6366F1',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'Ticket Count' },
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        },
                        y: {
                            title: { display: true, text: 'Completion Rate %' },
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.raw.label + ` (${context.raw.y}% success, ${context.raw.x} tickets)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ========================================
        // CHART RENDERING FUNCTIONS
        // ========================================

        function renderMIDSameConcernChart(data) {
            const ctx = document.getElementById('c-mid-same-concern');
            if (!ctx || data.length === 0) return;

            // Destroy existing chart
            if (CHARTS['c-mid-same-concern']) {
                CHARTS['c-mid-same-concern'].destroy();
            }

            CHARTS['c-mid-same-concern'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => `${d.mid}\n${d.business.substring(0, 15)}`),
                    datasets: [{
                        label: 'Ticket Count',
                        data: data.map(d => d.count),
                        backgroundColor: '#EF4444',
                        borderColor: '#DC2626',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const item = data[context.dataIndex];
                                    return [
                                        `Tickets: ${item.count}`,
                                        `Concern: ${item.concern}`,
                                        `Business: ${item.business}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }

        function renderMIDDiffConcernChart(data) {
            const ctx = document.getElementById('c-mid-diff-concern');
            if (!ctx || data.length === 0) return;

            if (CHARTS['c-mid-diff-concern']) {
                CHARTS['c-mid-diff-concern'].destroy();
            }

            CHARTS['c-mid-diff-concern'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => `${d.mid}\n${d.business.substring(0, 15)}`),
                    datasets: [{
                        label: 'Different Concerns',
                        data: data.map(d => d.concernCount),
                        backgroundColor: '#F59E0B',
                        borderColor: '#D97706',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const item = data[context.dataIndex];
                                    return [
                                        `Different Issues: ${item.concernCount}`,
                                        `Total Tickets: ${item.totalTickets}`,
                                        `Concerns: ${item.concerns.join(', ')}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }

        function renderTopPOSChart(data) {
            const ctx = document.getElementById('c-top-pos');
            if (!ctx || data.length === 0) return;

            if (CHARTS['c-top-pos']) {
                CHARTS['c-top-pos'].destroy();
            }

            CHARTS['c-top-pos'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.pos),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                            '#a8edea', '#fed6e3'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const item = data[context.dataIndex];
                                    return [
                                        `${item.pos}: ${item.count} tickets`,
                                        `Used by ${item.businessCount} businesses`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderFloorSupportTable(data) {
            const tbody = document.getElementById('floor-support-table');
            if (!tbody) return;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:30px; color:#94A3B8;">No IT Floor Support tickets in selected date range</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(t => {
                const statusClass = t.status.toLowerCase() === 'completed' ? 's-done' :
                    t.status.toLowerCase() === 'closed' ? 's-closed' : 's-pend';
                return `
        <tr>
            <td><strong>${t.id}</strong></td>
            <td>${t.date}</td>
            <td>${t.agent}</td>
            <td>${t.requestedBy}</td>
            <td>${t.business}</td>
            <td>${t.concern}</td>
            <td style="max-width:250px; font-size:11px;">${t.remark || '-'}</td>
            <td><span class="badge ${statusClass}">${t.status}</span></td>
            <td><strong>${t.ageDays}d</strong></td>
        </tr>
        `;
            }).join('');
        }

        function renderRepeatCustomersChart(data) {
            const ctx = document.getElementById('c-repeat-customers');
            if (!ctx || data.length === 0) return;

            if (CHARTS['c-repeat-customers']) {
                CHARTS['c-repeat-customers'].destroy();
            }

            CHARTS['c-repeat-customers'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.business.substring(0, 20)),
                    datasets: [{
                        label: 'Total Tickets',
                        data: data.map(d => d.ticketCount),
                        backgroundColor: '#8B5CF6',
                        yAxisID: 'y'
                    }, {
                        label: 'Completion Rate %',
                        data: data.map(d => d.completionRate),
                        backgroundColor: '#10B981',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { type: 'linear', position: 'left', beginAtZero: true },
                        y1: { type: 'linear', position: 'right', beginAtZero: true, max: 100, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        function renderConcernTrendsChart(data) {
            const ctx = document.getElementById('c-concern-trends');
            if (!ctx || data.length === 0) return;

            if (CHARTS['c-concern-trends']) {
                CHARTS['c-concern-trends'].destroy();
            }

            const top10 = data.slice(0, 10);

            CHARTS['c-concern-trends'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(d => d.concern),
                    datasets: [{
                        label: 'Last 30 Days',
                        data: top10.map(d => d.currentMonth),
                        backgroundColor: '#3B82F6'
                    }, {
                        label: 'Previous 30 Days',
                        data: top10.map(d => d.previousMonth),
                        backgroundColor: '#9CA3AF'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function (context) {
                                    const item = top10[context.dataIndex];
                                    return `Change: ${item.changePercent > 0 ? '+' : ''}${item.changePercent}% (${item.trend})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderAgentSpecializationChart(data) {
            const ctx = document.getElementById('c-agent-specialization');
            if (!ctx || data.length === 0) return;

            if (CHARTS['c-agent-specialization']) {
                CHARTS['c-agent-specialization'].destroy();
            }

            const top15 = data.slice(0, 15);

            CHARTS['c-agent-specialization'] = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Expert',
                        data: top15.filter(d => d.expertise === 'Expert').map(d => ({
                            x: d.ticketCount,
                            y: d.completionRate,
                            label: `${d.agent} - ${d.concern}`
                        })),
                        backgroundColor: '#10B981'
                    }, {
                        label: 'Experienced',
                        data: top15.filter(d => d.expertise === 'Experienced').map(d => ({
                            x: d.ticketCount,
                            y: d.completionRate,
                            label: `${d.agent} - ${d.concern}`
                        })),
                        backgroundColor: '#F59E0B'
                    }, {
                        label: 'Learning',
                        data: top15.filter(d => d.expertise === 'Learning').map(d => ({
                            x: d.ticketCount,
                            y: d.completionRate,
                            label: `${d.agent} - ${d.concern}`
                        })),
                        backgroundColor: '#6366F1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Ticket Count' }, beginAtZero: true },
                        y: { title: { display: true, text: 'Completion Rate %' }, beginAtZero: true, max: 100 }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.raw.label + ` (${context.raw.y}% success)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ========================================
        // üìä ADDITIONAL ANALYTICS CHARTS
        // ========================================

        function renderIssuesChart() {
            const ctx = document.getElementById('c-issues');
            if (!ctx || !DATE_DATA || DATE_DATA.length === 0) {
                if (ctx) ctx.parentElement.innerHTML = '<canvas id="c-issues"></canvas><div style="text-align:center;padding:40px;color:#94A3B8;">No data available</div>';
                return;
            }

            // Aggregate by concern
            const concernCounts = {};
            DATE_DATA.forEach(t => {
                const concern = t.concern || 'Other';
                concernCounts[concern] = (concernCounts[concern] || 0) + 1;
            });

            const data = Object.entries(concernCounts)
                .map(([concern, count]) => ({ concern, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            if (CHARTS['c-issues']) CHARTS['c-issues'].destroy();

            CHARTS['c-issues'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.concern),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: ['#4F46E5', '#7C3AED', '#EC4899', '#EF4444', '#F59E0B', '#10B981', '#06B6D4', '#3B82F6', '#6366F1', '#8B5CF6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        function renderAgentsChart() {
            const ctx = document.getElementById('c-agents');
            if (!ctx || !DATE_DATA || DATE_DATA.length === 0) {
                if (ctx) ctx.parentElement.innerHTML = '<canvas id="c-agents"></canvas><div style="text-align:center;padding:40px;color:#94A3B8;">No data available</div>';
                return;
            }

            const agentCounts = {};
            DATE_DATA.forEach(t => {
                const agent = t.agent || 'Unknown';
                agentCounts[agent] = (agentCounts[agent] || 0) + 1;
            });

            const data = Object.entries(agentCounts).map(([agent, count]) => ({ agent, count })).sort((a, b) => b.count - a.count);

            if (CHARTS['c-agents']) CHARTS['c-agents'].destroy();

            CHARTS['c-agents'] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(d => d.agent),
                    datasets: [{ data: data.map(d => d.count), backgroundColor: ['#667eea', '#764ba2', '#10B981', '#F59E0B', '#EF4444'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        function renderWeeklyLoadChart() {
            const ctx = document.getElementById('c-weekly-load');
            if (!ctx || !DATE_DATA || DATE_DATA.length === 0) {
                if (ctx) ctx.parentElement.innerHTML = '<canvas id="c-weekly-load"></canvas><div style="text-align:center;padding:40px;color:#94A3B8;">No data available</div>';
                return;
            }

            // Get last 4 weeks
            const now = new Date();
            const weeks = [];
            for (let i = 3; i >= 0; i--) {
                const weekStart = new Date(now);
                weekStart.setDate(weekStart.getDate() - (i * 7) - weekStart.getDay());
                weeks.push({ start: weekStart, label: `Week ${4 - i}` });
            }

            const agents = [...new Set(DATE_DATA.map(t => t.agent))];
            const datasets = agents.map((agent, idx) => {
                const colors = ['#667eea', '#764ba2', '#10B981', '#F59E0B', '#EF4444'];
                return {
                    label: agent,
                    data: weeks.map(w => {
                        const weekEnd = new Date(w.start);
                        weekEnd.setDate(weekEnd.getDate() + 7);
                        return DATE_DATA.filter(t => t.agent === agent && t.sortDate >= w.start.getTime() && t.sortDate < weekEnd.getTime()).length;
                    }),
                    backgroundColor: colors[idx % colors.length]
                };
            });

            if (CHARTS['c-weekly-load']) CHARTS['c-weekly-load'].destroy();

            CHARTS['c-weekly-load'] = new Chart(ctx, {
                type: 'bar',
                data: { labels: weeks.map(w => w.label), datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: false }, y: { beginAtZero: true } } }
            });
        }

        function renderCompletionRateChart() {
            const ctx = document.getElementById('c-completion-rate');
            if (!ctx || !DATE_DATA || DATE_DATA.length === 0) {
                if (ctx) ctx.parentElement.innerHTML = '<canvas id="c-completion-rate"></canvas><div style="text-align:center;padding:40px;color:#94A3B8;">No data available</div>';
                return;
            }

            const agents = [...new Set(DATE_DATA.map(t => t.agent))];
            const data = agents.map(agent => {
                const agentTickets = DATE_DATA.filter(t => t.agent === agent);
                const completed = agentTickets.filter(t => t.status.toLowerCase() === 'completed').length;
                return { agent, total: agentTickets.length, completed, rate: agentTickets.length ? Math.round((completed / agentTickets.length) * 100) : 0 };
            }).sort((a, b) => b.rate - a.rate);

            if (CHARTS['c-completion-rate']) CHARTS['c-completion-rate'].destroy();

            CHARTS['c-completion-rate'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.agent),
                    datasets: [{ label: 'Completion Rate %', data: data.map(d => d.rate), backgroundColor: data.map(d => d.rate >= 70 ? '#10B981' : d.rate >= 50 ? '#F59E0B' : '#EF4444') }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, max: 100 } } }
            });
        }

        function renderStatusDistChart() {
            const ctx = document.getElementById('c-status-dist');
            if (!ctx || !DATE_DATA || DATE_DATA.length === 0) {
                if (ctx) ctx.parentElement.innerHTML = '<canvas id="c-status-dist"></canvas><div style="text-align:center;padding:40px;color:#94A3B8;">No data available</div>';
                return;
            }

            const agents = [...new Set(DATE_DATA.map(t => t.agent))];
            const statuses = ['Completed', 'Not Completed', 'Closed', "Can't Do"];
            const colors = { 'Completed': '#10B981', 'Not Completed': '#F59E0B', 'Closed': '#6B7280', "Can't Do": '#EF4444' };

            const datasets = statuses.map(status => ({
                label: status,
                data: agents.map(agent => DATE_DATA.filter(t => t.agent === agent && t.status === status).length),
                backgroundColor: colors[status]
            }));

            if (CHARTS['c-status-dist']) CHARTS['c-status-dist'].destroy();

            CHARTS['c-status-dist'] = new Chart(ctx, {
                type: 'bar',
                data: { labels: agents, datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
            });
        }

        function renderSkillMixAnalytics() {
            const container = document.getElementById('skill-mix-container');
            if (!container || !DATE_DATA || DATE_DATA.length === 0) {
                if (container) container.innerHTML = '<div style="text-align:center;padding:40px;color:#94A3B8;">No data available for skill mix analysis</div>';
                return;
            }

            const agents = [...new Set(DATE_DATA.map(t => t.agent))];

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';

            agents.forEach(agent => {
                const agentTickets = DATE_DATA.filter(t => t.agent === agent);
                const concernCounts = {};
                agentTickets.forEach(t => { concernCounts[t.concern] = (concernCounts[t.concern] || 0) + 1; });

                const top5 = Object.entries(concernCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

                html += `
        <div style="background:white; padding:20px; border-radius:12px; border:1px solid #E2E8F0;">
            <h4 style="margin:0 0 16px; font-weight:700;">${agent}</h4>
            <div style="font-size:12px; color:#64748B; margin-bottom:12px;">Top 5 Concerns Handled</div>
            ${top5.map(([concern, count]) => `
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #F1F5F9;">
                    <span>${concern}</span>
                    <span style="font-weight:700; color:#4F46E5;">${count}</span>
                </div>
            `).join('')}
        </div>`;
            });

            html += '</div>';
            container.innerHTML = html;
        }


        // ==========================================
        // üóÑÔ∏è ENHANCED MASTER DATABASE VIEW
        // ==========================================

        // Master Search State
        let MASTER_SEARCH = {
            query: '',
            status: 'all',
            agent: 'all',
            sortField: 'date',
            sortOrder: 'desc',
            page: 1,
            pageSize: 100
        };

        // Debounced master search
        const debouncedMasterSearch = debounce(function (query) {
            MASTER_SEARCH.query = query;
            MASTER_SEARCH.page = 1; // Reset to first page
            renderMasterTable();
        }, 300);

        function onMasterSearchInput(input) {
            debouncedMasterSearch(input.value);
        }

        function onMasterFilterChange(type, value) {
            MASTER_SEARCH[type] = value;
            MASTER_SEARCH.page = 1; // Reset
            renderMasterTable();
        }

        // Clear all filters and search
        function clearMasterFilters() {
            MASTER_SEARCH = {
                query: '',
                status: 'all',
                agent: 'all',
                sortField: 'date',
                sortOrder: 'desc',
                page: 1,
                pageSize: 100
            };

            // Reset UI controls
            document.getElementById('master-search-input').value = '';
            document.querySelectorAll('#view-tickets select').forEach(sel => sel.selectedIndex = 0);

            renderMasterTable();
        }

        function renderMasterTable(imgPage = null) {
            if (imgPage) MASTER_SEARCH.page = imgPage;

            // Start with all data, sorted descending
            let data = [...RAW_DATA].sort((a, b) => b.sortDate - a.sortDate);

            // Apply status filter
            if (MASTER_SEARCH.status !== 'all') {
                data = data.filter(t => {
                    const st = t.status.toLowerCase();
                    if (MASTER_SEARCH.status === 'completed') return st === 'completed';
                    if (MASTER_SEARCH.status === 'pending') return st === 'not completed' || st === 'pending' || st === 'in progress';
                    if (MASTER_SEARCH.status === 'closed') return st === 'closed';
                    if (MASTER_SEARCH.status === 'cantdo') return st.includes("can't") || st.includes('cant');
                    return true;
                });
            }

            // Apply agent filter
            if (MASTER_SEARCH.agent !== 'all') {
                data = data.filter(t => t.agent === MASTER_SEARCH.agent);
            }

            // Apply search query (multi-field smart search)
            if (MASTER_SEARCH.query && MASTER_SEARCH.query.trim() !== '') {
                const q = MASTER_SEARCH.query.toLowerCase().trim();
                const terms = q.split(/\s+/);  // Support multiple search terms

                data = data.filter(t => {
                    const searchableText = [
                        t.id, t.business, t.mid, t.agent,
                        t.concern, t.reason || '', t.remark || '',
                        t.pos, t.supportType, t.requestedBy
                    ].join(' ').toLowerCase();

                    // All terms must match (AND logic)
                    return terms.every(term => searchableText.includes(term));
                });
            }

            // Update result count
            const resultInfo = document.getElementById('master-result-info');
            if (resultInfo) {
                resultInfo.innerHTML = `
            <span style="font-weight:700; color:#667eea;">${data.length}</span> tickets found
            ${MASTER_SEARCH.query ? ` matching "<strong>${escapeHtml(MASTER_SEARCH.query)}</strong>"` : ''}
        `;
            }

            // ‚úÖ PAGINATION LOGIC
            const totalRows = data.length;
            MASTER_SEARCH.totalRows = totalRows;
            const totalPages = Math.ceil(totalRows / MASTER_SEARCH.pageSize) || 1;
            MASTER_SEARCH.totalPages = totalPages;

            if (MASTER_SEARCH.page > totalPages) MASTER_SEARCH.page = totalPages;
            if (MASTER_SEARCH.page < 1) MASTER_SEARCH.page = 1;

            const start = (MASTER_SEARCH.page - 1) * MASTER_SEARCH.pageSize;
            const end = start + MASTER_SEARCH.pageSize;

            // Slice data for current page
            const pageData = data.slice(start, end);

            const tbody = document.getElementById('master-table');

            // Render Pagination Controls
            renderMasterPaginationControls();

            if (totalRows === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="10" style="text-align:center; padding:60px; color:#94A3B8;">
                    <i class="fas fa-search" style="font-size:48px; margin-bottom:16px; display:block;"></i>
                    <p style="font-size:16px; font-weight:600; margin:0;">No tickets found</p>
                    <p style="font-size:13px; margin-top:8px;">Try adjusting your search or filters</p>
                </td>
            </tr>
        `;
            } else {
                tbody.innerHTML = pageData.map(t => {
                    let statusBadge = 's-pend';
                    const st = t.status.toLowerCase();
                    if (st === 'completed') statusBadge = 's-done';
                    else if (st === 'closed') statusBadge = t.invalidClosed ? 's-invalid' : 's-closed';
                    else if (st.includes('cant') || st.includes("can't") || st.includes("can‚Äôt")) statusBadge = 's-cant';

                    const rqClass = `rq-${t.reasonQuality || 'none'}`;

                    // Highlight search matches
                    const highlightMatch = (text) => {
                        if (!MASTER_SEARCH.query || !text) return escapeHtml(text || '-');
                        const q = MASTER_SEARCH.query.toLowerCase();
                        const escapedText = escapeHtml(String(text));
                        if (!escapedText.toLowerCase().includes(q)) return escapedText;
                        const regex = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                        return escapedText.replace(regex, '<mark style="background:#FEF08A;padding:1px 2px;border-radius:2px;">$1</mark>');
                    };

                    return `
            <tr class="age-${t.ageCategory}">
                <td><strong>${highlightMatch(t.id)}</strong></td>
                <td>${escapeHtml(t.date)}</td>
                <td><strong>${t.ageDays}d</strong></td>
                <td>${highlightMatch(t.agent)}</td>
                <td>${highlightMatch(t.mid)}</td>
                <td>${highlightMatch(t.business)}</td>
                <td>${highlightMatch(t.concern)}</td>
                <td>
                    <span class="badge ${statusBadge}">${escapeHtml(t.status)}</span>
                    ${t.reason ? `<span class="reason-quality ${rqClass}">${t.reasonQuality || ''}</span>` : ''}
                </td>
                <td style="max-width: 350px; font-size: 11px; color: #475569;">
                    ${t.reason
                            ? `<div style="max-height: 80px; overflow-y: auto; white-space: pre-wrap; line-height: 1.5; padding: 4px 8px; background: #F8FAFC; border-radius: 6px; border-left: 3px solid #CBD5E1;">
                             ${escapeHtml(t.reason)}
                           </div>`
                            : '<span style="color: #CBD5E1; font-style: italic;">‚Äî</span>'
                        }
                </td>
                <td>
                    <button class="action-btn action-btn-update" 
                            data-ticket-id="${t.id}" 
                            onclick="openReasonModalSafe(this)">
                        <i class="fas fa-edit"></i> Update
                    </button>
                </td>
            </tr>
            `;
                }).join('');
            }
        }

        // ‚úÖ Master Pagination Controls
        function renderMasterPaginationControls() {
            const container = document.getElementById('master-pagination-controls');
            if (!container) return;

            const { page, pageSize, totalRows, totalPages } = MASTER_SEARCH;

            if (totalRows === 0) {
                container.innerHTML = '';
                return;
            }

            const start = ((page - 1) * pageSize) + 1;
            const end = Math.min(page * pageSize, totalRows);

            container.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: white; border-radius: 10px; border: 1px solid #E2E8F0; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
            <div style="font-size: 13px; font-weight: 600; color: #64748B;">
                Showing <strong style="color: #4F46E5;">${start}-${end}</strong> of <strong>${totalRows}</strong>
            </div>
            
            <div style="display: flex; align-items: center; gap: 6px;">
                 <button class="btn" onclick="goToMasterPage(${page - 1})" ${page === 1 ? 'disabled style="opacity:0.5"' : ''}>
                    <i class="fas fa-chevron-left"></i> Prev
                 </button>
                 
                 <span style="font-size: 13px; font-weight: 600; padding: 0 8px; color: #475569;">
                    Page ${page} of ${totalPages}
                 </span>
                 
                 <button class="btn" onclick="goToMasterPage(${page + 1})" ${page >= totalPages ? 'disabled style="opacity:0.5"' : ''}>
                    Next <i class="fas fa-chevron-right"></i>
                 </button>
            </div>
        </div>
    `;
        }

        function goToMasterPage(page) {
            if (page < 1 || page > MASTER_SEARCH.totalPages || page === MASTER_SEARCH.page) return;
            renderMasterTable(page);
            document.getElementById('view-tickets').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // NAVIGATION
        function nav(view, btn) {
            VIEW_STATE.currentView = view;

            // Hide all views - Include 'history' and 'reports'
            ['dash', 'team', 'analytics', 'tickets', 'history', 'reports'].forEach(v => {
                const el = document.getElementById('view-' + v);
                if (el) el.classList.add('hidden');
            });

            // Show selected view
            const viewEl = document.getElementById('view-' + view);
            if (viewEl) viewEl.classList.remove('hidden');

            // Update nav buttons
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            btn.classList.add('active');

            // Render specific views
            if (view === 'dash') {
                if (window.innerWidth <= 1024) {
                    renderMobileView();
                } else {
                    renderKPIs();
                    renderDashboardAgents();
                    filterTable('Total', document.querySelector('.kpi-card'));
                }
            }

            if (view === 'team') {
                // Render BOTH leaderboard and detailed reports
                renderLeaderboard('week');
                renderDetailedTeamReport();
            }

            if (view === 'analytics') {
                setTimeout(() => {
                    renderAnalytics();
                    renderAdvancedAnalytics();
                }, 100);
            }

            if (view === 'tickets') {
                renderMasterTable();
            }

            // ‚è±Ô∏è NEW: Update History View with Duration Tracking
            if (view === 'history') {
                renderUpdateHistory();
            }
        }

        // ‚úÖ Refresh button handler for analytics
        function renderAllAnalytics() {
            console.log('üîÑ Refreshing all analytics...');

            if (typeof renderAnalytics === 'function') {
                renderAnalytics();
            }
            if (typeof renderAdvancedAnalytics === 'function') {
                renderAdvancedAnalytics();
            }

            // ‚ùå REMOVED: renderResolutionTimeChart() call

            console.log('‚úÖ Analytics refreshed!');
        }

        /* ==================================================
           ‚è±Ô∏è UPDATE HISTORY WITH DURATION TRACKING
           Shows status transitions with time-to-resolution
           ================================================== */

        // History State
        const HISTORY_STATE = {
            page: 1,
            pageSize: 50,
            data: [],
            filters: {},
            durationStats: null
        };

        /**
         * ‚è±Ô∏è RENDER UPDATE HISTORY
         * Main function to load and display status change history with Duration
         */
        function renderUpdateHistory(page = 1) {
            HISTORY_STATE.page = page;

            const tbody = document.getElementById('history-table');
            const pagination = document.getElementById('history-pagination');
            const statsContainer = document.getElementById('history-stats');
            const durationStatsContainer = document.getElementById('duration-stats');

            // Show loading
            tbody.innerHTML = `
        <tr>
            <td colspan="9" style="text-align: center; padding: 60px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #667eea;"></i>
                <p style="margin-top: 16px; color: #64748B;">Loading history...</p>
            </td>
        </tr>
    `;

            // Build filters
            const filters = {
                ticketId: document.getElementById('history-ticket-filter')?.value || '',
                user: document.getElementById('history-user-filter')?.value || '',
                action: document.getElementById('history-action-filter')?.value || 'all',
                severity: document.getElementById('history-severity-filter')?.value || 'all'
            };

            // Call backend
            google.script.run
                .withSuccessHandler(response => {
                    try {
                        const result = JSON.parse(response);

                        if (!result.success) {
                            tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 60px; color: #DC2626;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 32px;"></i>
                                <p style="margin-top: 16px;">Error: ${escapeHtml(result.error || 'Unknown error')}</p>
                            </td>
                        </tr>
                    `;
                            return;
                        }

                        HISTORY_STATE.data = result.data;
                        HISTORY_STATE.durationStats = result.durationStats;

                        // Render Duration Stats Bar
                        renderDurationStats(result.durationStats);

                        // Render table
                        if (result.data.length === 0) {
                            tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 60px; color: #94A3B8;">
                                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px;"></i>
                                <p style="font-weight: 600;">No updates found</p>
                                <p style="font-size: 12px;">${result.message || 'Try adjusting your filters'}</p>
                            </td>
                        </tr>
                    `;
                        } else {
                            tbody.innerHTML = result.data.map(h => renderHistoryRow(h)).join('');
                        }

                        // Render pagination
                        renderHistoryPagination(result.pagination);

                        // Render basic stats
                        statsContainer.innerHTML = `
                    <div style="background: white; padding: 12px 20px; border-radius: 10px; border: 1px solid #E2E8F0; flex: 1;">
                        <span style="font-size: 11px; color: #64748B; text-transform: uppercase; font-weight: 700;">Total Records</span>
                        <div style="font-size: 24px; font-weight: 800; color: #1E293B;">${result.pagination.totalRows}</div>
                    </div>
                    <div style="background: white; padding: 12px 20px; border-radius: 10px; border: 1px solid #E2E8F0; flex: 1;">
                        <span style="font-size: 11px; color: #64748B; text-transform: uppercase; font-weight: 700;">Page</span>
                        <div style="font-size: 24px; font-weight: 800; color: #667eea;">${result.pagination.page} / ${result.pagination.totalPages || 1}</div>
                    </div>
                `;

                    } catch (e) {
                        tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 60px; color: #DC2626;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px;"></i>
                            <p style="margin-top: 16px;">Parse error: ${escapeHtml(e.toString())}</p>
                        </td>
                    </tr>
                `;
                    }
                })
                .withFailureHandler(err => {
                    tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 60px; color: #DC2626;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 32px;"></i>
                        <p style="margin-top: 16px;">Server error: ${escapeHtml(err.message || 'Connection failed')}</p>
                    </td>
                </tr>
            `;
                })
                .getUpdateHistory({
                    page: page,
                    pageSize: HISTORY_STATE.pageSize,
                    filters: filters
                });
        }

        /**
         * ‚è±Ô∏è RENDER DURATION STATS BAR
         * Shows insights about resolution times
         */
        function renderDurationStats(stats) {
            const container = document.getElementById('duration-stats');
            if (!container || !stats) return;

            if (stats.totalWithDuration === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px 20px; border-radius: 12px; color: white; flex: 1; min-width: 200px;">
            <div style="font-size: 10px; text-transform: uppercase; opacity: 0.8; font-weight: 700;">‚è±Ô∏è Avg Resolution Time</div>
            <div style="font-size: 28px; font-weight: 800; margin-top: 4px;">${stats.avgHours}h</div>
        </div>
        <div style="background: #D1FAE5; padding: 16px 20px; border-radius: 12px; min-width: 120px;">
            <div style="font-size: 10px; text-transform: uppercase; color: #047857; font-weight: 700;">üöÄ Fast (&lt;4h)</div>
            <div style="font-size: 24px; font-weight: 800; color: #047857; margin-top: 4px;">${stats.fastCount}</div>
        </div>
        <div style="background: #DBEAFE; padding: 16px 20px; border-radius: 12px; min-width: 120px;">
            <div style="font-size: 10px; text-transform: uppercase; color: #1D4ED8; font-weight: 700;">‚úÖ Normal (&lt;24h)</div>
            <div style="font-size: 24px; font-weight: 800; color: #1D4ED8; margin-top: 4px;">${stats.normalCount}</div>
        </div>
        <div style="background: #FEF3C7; padding: 16px 20px; border-radius: 12px; min-width: 120px;">
            <div style="font-size: 10px; text-transform: uppercase; color: #B45309; font-weight: 700;">‚ö†Ô∏è Slow (&lt;3d)</div>
            <div style="font-size: 24px; font-weight: 800; color: #B45309; margin-top: 4px;">${stats.slowCount}</div>
        </div>
        <div style="background: #FEE2E2; padding: 16px 20px; border-radius: 12px; min-width: 120px;">
            <div style="font-size: 10px; text-transform: uppercase; color: #B91C1C; font-weight: 700;">üî• Critical (&gt;3d)</div>
            <div style="font-size: 24px; font-weight: 800; color: #B91C1C; margin-top: 4px;">${stats.criticalCount}</div>
        </div>
    `;
        }

        /**
         * üìä RENDER SINGLE HISTORY ROW
         * With Duration column and visual styling
         */
        function renderHistoryRow(h) {
            // Severity badge
            let severityBadge = '<span style="color: #64748B;">‚ÑπÔ∏è</span>';
            if (h.severity === 'WARNING') severityBadge = '<span style="color: #F59E0B;">‚ö†Ô∏è</span>';
            else if (h.severity === 'ERROR') severityBadge = '<span style="color: #DC2626;">‚ùå</span>';

            // Status badges
            const prevStatusBadge = getStatusBadgeHtml(h.previousStatus);
            const newStatusBadge = getStatusBadgeHtml(h.newStatus);

            // ‚è±Ô∏è Duration badge with color coding
            let durationHtml = '<span style="color: #CBD5E1;">‚Äî</span>';
            if (h.duration) {
                const colors = {
                    fast: { bg: '#D1FAE5', color: '#047857', icon: 'üöÄ' },
                    normal: { bg: '#DBEAFE', color: '#1D4ED8', icon: '‚úÖ' },
                    slow: { bg: '#FEF3C7', color: '#B45309', icon: '‚ö†Ô∏è' },
                    critical: { bg: '#FEE2E2', color: '#B91C1C', icon: 'üî•' }
                };
                const style = colors[h.durationCategory] || colors.normal;
                durationHtml = `
            <span style="
                background: ${style.bg}; 
                color: ${style.color}; 
                padding: 4px 10px; 
                border-radius: 6px; 
                font-size: 12px; 
                font-weight: 700;
                display: inline-flex;
                align-items: center;
                gap: 4px;
            ">
                ${style.icon} ${h.duration}
            </span>
        `;
            }

            return `
        <tr>
            <td style="font-size: 12px; color: #64748B;">${escapeHtml(h.timestamp)}</td>
            <td style="font-weight: 600;">${escapeHtml(h.user.split('@')[0])}</td>
            <td>
                ${h.action === 'TICKET_UPDATED'
                    ? '<span style="color: #4F46E5;">üìù Updated</span>'
                    : '<span style="color: #DC2626;">üö´ Close Denied</span>'}
            </td>
            <td><strong>${escapeHtml(h.ticketId)}</strong></td>
            <td>${prevStatusBadge}</td>
            <td>${newStatusBadge}</td>
            <td style="text-align: center;">${durationHtml}</td>
            <td style="text-align: center;">${severityBadge}</td>
            <td style="text-align: center;">${h.reasonAdded === 'Yes' ? '‚úÖ' : '‚Äî'}</td>
        </tr>
    `;
        }

        /**
         * Get status badge HTML
         */
        function getStatusBadgeHtml(status) {
            const badges = {
                'Completed': '<span class="badge s-done">Completed</span>',
                'Not Completed': '<span class="badge s-pend">Not Completed</span>',
                'Closed': '<span class="badge s-closed">Closed</span>',
                "Can't Do": '<span class="badge s-cant">Can\'t Do</span>'
            };
            return badges[status] || `<span style="color: #64748B;">${escapeHtml(status)}</span>`;
        }

        /**
         * üìÑ RENDER HISTORY PAGINATION
         */
        function renderHistoryPagination(pagination) {
            const container = document.getElementById('history-pagination');
            if (!container || !pagination) return;

            if (pagination.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            const { page, totalPages, totalRows, pageSize } = pagination;
            const start = ((page - 1) * pageSize) + 1;
            const end = Math.min(page * pageSize, totalRows);

            container.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: white; border-radius: 10px; border: 1px solid #E2E8F0;">
            <div style="font-size: 13px; font-weight: 600; color: #64748B;">
                Showing <strong style="color: #4F46E5;">${start}-${end}</strong> of <strong>${totalRows}</strong>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
                <button class="btn" onclick="renderUpdateHistory(${page - 1})" ${page === 1 ? 'disabled style="opacity:0.5"' : ''}>
                    <i class="fas fa-chevron-left"></i> Prev
                </button>
                <span style="font-size: 13px; font-weight: 600; padding: 0 8px; color: #475569;">
                    Page ${page} of ${totalPages}
                </span>
                <button class="btn" onclick="renderUpdateHistory(${page + 1})" ${page >= totalPages ? 'disabled style="opacity:0.5"' : ''}>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    `;
        }

        // Alias for nav function call
        function loadUpdateHistory(page) {
            renderUpdateHistory(page);
        }

        // Debounce for filter inputs
        const debounceFilterHistory = debounce(() => renderUpdateHistory(1), 300);

        function filterHistory() {
            renderUpdateHistory(1);
        }

        function clearHistoryFilters() {
            document.getElementById('history-ticket-filter').value = '';
            document.getElementById('history-user-filter').value = '';
            document.getElementById('history-action-filter').value = 'all';
            document.getElementById('history-severity-filter').value = 'all';
            document.getElementById('history-start-date').value = '';
            document.getElementById('history-end-date').value = '';
            renderUpdateHistory(1);
        }

        function setHistoryDatePreset(preset) {
            const today = new Date();
            const startInput = document.getElementById('history-start-date');
            const endInput = document.getElementById('history-end-date');

            endInput.value = today.toISOString().split('T')[0];

            if (preset === 'today') {
                startInput.value = today.toISOString().split('T')[0];
            } else if (preset === 'week') {
                const weekAgo = new Date(today);
                weekAgo.setDate(today.getDate() - 7);
                startInput.value = weekAgo.toISOString().split('T')[0];
            } else if (preset === 'month') {
                const monthAgo = new Date(today);
                monthAgo.setMonth(today.getMonth() - 1);
                startInput.value = monthAgo.toISOString().split('T')[0];
            }

            renderUpdateHistory(1);
        }

        function exportHistory() {
            showToast('Exporting history...', 'info');
            // Export logic can be added here
        }


        // ==========================================
        // üîß UTILITY FUNCTIONS
        // ==========================================
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('show');
        }
        /* ==========================================
           üì± MOBILE-FIRST VIEW FUNCTIONS
           ========================================== */

        function toggleMobileNav() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobile-overlay');

            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('show');
        }

        function closeMobileNav() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobile-overlay');

            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('show');
        }

        function renderMobileView() {
            if (window.innerWidth > 1024) return; // Only for mobile

            const currentUser = getCurrentUserFromEmail(); // Get logged-in user

            // Get user's tickets
            const userTickets = DATE_DATA.filter(t => {
                if (currentUser === 'Admin') return true; // Admin sees all
                return t.agent === currentUser;
            });

            const pending = userTickets.filter(t => {
                const s = t.status.toLowerCase();
                return s === 'not completed' || s === 'pending' || s === 'in progress';
            });

            const completed = userTickets.filter(t => t.status.toLowerCase() === 'completed');
            const critical = pending.filter(t => t.ageDays >= 7);

            // Update stats
            document.getElementById('mobile-total').textContent = userTickets.length;
            document.getElementById('mobile-pending').textContent = pending.length;
            document.getElementById('mobile-completed').textContent = completed.length;
            document.getElementById('mobile-critical').textContent = critical.length;

            // Render ticket cards
            const container = document.getElementById('mobile-tickets-container');

            if (pending.length === 0) {
                container.innerHTML = `
            <div style="text-align:center; padding:40px; color:#94A3B8;">
                <i class="fas fa-check-circle" style="font-size:48px; margin-bottom:12px;"></i>
                <p style="font-weight:600;">All caught up! üéâ</p>
                <p style="font-size:12px;">No pending tickets</p>
            </div>
        `;
                return;
            }

            // Sort by priority (critical first)
            const sorted = pending.sort((a, b) => b.ageDays - a.ageDays);

            container.innerHTML = sorted.map(t => {
                let ageClass = 'age-fresh';
                if (t.ageDays >= 15) ageClass = 'age-critical';
                else if (t.ageDays >= 8) ageClass = 'age-old';
                else if (t.ageDays >= 4) ageClass = 'age-aging';

                const statusClass = t.status.toLowerCase() === 'completed' ? 's-done' : 's-pend';
                // Add specific escaping for the onclick handler
                const safeBusiness = t.business.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeMid = t.mid.replace(/'/g, "\\'");


                return `
        <div class="mobile-ticket-card">
            <div class="mobile-ticket-header">
                <span class="mobile-ticket-id">${t.id}</span>
                <span class="mobile-ticket-age ${ageClass}">${t.ageDays}d old</span>
            </div>
            <div class="mobile-ticket-business">${t.business}</div>
            <div class="mobile-ticket-meta">
                <span><i class="fas fa-id-card"></i> ${t.mid}</span>
                <span><i class="fas fa-calendar"></i> ${t.date}</span>
            </div>
            <div class="mobile-ticket-concern">
                <i class="fas fa-tag"></i> ${t.concern}
            </div>
            <div class="mobile-ticket-actions">
                <button class="mobile-btn" onclick="callCustomer('${safeMid}', '${safeBusiness}')">
       <i class="fas fa-phone"></i> Call
   </button>
                <button class="mobile-btn mobile-btn-primary" onclick="openReasonModalSafe('${t.id}')">
                    <i class="fas fa-edit"></i> Update
                </button>
                
            </div>
        </div>
        `;
            }).join('');
        }

        function callCustomer(mid, business) {
            // Placeholder for phone integration
            alert(`Calling ${business} (MID: ${mid})\n\nPhone integration coming soon!`);
            // Future: window.location.href = 'tel:+91XXXXXXXXXX';
        }

        function getCurrentUserFromEmail() {
            try {
                const emailMap = {
                    'manjeetkashyap.billfree@gmail.com': 'Manjeet',
                    'suraj.billfree2@gmail.com': 'Suraj',
                    'veer.billfree@gmail.com': 'Veer Bahadur',
                    'gaurav.pal@billfree.in': 'Admin'
                };

                // Use the global variable we fetched on load
                return emailMap[CURRENT_USER_EMAIL] || 'Admin';

            } catch (e) {
                console.error('Error in getCurrentUserFromEmail:', e);
                return 'Admin'; // Default fallback
            }
        }


        // Auto-render mobile view on window resize
        window.addEventListener('resize', function () {
            if (window.innerWidth <= 1024 && VIEW_STATE.currentView === 'dash') {
                renderMobileView();
            }
        });

        // ==========================================
        // üõ†Ô∏è DYNAMIC CONCERN LIST LOGIC
        // ==========================================
        const CONCERN_LISTS = {
            "IT Floor Support": [
                "Anydesk", "PC Slow", "PC shift", "Punch", "PC setup",
                "Internet", "PC up", "Keyboard&Mouse", "MS Office", "Other"
            ],
            "DEFAULT": [
                "New Integration", "Print issue", "Bill Delivery issue", "Reinstallation",
                "LOGO & Stamp Update", "Config issue", "Billfree POP Up",
                "Printer issue", "Background Merging", "Other"
            ]
        };

        function updateConcernList() {
            const typeSelect = document.getElementById('new-support-type');
            const concernSelect = document.getElementById('new-concern');
            if (!typeSelect || !concernSelect) return;

            const selectedType = typeSelect.value;
            const options = CONCERN_LISTS[selectedType] || CONCERN_LISTS["DEFAULT"];

            // Save current selection if possible
            const currentVal = concernSelect.value;

            let html = '<option value="">-- Select Concern --</option>';
            options.forEach(opt => {
                html += `<option value="${opt}">${opt}</option>`;
            });

            concernSelect.innerHTML = html;

            // Try to restore selection if it exists in new list
            if (options.includes(currentVal)) {
                concernSelect.value = currentVal;
            }
        }

        // ==========================================
        // üîß DATE FORMAT UTILITY
        // ==========================================
        function formatDateInput(date) {
            return date.toISOString().split('T')[0];
        }


        // ==========================================
        // üìä MONTHLY REPORTS FUNCTIONS (Phase 3 Enhanced)
        // ==========================================
        let CURRENT_REPORT = null;

        // Initialize report month/year on page load
        function initReportSelectors() {
            const now = new Date();
            const monthSelect = document.getElementById('report-month');
            const yearSelect = document.getElementById('report-year');
            const monthLabel = document.getElementById('current-month-label');

            if (monthSelect) monthSelect.value = now.getMonth() + 1;
            if (yearSelect) yearSelect.value = now.getFullYear();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            if (monthLabel) {
                monthLabel.textContent = `üìÖ ${monthNames[now.getMonth()]} ${now.getFullYear()}`;
            }
        }

        // Set to last completed month
        function setReportToLastMonth() {
            const now = new Date();
            let month = now.getMonth(); // 0-indexed, so this is previous month
            let year = now.getFullYear();

            if (month === 0) {
                month = 12;
                year = year - 1;
            }

            document.getElementById('report-month').value = month;
            document.getElementById('report-year').value = year;

            showToast(`üìÖ Set to ${getMonthName(month)} ${year}`, 'info', 2000);
        }

        function getMonthName(month) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            return monthNames[month - 1] || '';
        }

        function generateReport() {
            const month = parseInt(document.getElementById('report-month').value);
            const year = parseInt(document.getElementById('report-year').value);

            document.getElementById('report-loading').style.display = 'block';
            document.getElementById('report-preview').style.display = 'none';
            document.getElementById('report-export-options').style.display = 'none';

            google.script.run
                .withSuccessHandler(response => {
                    document.getElementById('report-loading').style.display = 'none';

                    try {
                        const result = typeof response === 'string' ? JSON.parse(response) : response;

                        if (result.success) {
                            CURRENT_REPORT = result.report;
                            renderReportPreview(result.report);
                            document.getElementById('report-export-options').style.display = 'block';
                            showToast('‚úÖ Report generated successfully!', 'success');
                        } else {
                            showToast('‚ùå ' + (result.error || 'Failed to generate report'), 'error');
                        }
                    } catch (e) {
                        showToast('‚ùå Parse error: ' + e.message, 'error');
                    }
                })
                .withFailureHandler(err => {
                    document.getElementById('report-loading').style.display = 'none';
                    showToast('‚ùå Network error: ' + err.message, 'error');
                })
                .generateMonthlyReport({ month, year });
        }

        // Email report to admins
        function emailReport() {
            if (!CURRENT_REPORT) {
                showToast('‚ö†Ô∏è Generate a report first', 'warning', 3000);
                return;
            }

            const month = parseInt(document.getElementById('report-month').value);
            const year = parseInt(document.getElementById('report-year').value);

            showToast('üìß Sending report email...', 'info', 3000);

            google.script.run
                .withSuccessHandler(response => {
                    try {
                        const result = typeof response === 'string' ? JSON.parse(response) : response;

                        if (result.success) {
                            showToast('‚úÖ ' + result.message, 'success', 4000);
                        } else {
                            showToast('‚ùå ' + (result.error || 'Failed to send email'), 'error');
                        }
                    } catch (e) {
                        showToast('‚ùå Email error: ' + e.message, 'error');
                    }
                })
                .withFailureHandler(err => {
                    showToast('‚ùå Network error', 'error');
                })
                .sendMonthlyReportEmail({ month, year });
        }

        // Export report data as CSV
        function exportReportCSV() {
            if (!CURRENT_REPORT) {
                showToast('‚ö†Ô∏è Generate a report first', 'warning', 3000);
                return;
            }

            const report = CURRENT_REPORT;

            // Build CSV content
            const lines = [];

            // Header
            lines.push(`"${report.title}"`);
            lines.push(`"Period: ${report.period.startDate} to ${report.period.endDate}"`);
            lines.push('');

            // Summary
            lines.push('"EXECUTIVE SUMMARY"');
            lines.push(`"Total Tickets",${report.summary.totalTickets}`);
            lines.push(`"Completed",${report.summary.completed}`);
            lines.push(`"Pending",${report.summary.pending}`);
            lines.push(`"Closed",${report.summary.closed}`);
            lines.push(`"Can't Do",${report.summary.cantDo}`);
            lines.push(`"Completion Rate",${report.summary.completionRate}%`);
            lines.push(`"Performance Grade",${report.summary.performanceGrade}`);
            lines.push('');

            // Agent rankings
            lines.push('"AGENT PERFORMANCE"');
            lines.push('"Agent","Total","Completed","Pending","Closed","Can\'t Do","Completion Rate","Score"');
            report.agentRankings.forEach(a => {
                lines.push(`"${a.name}",${a.total},${a.completed},${a.pending},${a.closed},${a.cantDo},${a.completionRate}%,${a.score}`);
            });
            lines.push('');

            // Top concerns
            lines.push('"TOP CONCERNS"');
            lines.push('"Concern","Count","Percentage"');
            report.topConcerns.forEach(c => {
                lines.push(`"${c.concern}",${c.count},${c.percentage}%`);
            });

            const csvContent = lines.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `monthly_report_${report.period.monthName}_${report.period.year}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            showToast('‚úÖ Report exported to CSV', 'success');
        }

        // Print report as PDF
        function printReportPDF() {
            if (!CURRENT_REPORT) {
                showToast('‚ö†Ô∏è Generate a report first', 'warning', 3000);
                return;
            }

            const content = document.getElementById('report-content');
            if (!content) {
                showToast('‚ùå Report content not found', 'error');
                return;
            }

            // Open print window
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showToast('‚ùå Popup blocked - please allow popups', 'error');
                return;
            }

            // Build document using DOM manipulation to avoid script tag parsing issues
            const doc = printWindow.document;

            doc.open();
            doc.write('<!DOCTYPE html><html><head>');
            doc.write('<title>' + escapeHtml(CURRENT_REPORT.title) + '</title>');
            doc.write('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">');
            doc.write('<style>');
            doc.write('body { font-family: "Segoe UI", Arial, sans-serif; padding: 20px; color: #1E293B; }');
            doc.write('@media print { button { display: none !important; } .no-print { display: none !important; } }');
            doc.write('</style>');
            doc.write('</head><body>');
            doc.write(content.innerHTML);
            doc.write('</body></html>');
            doc.close();

            // Trigger print after content loads
            printWindow.onload = function () {
                printWindow.print();
            };

            // Fallback for browsers that don't fire onload
            setTimeout(function () {
                try {
                    printWindow.print();
                } catch (e) {
                    console.log('Print triggered via timeout');
                }
            }, 500);
        }




        function renderReportPreview(report) {
            const container = document.getElementById('report-preview');
            if (!container) return;

            container.style.display = 'block';

            // Grade colors
            const gradeColors = {
                'A+': { bg: '#10B981', text: 'white' },
                'A': { bg: '#34D399', text: 'white' },
                'B': { bg: '#F59E0B', text: 'white' },
                'C': { bg: '#F97316', text: 'white' },
                'D': { bg: '#EF4444', text: 'white' }
            };
            const grade = gradeColors[report.summary.performanceGrade] || gradeColors['D'];

            // Priority colors for recommendations
            const priorityStyles = {
                'HIGH': { bg: '#FEE2E2', border: '#DC2626', text: '#991B1B' },
                'MEDIUM': { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E' },
                'LOW': { bg: '#D1FAE5', border: '#10B981', text: '#065F46' }
            };

            container.innerHTML = `
        <div style="background: white; padding: 32px; border-radius: 16px; border: 1px solid #E2E8F0; box-shadow: 0 4px 20px rgba(0,0,0,0.08);" id="report-content">
            <!-- Report Header with Grade -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid #E2E8F0;">
                <div>
                    <h1 style="margin: 0 0 8px; font-size: 26px; color: #1E293B; font-weight: 800;">${escapeHtml(report.title)}</h1>
                    <p style="margin: 0; color: #64748B; font-size: 14px;">
                        <i class="fas fa-calendar-alt" style="margin-right: 6px;"></i>
                        ${escapeHtml(report.period.startDate)} to ${escapeHtml(report.period.endDate)}
                    </p>
                    <p style="margin: 4px 0 0; color: #94A3B8; font-size: 12px;">
                        Generated: ${new Date(report.generatedAt).toLocaleString('en-IN')}
                    </p>
                </div>
                <div style="text-align: center;">
                    <div style="background: ${grade.bg}; color: ${grade.text}; width: 80px; height: 80px; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 15px ${grade.bg}40;">
                        <span style="font-size: 32px; font-weight: 900; line-height: 1;">${report.summary.performanceGrade || 'N/A'}</span>
                        <span style="font-size: 9px; font-weight: 700; text-transform: uppercase; opacity: 0.9;">Grade</span>
                    </div>
                    <div style="font-size: 11px; color: #64748B; margin-top: 6px;">Score: ${report.summary.performanceScore || 0}/100</div>
                </div>
            </div>
            
            <!-- Summary KPI Cards -->
            <h3 style="margin: 0 0 16px; font-weight: 700; font-size: 16px;">
                <i class="fas fa-chart-bar" style="color: #4F46E5; margin-right: 8px;"></i>Executive Summary
            </h3>
            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 32px;">
                <div style="background: linear-gradient(135deg, #EEF2FF, #FFFFFF); padding: 18px 14px; border-radius: 12px; border: 1px solid #E2E8F0; text-align: center;">
                    <div style="font-size: 28px; font-weight: 800; color: #4F46E5;">${report.summary.totalTickets}</div>
                    <div style="font-size: 10px; font-weight: 700; color: #64748B; text-transform: uppercase;">Total</div>
                </div>
                <div style="background: linear-gradient(135deg, #D1FAE5, #FFFFFF); padding: 18px 14px; border-radius: 12px; border: 1px solid #E2E8F0; text-align: center;">
                    <div style="font-size: 28px; font-weight: 800; color: #059669;">${report.summary.completed}</div>
                    <div style="font-size: 10px; font-weight: 700; color: #64748B; text-transform: uppercase;">Completed</div>
                </div>
                <div style="background: linear-gradient(135deg, #FEF3C7, #FFFFFF); padding: 18px 14px; border-radius: 12px; border: 1px solid #E2E8F0; text-align: center;">
                    <div style="font-size: 28px; font-weight: 800; color: #D97706;">${report.summary.pending}</div>
                    <div style="font-size: 10px; font-weight: 700; color: #64748B; text-transform: uppercase;">Pending</div>
                </div>
                <div style="background: linear-gradient(135deg, #F1F5F9, #FFFFFF); padding: 18px 14px; border-radius: 12px; border: 1px solid #E2E8F0; text-align: center;">
                    <div style="font-size: 28px; font-weight: 800; color: #475569;">${report.summary.closed}</div>
                    <div style="font-size: 10px; font-weight: 700; color: #64748B; text-transform: uppercase;">Closed</div>
                </div>
                <div style="background: linear-gradient(135deg, #FEE2E2, #FFFFFF); padding: 18px 14px; border-radius: 12px; border: 1px solid #E2E8F0; text-align: center;">
                    <div style="font-size: 28px; font-weight: 800; color: #DC2626;">${report.summary.cantDo}</div>
                    <div style="font-size: 10px; font-weight: 700; color: #64748B; text-transform: uppercase;">Can't Do</div>
                </div>
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 18px 14px; border-radius: 12px; text-align: center; color: white;">
                    <div style="font-size: 28px; font-weight: 800;">${report.summary.completionRate}%</div>
                    <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; opacity: 0.9;">Rate</div>
                </div>
            </div>
            
            <!-- üß† Intelligent Insights Section -->
            ${report.insights ? `
            <div style="background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border-radius: 16px; padding: 24px; margin-bottom: 32px; border: 1px solid #BAE6FD;">
                <h3 style="margin: 0 0 20px; font-weight: 700; font-size: 16px; color: #0369A1;">
                    <i class="fas fa-brain" style="margin-right: 8px;"></i>Intelligent Insights
                </h3>
                
                <!-- Quick Stats Row -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px;">
                    <div style="background: white; padding: 16px; border-radius: 10px; border-left: 4px solid #3B82F6;">
                        <div style="font-size: 11px; color: #64748B; text-transform: uppercase; font-weight: 700; margin-bottom: 4px;">Busiest Day</div>
                        <div style="font-size: 18px; font-weight: 800; color: #1E293B;">${escapeHtml(report.insights.busiestDay?.day || 'N/A')}</div>
                        <div style="font-size: 12px; color: #64748B;">${report.insights.busiestDay?.count || 0} tickets</div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 10px; border-left: 4px solid #10B981;">
                        <div style="font-size: 11px; color: #64748B; text-transform: uppercase; font-weight: 700; margin-bottom: 4px;">Top Performer</div>
                        <div style="font-size: 18px; font-weight: 800; color: #1E293B;">${escapeHtml(report.insights.topPerformer?.name || 'N/A')}</div>
                        <div style="font-size: 12px; color: #64748B;">${report.insights.topPerformer?.completed || 0} completed</div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 10px; border-left: 4px solid #F59E0B;">
                        <div style="font-size: 11px; color: #64748B; text-transform: uppercase; font-weight: 700; margin-bottom: 4px;">Top Concern</div>
                        <div style="font-size: 18px; font-weight: 800; color: #1E293B;">${escapeHtml((report.insights.topConcern?.name || 'N/A').substring(0, 15))}</div>
                        <div style="font-size: 12px; color: #64748B;">${report.insights.topConcern?.percentage || 0}% of tickets</div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 10px; border-left: 4px solid #8B5CF6;">
                        <div style="font-size: 11px; color: #64748B; text-transform: uppercase; font-weight: 700; margin-bottom: 4px;">Best Rate</div>
                        <div style="font-size: 18px; font-weight: 800; color: #1E293B;">${report.insights.highestRateAgent?.rate || 0}%</div>
                        <div style="font-size: 12px; color: #64748B;">${escapeHtml(report.insights.highestRateAgent?.name || 'N/A')}</div>
                    </div>
                </div>
                
                <!-- Recommendations -->
                ${report.insights.recommendations && report.insights.recommendations.length > 0 ? `
                <div style="margin-top: 16px;">
                    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; color: #0369A1; margin-bottom: 12px;">
                        <i class="fas fa-lightbulb" style="margin-right: 6px;"></i>Actionable Recommendations
                    </div>
                    ${report.insights.recommendations.map(rec => {
                const ps = priorityStyles[rec.priority] || priorityStyles['MEDIUM'];
                return `
                        <div style="background: ${ps.bg}; border-left: 4px solid ${ps.border}; padding: 12px 16px; border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <span style="font-size: 18px;">${rec.icon}</span>
                                <div>
                                    <span style="font-size: 10px; font-weight: 800; color: ${ps.text}; text-transform: uppercase;">${rec.priority}</span>
                                    <p style="margin: 4px 0 0; font-size: 13px; color: ${ps.text}; line-height: 1.5;">${escapeHtml(rec.message)}</p>
                                </div>
                            </div>
                        </div>`;
            }).join('')}
                </div>
                ` : ''}
            </div>
            ` : ''}
            
            <!-- Support Type Breakdown -->
            ${report.supportTypeBreakdown && report.supportTypeBreakdown.length > 0 ? `
            <h3 style="margin: 0 0 16px; font-weight: 700; font-size: 16px;">
                <i class="fas fa-layer-group" style="color: #8B5CF6; margin-right: 8px;"></i>Support Type Breakdown
            </h3>
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 32px;">
                ${report.supportTypeBreakdown.map(st => `
                    <div style="background: linear-gradient(135deg, #F8FAFC, white); padding: 14px 20px; border-radius: 10px; border: 1px solid #E2E8F0; min-width: 160px;">
                        <div style="font-size: 11px; color: #64748B; text-transform: uppercase; font-weight: 700;">${escapeHtml(st.type)}</div>
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-top: 6px;">
                            <span style="font-size: 24px; font-weight: 800; color: #1E293B;">${st.count}</span>
                            <span style="font-size: 13px; font-weight: 600; color: #8B5CF6;">${st.percentage}%</span>
                        </div>
                    </div>
                `).join('')}
            </div>
            ` : ''}
            
            <!-- Agent Rankings -->
            <h3 style="margin: 0 0 16px; font-weight: 700; font-size: 16px;">
                <i class="fas fa-trophy" style="color: #F59E0B; margin-right: 8px;"></i>Agent Performance
            </h3>
            <div class="table-wrapper" style="margin-bottom: 32px;">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 60px;">Rank</th>
                            <th>Agent</th>
                            <th>Total</th>
                            <th>Completed</th>
                            <th>Pending</th>
                            <th>Closed</th>
                            <th>Can't Do</th>
                            <th>Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${report.agentRankings.map((a, i) => `
                            <tr>
                                <td style="font-weight: 700; font-size: 16px;">${i < 3 ? ['ü•á', 'ü•à', 'ü•â'][i] : i + 1}</td>
                                <td><strong>${escapeHtml(a.name)}</strong></td>
                                <td style="font-weight: 600;">${a.total}</td>
                                <td style="color: #059669; font-weight: 600;">${a.completed}</td>
                                <td style="color: #D97706; font-weight: 600;">${a.pending}</td>
                                <td style="color: #64748B;">${a.closed}</td>
                                <td style="color: #DC2626; font-weight: 600;">${a.cantDo}</td>
                                <td>
                                    <span style="background: ${a.completionRate >= 70 ? '#D1FAE5' : a.completionRate >= 50 ? '#FEF3C7' : '#FEE2E2'}; 
                                                 color: ${a.completionRate >= 70 ? '#059669' : a.completionRate >= 50 ? '#D97706' : '#DC2626'};
                                                 padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 12px;">
                                        ${a.completionRate}%
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <!-- Top Concerns with Progress Bars -->
            <h3 style="margin: 0 0 16px; font-weight: 700; font-size: 16px;">
                <i class="fas fa-exclamation-triangle" style="color: #DC2626; margin-right: 8px;"></i>Top Concerns
            </h3>
            <div style="display: grid; gap: 10px; margin-bottom: 32px;">
                ${report.topConcerns.slice(0, 6).map((c, i) => `
                    <div style="background: #F8FAFC; padding: 14px 18px; border-radius: 10px; border: 1px solid #E2E8F0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 700; color: #1E293B; font-size: 13px;">${escapeHtml(c.name)}</span>
                            <span style="font-weight: 800; color: #4F46E5; font-size: 14px;">${c.count}</span>
                        </div>
                        <div style="background: #E2E8F0; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${c.percentage}%; border-radius: 3px;"></div>
                        </div>
                        <div style="font-size: 11px; color: #64748B; margin-top: 4px; text-align: right;">${c.percentage}%</div>
                    </div>
                `).join('')}
            </div>
            
            <!-- Footer -->
            <div style="text-align: center; padding-top: 24px; border-top: 2px solid #E2E8F0; color: #94A3B8; font-size: 12px;">
                <strong>BillFree TechSupport Ops v9.9 PRO</strong> ‚Ä¢ Generated by ${escapeHtml(report.generatedBy || 'System')}
                <br><span style="font-size: 11px;">This report contains ${report.summary.totalTickets} tickets for ${escapeHtml(report.period.monthName)} ${report.period.year}</span>
            </div>
        </div>
    `;
        }

        function exportReportExcel() {
            if (!CURRENT_REPORT) {
                showToast('‚ö†Ô∏è Please generate a report first', 'warning');
                return;
            }

            const month = parseInt(document.getElementById('report-month').value);
            const year = parseInt(document.getElementById('report-year').value);

            showToast('üìä Generating Excel export...', 'info');

            google.script.run
                .withSuccessHandler(response => {
                    try {
                        const result = typeof response === 'string' ? JSON.parse(response) : response;

                        if (result.success) {
                            // Create downloadable CSV
                            const blob = new Blob([result.csv], { type: 'text/csv;charset=utf-8;' });
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = result.filename;
                            link.click();
                            showToast('‚úÖ Excel file downloaded!', 'success');
                        } else {
                            showToast('‚ùå ' + result.error, 'error');
                        }
                    } catch (e) {
                        showToast('‚ùå Export error: ' + e.message, 'error');
                    }
                })
                .withFailureHandler(err => {
                    showToast('‚ùå Network error: ' + err.message, 'error');
                })
                .exportReportAsCSV({ month, year });
        }

        function printReportPDF() {
            if (!CURRENT_REPORT) {
                showToast('‚ö†Ô∏è Please generate a report first', 'warning');
                return;
            }

            const printContent = document.getElementById('report-content');
            if (!printContent) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${CURRENT_REPORT.title}</title>
            <style>
                body { font-family: 'Inter', Arial, sans-serif; margin: 20px; color: #1E293B; }
                table { width: 100%; border-collapse: collapse; margin: 16px 0; }
                th, td { padding: 10px; text-align: left; border-bottom: 1px solid #E2E8F0; }
                th { background: #F8FAFC; font-weight: 700; }
                @media print { @page { margin: 1cm; } }
            </style>
        </head>
        <body>${printContent.innerHTML}</body>
        </html>
    `);
            printWindow.document.close();
            printWindow.print();
        }

        // ==========================================  
        // üìù MARKDOWN RENDERING
        // ==========================================
        function renderMarkdown(text) {
            if (!text) return '';

            let html = String(text);

            // Escape HTML first
            html = html.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Headers
            html = html.replace(/^### (.*$)/gm, '<h4 style="margin:8px 0;font-size:13px;font-weight:700;">$1</h4>');
            html = html.replace(/^## (.*$)/gm, '<h3 style="margin:8px 0;font-size:14px;font-weight:700;">$1</h3>');
            html = html.replace(/^# (.*$)/gm, '<h2 style="margin:8px 0;font-size:15px;font-weight:700;">$1</h2>');

            // Bold & Italic
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Strikethrough
            html = html.replace(/~~(.*?)~~/g, '<del>$1</del>');

            // Code
            html = html.replace(/`(.*?)`/g, '<code style="background:#F1F5F9;padding:2px 6px;border-radius:4px;font-family:monospace;font-size:12px;">$1</code>');

            // Lists
            html = html.replace(/^\- (.*$)/gm, '<li style="margin-left:16px;">$1</li>');

            // Line breaks
            html = html.replace(/\n/g, '<br>');

            return html;
        }

        // ==========================================  
        // üß≠ NAVIGATION UPDATE
        // ==========================================
        // Override the existing nav function to support new views
        const originalNav = typeof nav === 'function' ? nav : null;

        function nav(view, btn) {
            // üîÑ VIEW TRANSITIONS API: Wrap navigation in smooth transition
            const performNavigation = () => {
                // Handle new views
                if (view === 'history') {
                    // Hide all views
                    document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
                    document.getElementById('view-history').classList.remove('hidden');

                    // Update nav
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    if (btn) btn.classList.add('active');

                    // Load data
                    loadUpdateHistory(1);
                    return;
                }

                if (view === 'reports') {
                    // Hide all views
                    document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
                    document.getElementById('view-reports').classList.remove('hidden');

                    // Update nav
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    if (btn) btn.classList.add('active');

                    // Set current month/year
                    const now = new Date();
                    document.getElementById('report-month').value = now.getMonth() + 1;
                    document.getElementById('report-year').value = now.getFullYear();
                    return;
                }

                // Handle standard views
                const views = ['dash', 'team', 'analytics', 'tickets'];

                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                if (btn) btn.classList.add('active');

                // Hide all views including new ones
                document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));

                VIEW_STATE.currentView = view;

                if (view === 'dash') {
                    document.getElementById('view-dash').classList.remove('hidden');
                } else if (view === 'team') {
                    document.getElementById('view-team')?.classList.remove('hidden');
                    // Render leaderboard with default 'all' filter and highlight All Time button
                    setTimeout(() => {
                        const allTimeBtn = document.getElementById('pill-all-time');
                        renderLeaderboard('all', allTimeBtn);
                        renderWeeklyGoals();
                    }, 100);
                    renderDetailedTeamReport();
                } else if (view === 'analytics') {
                    document.getElementById('view-analytics')?.classList.remove('hidden');
                    // ‚úÖ FIXED: Call correct function and render additional charts
                    setTimeout(() => {
                        renderAdvancedAnalytics();
                        renderIssuesChart();
                        renderAgentsChart();
                        renderWeeklyLoadChart();
                        renderCompletionRateChart();
                        renderStatusDistChart();
                        renderSkillMixAnalytics();
                    }, 100);
                } else if (view === 'tickets') {
                    document.getElementById('view-tickets')?.classList.remove('hidden');
                    renderMasterDatabase();
                }
            };

            // üîÑ Use View Transitions API if supported, otherwise fallback
            if (document.startViewTransition) {
                document.startViewTransition(() => {
                    performNavigation();
                });
            } else {
                // Fallback for browsers without View Transitions API
                performNavigation();
            }
        }

        // ‚úÖ Alias for button onclick compatibility
        function renderAllAnalytics() {
            renderAdvancedAnalytics();
            renderIssuesChart();
            renderAgentsChart();
            renderWeeklyLoadChart();
            renderCompletionRateChart();
            renderStatusDistChart();
            renderSkillMixAnalytics();
        }

        // ==========================================
        // üèÜ ACHIEVEMENT BADGES SYSTEM
        // ==========================================

        const BADGE_DEFINITIONS = [
            { id: 'speed', icon: '‚ö°', name: 'Speed Demon', desc: 'Avg resolution < 4 hours' },
            { id: 'perfect', icon: 'üéØ', name: 'Perfect Week', desc: '100% completion this week' },
            { id: 'hero', icon: 'üåü', name: 'Customer Hero', desc: '50+ completed this month' },
            { id: 'streak', icon: 'üî•', name: 'Hot Streak', desc: '5+ consecutive completions' },
            { id: 'zero', icon: 'üõ°Ô∏è', name: 'Zero Defects', desc: 'No invalid closures in 30 days' },
            { id: 'workaholic', icon: 'üí™', name: 'Workaholic', desc: 'Highest volume this week' },
            { id: 'rising', icon: 'üìà', name: 'Rising Star', desc: 'Most improved this week' }
        ];

        function calculateAgentBadges(agent, allAgents) {
            const badges = [];

            // Speed Demon: Check average resolution (simulated - based on completion rate)
            if (agent.completionRate >= 80 && agent.comp >= 10) {
                badges.push('speed');
            }

            // Perfect Week: 100% completion rate with at least 5 tickets
            if (agent.completionRate === 100 && agent.total >= 5) {
                badges.push('perfect');
            }

            // Customer Hero: 50+ completed this month
            if (agent.comp >= 50) {
                badges.push('hero');
            }

            // Hot Streak: No pending old tickets and high completion
            if (agent.pendingOld === 0 && agent.comp >= 5 && agent.not <= 2) {
                badges.push('streak');
            }

            // Zero Defects: No invalid closures
            if (agent.invalidClosed === 0 && agent.closed >= 0) {
                badges.push('zero');
            }

            // Workaholic: Highest volume (check against all agents)
            if (allAgents && allAgents.length > 0) {
                const maxTotal = Math.max(...allAgents.map(a => a.total));
                if (agent.total === maxTotal && maxTotal > 0) {
                    badges.push('workaholic');
                }
            }

            // Rising Star: Highest score (already sorted by score)
            if (allAgents && allAgents.indexOf(agent) === 0 && agent.score > 0) {
                badges.push('rising');
            }

            return badges;
        }

        function renderAgentBadges(earnedBadges, size = 'normal') {
            const sizeClass = size === 'small' ? 'leaderboard-badges' : 'badge-container';

            return `<div class="${sizeClass}">
        ${BADGE_DEFINITIONS.map(badge => {
                const isEarned = earnedBadges.includes(badge.id);
                return `<span class="achievement-badge ${isEarned ? 'earned' : 'locked'}" 
                          data-tooltip="${badge.name}: ${badge.desc}">
                ${badge.icon}
            </span>`;
            }).join('')}
    </div>`;
        }

        // ==========================================
        // üìä WEEKLY GOALS PROGRESS TRACKER
        // ==========================================

        let WEEKLY_GOAL = 25; // Default weekly goal

        function updateWeeklyGoal(value) {
            WEEKLY_GOAL = parseInt(value) || 25;
            document.getElementById('weekly-goal-target').textContent = WEEKLY_GOAL;
            renderWeeklyGoals();
            showToast(`Weekly goal updated to ${WEEKLY_GOAL} tickets`, 'success', 2000);
        }

        function getWeeklyTicketsForAgent(agentName) {
            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay()); // Start of week (Sunday)
            weekStart.setHours(0, 0, 0, 0);

            return DATE_DATA.filter(t => {
                const ticketDate = new Date(t.sortDate);
                return t.agent === agentName &&
                    ticketDate >= weekStart &&
                    (t.status.toLowerCase() === 'completed' || t.status.toLowerCase() === 'closed');
            }).length;
        }

        function calculateGoalStatus(completed, goal) {
            const dayOfWeek = new Date().getDay(); // 0 = Sunday
            const daysElapsed = dayOfWeek === 0 ? 7 : dayOfWeek;
            const expectedProgress = (daysElapsed / 7) * goal;

            if (completed >= goal) return 'ahead';
            if (completed >= expectedProgress * 0.9) return 'on-track';
            return 'behind';
        }

        function calculateETA(completed, goal) {
            if (completed >= goal) return 'Goal reached! üéâ';

            const dayOfWeek = new Date().getDay();
            const daysElapsed = dayOfWeek === 0 ? 7 : dayOfWeek;
            const remaining = goal - completed;
            const daysLeft = 7 - daysElapsed;

            if (daysLeft <= 0) return 'Week ended';

            const avgPerDay = completed / daysElapsed;
            if (avgPerDay <= 0) return 'Need to start!';

            const daysNeeded = Math.ceil(remaining / avgPerDay);

            if (daysNeeded <= daysLeft) {
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const etaDay = (new Date().getDay() + daysNeeded) % 7;
                return `On track for ${dayNames[etaDay]}`;
            }
            return `Need ${Math.ceil(remaining / daysLeft)} per day`;
        }

        function renderWeeklyGoals() {
            const container = document.getElementById('goals-grid');
            if (!container) return;

            const agents = getAgentStats();

            container.innerHTML = agents.map(agent => {
                const weeklyCompleted = getWeeklyTicketsForAgent(agent.name);
                const progress = Math.min((weeklyCompleted / WEEKLY_GOAL) * 100, 100);
                const status = calculateGoalStatus(weeklyCompleted, WEEKLY_GOAL);
                const eta = calculateETA(weeklyCompleted, WEEKLY_GOAL);

                return `
        <div class="goal-card">
            <div class="goal-card-header">
                <span class="goal-agent-name">${escapeHtml(agent.name)}</span>
                <span class="goal-status-badge ${status}">${status.replace('-', ' ')}</span>
            </div>
            <div class="goal-progress-bar">
                <div class="goal-progress-fill ${status}" style="width: ${progress}%"></div>
            </div>
            <div class="goal-stats">
                <span><span class="goal-value">${weeklyCompleted}</span> / ${WEEKLY_GOAL} tickets</span>
                <span><span class="goal-value">${Math.round(progress)}%</span> complete</span>
            </div>
            <div class="goal-eta">
                <i class="fas fa-clock"></i> ${eta}
            </div>
        </div>
        `;
            }).join('');
        }

        // ==========================================
        // ‚öîÔ∏è HEAD-TO-HEAD COMPARISON MODAL
        // ==========================================

        let comparisonChart = null;

        function openComparisonModal() {
            const modal = document.getElementById('comparison-modal');
            if (!modal) return;

            // Populate agent dropdowns
            const agents = getAgentStats();
            const select1 = document.getElementById('compare-agent-1');
            const select2 = document.getElementById('compare-agent-2');

            const options = agents.map(a => `<option value="${a.name}">${a.name}</option>`).join('');

            select1.innerHTML = `<option value="">Select Agent 1</option>${options}`;
            select2.innerHTML = `<option value="">Select Agent 2</option>${options}`;

            // Pre-select first two agents if available
            if (agents.length >= 2) {
                select1.value = agents[0].name;
                select2.value = agents[1].name;
                setTimeout(() => updateComparison(), 100);
            }

            modal.classList.add('show');
        }

        function closeComparisonModal() {
            const modal = document.getElementById('comparison-modal');
            if (modal) modal.classList.remove('show');

            if (comparisonChart) {
                comparisonChart.destroy();
                comparisonChart = null;
            }
        }

        function updateComparison() {
            const agent1Name = document.getElementById('compare-agent-1').value;
            const agent2Name = document.getElementById('compare-agent-2').value;
            const container = document.getElementById('comparison-body');

            if (!agent1Name || !agent2Name) {
                container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #64748B;">
                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                <p>Select two agents above to compare their performance</p>
            </div>
        `;
                return;
            }

            if (agent1Name === agent2Name) {
                container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #DC2626;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                <p>Please select two different agents</p>
            </div>
        `;
                return;
            }

            const agents = getAgentStats();
            const agent1 = agents.find(a => a.name === agent1Name);
            const agent2 = agents.find(a => a.name === agent2Name);

            if (!agent1 || !agent2) return;

            // Calculate comparison metrics
            const metrics = [
                { label: 'Total Tickets', key: 'total', higherBetter: true },
                { label: 'Completed', key: 'comp', higherBetter: true },
                { label: 'Points Score', key: 'score', higherBetter: true },
                { label: 'Completion Rate', key: 'completionRate', higherBetter: true, suffix: '%' },
                { label: 'Pending', key: 'not', higherBetter: false },
                { label: 'Invalid Closures', key: 'invalidClosed', higherBetter: false }
            ];

            function getWinClass(val1, val2, higherBetter) {
                if (val1 === val2) return ['', ''];
                if (higherBetter) {
                    return val1 > val2 ? ['winner', 'loser'] : ['loser', 'winner'];
                } else {
                    return val1 < val2 ? ['winner', 'loser'] : ['loser', 'winner'];
                }
            }

            const rank1 = agents.indexOf(agent1) + 1;
            const rank2 = agents.indexOf(agent2) + 1;

            container.innerHTML = `
        <!-- Agent 1 Card -->
        <div class="comparison-agent-card">
            <div class="comparison-agent-header">
                <div class="comparison-agent-name">${escapeHtml(agent1.name)}</div>
                <div class="comparison-agent-rank">Rank #${rank1} ‚Ä¢ ${agent1.score} pts</div>
            </div>
            <div class="comparison-stats-list">
                ${metrics.map(m => {
                const [class1] = getWinClass(agent1[m.key], agent2[m.key], m.higherBetter);
                return `
                    <div class="comparison-stat-row">
                        <span class="comparison-stat-label">${m.label}</span>
                        <span class="comparison-stat-value ${class1}">${agent1[m.key]}${m.suffix || ''}</span>
                    </div>`;
            }).join('')}
            </div>
        </div>
        
        <!-- Agent 2 Card -->
        <div class="comparison-agent-card">
            <div class="comparison-agent-header">
                <div class="comparison-agent-name">${escapeHtml(agent2.name)}</div>
                <div class="comparison-agent-rank">Rank #${rank2} ‚Ä¢ ${agent2.score} pts</div>
            </div>
            <div class="comparison-stats-list">
                ${metrics.map(m => {
                const [, class2] = getWinClass(agent1[m.key], agent2[m.key], m.higherBetter);
                return `
                    <div class="comparison-stat-row">
                        <span class="comparison-stat-label">${m.label}</span>
                        <span class="comparison-stat-value ${class2}">${agent2[m.key]}${m.suffix || ''}</span>
                    </div>`;
            }).join('')}
            </div>
        </div>
        
        <!-- Radar Chart -->
        <div class="comparison-chart-container">
            <div class="comparison-chart-title">üìä Performance Comparison Radar</div>
            <canvas id="comparison-radar-chart"></canvas>
        </div>
    `;

            // Render radar chart
            renderComparisonRadar(agent1, agent2);
        }

        function renderComparisonRadar(agent1, agent2) {
            const ctx = document.getElementById('comparison-radar-chart');
            if (!ctx) return;

            if (comparisonChart) {
                comparisonChart.destroy();
            }

            // Normalize values for radar chart (0-100 scale)
            const maxTotal = Math.max(agent1.total, agent2.total, 1);
            const maxComp = Math.max(agent1.comp, agent2.comp, 1);
            const maxScore = Math.max(Math.abs(agent1.score), Math.abs(agent2.score), 1);

            comparisonChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Tickets', 'Completed', 'Score', 'Rate %', 'Efficiency'],
                    datasets: [
                        {
                            label: agent1.name,
                            data: [
                                (agent1.total / maxTotal) * 100,
                                (agent1.comp / maxComp) * 100,
                                ((agent1.score + 100) / 200) * 100, // Normalize score
                                agent1.completionRate,
                                100 - (agent1.pendingOld * 10) // Efficiency inverse of old pending
                            ],
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            pointBackgroundColor: '#667eea'
                        },
                        {
                            label: agent2.name,
                            data: [
                                (agent2.total / maxTotal) * 100,
                                (agent2.comp / maxComp) * 100,
                                ((agent2.score + 100) / 200) * 100,
                                agent2.completionRate,
                                100 - (agent2.pendingOld * 10)
                            ],
                            backgroundColor: 'rgba(118, 75, 162, 0.2)',
                            borderColor: '#764ba2',
                            borderWidth: 2,
                            pointBackgroundColor: '#764ba2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { display: false },
                            pointLabels: {
                                font: { size: 12, weight: '600' },
                                color: '#475569'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { weight: '600' },
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // Function to update leaderboard with badges
        // ‚úÖ DISABLED: Badges are now rendered inline in renderLeaderboardTable
        //    This was causing duplicate badge rendering
        function updateLeaderboardBadges() {
            // Badges are already rendered in renderLeaderboardTable (lines 6481-6483)
            // This function previously caused duplicate badges to appear
            // Keeping function stub for hook compatibility
            return;
        }

        // ==========================================
        // üîÑ INTEGRATION: Auto-render when team view loads
        // ==========================================

        // Add to window load to ensure all functions are available
        (function initTeamEnhancements() {
            // Wait for DOM and data to be ready
            const checkAndRender = function () {
                if (typeof getAgentStats === 'function') {
                    setTimeout(updateLeaderboardBadges, 300);
                }
            };

            // Hook into existing renderDetailedTeamReport if it exists
            if (typeof window.renderDetailedTeamReport === 'function') {
                const _originalRender = window.renderDetailedTeamReport;
                window.renderDetailedTeamReport = function () {
                    _originalRender.apply(this, arguments);
                    setTimeout(checkAndRender, 100);
                };
            }

            // Also observe view changes
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const teamView = document.getElementById('view-team');
                        if (teamView && !teamView.classList.contains('hidden')) {
                            setTimeout(checkAndRender, 200);
                        }
                    }
                });
            });

            const teamView = document.getElementById('view-team');
            if (teamView) {
                observer.observe(teamView, { attributes: true });
            }
        })();



    </script>

</body>

</html>